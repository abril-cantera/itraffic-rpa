(()=>{"use strict";const e="localhost"===window.location.hostname,t="https://happy-flower-09b6bd81e.4.azurestaticapps.net",n={apiBaseUrl:e?"http://localhost:7071":t,dialogBaseUrl:t,environment:e?"development":"production",version:"1.0.0"};console.log("üìù Add-in Configuration:",{environment:n.environment,apiBaseUrl:n.apiBaseUrl,dialogBaseUrl:n.dialogBaseUrl,version:n.version});const o=new class{constructor(){this.timeout=6e4,this.baseUrl=n.apiBaseUrl,console.log("ü§ñ RPA Service initialized with base URL:",this.baseUrl)}async healthCheck(){console.log("üè• Checking RPA health...");try{const e=await this.fetchWithTimeout(`${this.baseUrl}/health`,{method:"GET",headers:{"Content-Type":"application/json"}},1e4);if(!e.ok)throw new Error(`Health check failed: ${e.status} ${e.statusText}`);const t=await e.json();return console.log("‚úÖ RPA health check successful:",t),t}catch(e){throw console.error("‚ùå RPA health check failed:",e),new Error(`Health check failed: ${e.message}`)}}async getStatus(){console.log("üìä Getting RPA status...");try{const e=await this.fetchWithTimeout(`${this.baseUrl}/api/status`,{method:"GET",headers:{"Content-Type":"application/json"}},1e4);if(!e.ok)throw new Error(`Status check failed: ${e.status} ${e.statusText}`);const t=await e.json();return console.log("‚úÖ RPA status retrieved:",t),t}catch(e){throw console.error("‚ùå RPA status check failed:",e),new Error(`Status check failed: ${e.message}`)}}async createReservation(e){console.log("ü§ñ Creating reservation via RPA..."),console.log("üìã Reservation data:",e);try{const t={reservationData:{passengers:e.passengers.map(e=>({lastName:e.lastName||"",firstName:e.firstName||"",paxType:e.paxType||"ADU",birthDate:this.formatDateForRPA(e.birthDate),nationality:e.nationality||"",sex:e.sex||"M",documentNumber:e.documentNumber||"",documentType:e.documentType||"DNI",cuilCuit:e.cuilCuit||"",direccion:e.direccion||""})),reservationType:e.reservationType||"",status:e.status||"",client:e.client||"",travelDate:this.formatDateForRPA(e.travelDate),seller:e.seller||""}};console.log("üì§ Sending to RPA:",t);const n=await this.fetchWithTimeout(`${this.baseUrl}/api/reservations`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},this.timeout),o=await n.text();let a;console.log("üì• RPA raw response:",o);try{a=o?JSON.parse(o):{success:!1,message:"Empty response",timestamp:(new Date).toISOString()}}catch(e){throw console.error("‚ùå Failed to parse RPA response:",e),new Error(`Invalid response format: ${o.substring(0,100)}`)}if(!n.ok)throw console.error("‚ùå RPA request failed:",n.status,a),new Error(a.message||`RPA request failed: ${n.status}`);if(!a.success)throw console.error("‚ùå RPA operation failed:",a),new Error(a.message||"RPA operation failed");return console.log("‚úÖ Reservation created successfully:",a),a}catch(e){if(console.error("‚ùå Create reservation failed:",e),"AbortError"===e.name)throw new Error("La operaci√≥n tard√≥ demasiado tiempo (timeout de 60s). El RPA puede estar procesando la reserva.");throw new Error(e.message||"Failed to create reservation")}}async testConnection(){console.log("üîå Testing RPA connection...");try{const e=await this.fetchWithTimeout(`${this.baseUrl}/api/test-connection`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({timestamp:(new Date).toISOString(),source:"outlook-addin"})},1e4);if(!e.ok)return{success:!1,message:`Connection test failed: ${e.status} ${e.statusText}`};const t=await e.json();return console.log("‚úÖ Connection test successful:",t),{success:!0,message:"Connection successful",details:t}}catch(e){return console.error("‚ùå Connection test failed:",e),{success:!1,message:`Connection failed: ${e.message}`}}}async fetchWithTimeout(e,t,n){const o=new AbortController,a=setTimeout(()=>o.abort(),n);try{const n=await fetch(e,{...t,signal:o.signal});return clearTimeout(a),n}catch(e){if(clearTimeout(a),"AbortError"===e.name)throw new Error(`Request timeout after ${n}ms`);throw e}}formatDateForRPA(e){if(!e)return"";try{let t=null;if(e.includes("-"))t=new Date(e);else if(e.includes("/")){const n=e.split("/");3===n.length&&(t=parseInt(n[0])>12?new Date(`${n[1]}/${n[0]}/${n[2]}`):new Date(e))}if(!t||isNaN(t.getTime()))return console.warn("‚ö†Ô∏è Invalid date format:",e),e;const n=String(t.getMonth()+1).padStart(2,"0"),o=`${n}/${String(t.getDate()).padStart(2,"0")}/${t.getFullYear()}`;return console.log(`üìÖ Date formatted: ${e} -> ${o}`),o}catch(t){return console.error("‚ùå Error formatting date:",t),e}}},a={isRegistered:!1,userId:null,email:null,isLoading:!1,error:null,isAuthInProgress:!1,authRetryCount:0,lastAuthAttempt:null};let s=null;const r={isExtracting:!1,hasExtracted:!1,data:null,error:null,isEditing:!1},i={sellers:[],clients:[],contacts:[],currencies:[],statuses:[],reservationTypes:[],genders:[],documentTypes:[],countries:[],loaded:!1};function l(e,t){const n=document.getElementById(`${e}-loader`);n&&(t?n.classList.add("active"):n.classList.remove("active"))}function c(){l("seller",!1),l("client",!1),l("contact",!1),l("currency",!1),l("status",!1),l("reservation-type",!1)}function d(){const e=document.getElementById("input-seller"),t=document.getElementById("input-client"),n=document.getElementById("input-contact"),o=document.getElementById("input-currency"),a=document.getElementById("input-status"),s=document.getElementById("input-reservation-type");e&&(e.disabled=!1,e.placeholder="Buscar vendedor..."),t&&(t.disabled=!1,t.placeholder="Buscar cliente..."),n&&(n.disabled=!1,n.placeholder="Buscar contacto..."),o&&(o.disabled=!1,o.placeholder="Buscar moneda..."),a&&(a.disabled=!1,a.placeholder="Buscar estado..."),s&&(s.disabled=!1,s.placeholder="Buscar tipo...")}function u(e,t,n,o){let a=-1,s=[...o],r=0;function i(e="",n=!1){const a=e.toLowerCase().trim();if(s=a?o.filter(e=>e.name.toLowerCase().includes(a)||e.code.toLowerCase().includes(a)):[...o],n||(t.innerHTML="",r=0),0===s.length)return void(t.innerHTML='<div class="dropdown-empty">No se encontraron resultados</div>');const i=r,c=Math.min(i+30,s.length);for(let e=i;e<c;e++){const n=s[e],o=document.createElement("div");o.className="dropdown-item",o.dataset.value=n.name,o.dataset.index=e.toString(),o.textContent=n.name,o.addEventListener("click",()=>l(n)),t.appendChild(o)}r=c;const d=t.querySelector(".dropdown-more");if(d&&d.remove(),r<s.length){const e=document.createElement("div");e.className="dropdown-empty dropdown-more",e.textContent=`Mostrando ${r} de ${s.length}. Scroll para ver m√°s...`,t.appendChild(e)}}function l(o){e.value=o.name,n&&(n.value=o.name),t.classList.remove("active"),a=-1}function c(){i(e.value),t.classList.add("active")}function d(){t.classList.remove("active"),a=-1,n&&e.value&&(n.value=e.value)}function u(){const e=t.querySelectorAll(".dropdown-item");e.forEach((e,t)=>{e.classList.toggle("highlighted",t===a)}),a>=0&&e[a]&&e[a].scrollIntoView({block:"nearest"})}e.addEventListener("focus",()=>c()),e.addEventListener("input",()=>{i(e.value),t.classList.add("active"),a=-1}),t.addEventListener("scroll",()=>{t.scrollTop+t.clientHeight>=t.scrollHeight-50&&r<s.length&&i(e.value,!0)}),e.addEventListener("keydown",e=>{const n=t.querySelectorAll(".dropdown-item");switch(e.key){case"ArrowDown":e.preventDefault(),t.classList.contains("active")||c(),a=Math.min(a+1,n.length-1),u();break;case"ArrowUp":e.preventDefault(),a=Math.max(a-1,0),u();break;case"Enter":e.preventDefault(),a>=0&&s[a]&&l(s[a]);break;case"Escape":case"Tab":d()}}),document.addEventListener("click",n=>{e.contains(n.target)||t.contains(n.target)||d()})}function m(e,t,n,o){let a=-1,s=[...o],r=0;function i(e="",n=!1){const a=e.toLowerCase().trim();if(s=a?o.filter(e=>e.name.toLowerCase().includes(a)||e.code.toLowerCase().includes(a)||e.displayName&&e.displayName.toLowerCase().includes(a)):[...o],n||(t.innerHTML="",r=0),0===s.length)return void(t.innerHTML='<div class="dropdown-empty">No se encontraron resultados</div>');const i=r,c=Math.min(i+30,s.length);for(let e=i;e<c;e++){const n=s[e],o=document.createElement("div");o.className="dropdown-item",o.dataset.value=n.displayName||`${n.code} - ${n.name}`,o.dataset.index=e.toString(),o.textContent=n.displayName||`${n.code} - ${n.name}`,o.addEventListener("click",()=>l(n)),t.appendChild(o)}r=c;const d=t.querySelector(".dropdown-more");if(d&&d.remove(),r<s.length){const e=document.createElement("div");e.className="dropdown-empty dropdown-more",e.textContent=`Mostrando ${r} de ${s.length}. Scroll para ver m√°s...`,t.appendChild(e)}}function l(o){const s=o.displayName||`${o.code} - ${o.name}`;e.value=s,n&&(n.value=s),t.classList.remove("active"),a=-1}function c(){i(e.value),t.classList.add("active")}function d(){t.classList.remove("active"),a=-1,n&&e.value&&(n.value=e.value)}function u(){const e=t.querySelectorAll(".dropdown-item");e.forEach((e,t)=>{e.classList.toggle("highlighted",t===a)}),a>=0&&e[a]&&e[a].scrollIntoView({block:"nearest"})}e.addEventListener("focus",()=>c()),e.addEventListener("input",()=>{i(e.value),t.classList.add("active"),a=-1}),t.addEventListener("scroll",()=>{t.scrollTop+t.clientHeight>=t.scrollHeight-50&&r<s.length&&i(e.value,!0)}),e.addEventListener("keydown",e=>{const n=t.querySelectorAll(".dropdown-item");switch(e.key){case"ArrowDown":e.preventDefault(),t.classList.contains("active")||c(),a=Math.min(a+1,n.length-1),u();break;case"ArrowUp":e.preventDefault(),a=Math.max(a-1,0),u();break;case"Enter":e.preventDefault(),a>=0&&s[a]&&l(s[a]);break;case"Escape":case"Tab":d()}}),document.addEventListener("click",n=>{e.contains(n.target)||t.contains(n.target)||d()})}function g(){const e=document.getElementById("collapsible-header"),t=document.getElementById("toggle-header-btn");"none"===e.style.display?(e.style.display="block",t.textContent="üîº"):(e.style.display="none",t.textContent="üîΩ")}function p(){try{const e=Office.context.mailbox?.userProfile;return e&&e.emailAddress?e.emailAddress.toLowerCase():null}catch(e){return console.error("‚ùå Error getting current user email:",e),null}}async function f(){try{const e=p();console.log("üìß Current Outlook user:",e);const t=localStorage.getItem("email-classifier-userId"),o=localStorage.getItem("email-classifier-email");if(!t||!o)return console.log("‚è≠Ô∏è No cached user found - user must login manually"),document.getElementById("loading").style.display="none",void(document.getElementById("app-content").style.display="block");if(e&&o.toLowerCase()!==e)return console.log("‚ö†Ô∏è Cached email does not match current Outlook email"),console.log("   Cached:",o),console.log("   Current:",e),console.log("   Clearing cache and requiring re-login"),localStorage.removeItem("email-classifier-userId"),localStorage.removeItem("email-classifier-email"),document.getElementById("loading").style.display="none",void(document.getElementById("app-content").style.display="block");console.log("üîç Found cached user:",o,"- verifying with backend...");const s=await fetch(`${n.dialogBaseUrl}/auth/status?userId=${t}`);if(!s.ok)return console.log("‚ö†Ô∏è User verification failed - clearing cache"),localStorage.removeItem("email-classifier-userId"),localStorage.removeItem("email-classifier-email"),document.getElementById("loading").style.display="none",void(document.getElementById("app-content").style.display="block");const r=await s.json();r.isRegistered&&r.user?(console.log("‚úÖ User verified - updating UI"),a.isRegistered=!0,a.userId=r.user.userId,a.email=r.user.email,document.getElementById("loading").style.display="none",document.getElementById("app-content").style.display="block",w(r.user)):(console.log("‚ö†Ô∏è User not found in backend - clearing cache"),localStorage.removeItem("email-classifier-userId"),localStorage.removeItem("email-classifier-email"),document.getElementById("loading").style.display="none",document.getElementById("app-content").style.display="block")}catch(e){console.error("‚ùå Error checking registration status:",e),document.getElementById("loading").style.display="none",document.getElementById("app-content").style.display="block"}}async function y(){if(a.isAuthInProgress)return console.log("‚ö†Ô∏è Authentication already in progress, ignoring request"),void b("Authentication is already in progress. Please wait.");const e=Date.now();if(a.lastAuthAttempt&&e-a.lastAuthAttempt<2e3)return console.log("‚ö†Ô∏è Too many authentication attempts, please wait"),void b("Please wait a moment before trying again.");a.error=null,document.getElementById("error-section").style.display="none",A(!0),a.isAuthInProgress=!0,a.lastAuthAttempt=e;try{console.log("üîê Starting SSO authentication... [VERSION 2024-12-02-DIALOG-PREFERRED]");const e=p();if(!e)throw new Error("No se pudo obtener el email de Outlook. Por favor, aseg√∫rate de que Outlook est√© completamente cargado.");return console.log("üìß Current Outlook email:",e),console.log("‚ö†Ô∏è Skipping SSO, using dialog authentication (more reliable)..."),void await async function(e={}){try{if(console.log("ü™ü Using dialog-based authentication fallback"),e.forceConsent&&console.log("üôè Forcing consent screen for offline_access permission"),a.authRetryCount>3)throw new Error("Too many authentication attempts. Please refresh the page and try again.");const t=await E(e);if(!t)throw new Error("Failed to obtain authorization via dialog");console.log("‚úÖ Dialog returned payload:",{status:t.status,hasCode:!!t.authorizationCode,hasToken:!!t.token}),a.authRetryCount=0;const o=p();if(t.authorizationCode)return void await async function(e,t){console.log("üì° Redeeming authorization code via backend (confidential client)..."),console.log("‚ÑπÔ∏è Backend will use client_secret to get access_token + refresh_token");const o=await fetch(`${n.dialogBaseUrl}/auth/redeem-code`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e.authorizationCode,redirectUri:e.redirectUri})});if(!o.ok){const t=await o.json().catch(e=>({data:e}));if(console.error("‚ùå Authorization code redemption failed:",t),403===o.status&&t.requiresInteractiveAuth)throw console.error("‚ùå Consent required but cannot reopen dialog programmatically (Error 12011)"),new Error('Se requiere consentimiento adicional. Por favor, haz clic en "Retry" para autorizar nuevamente. Si el problema persiste, contacta a tu administrador de TI.');throw new Error(`No se pudo completar la autenticaci√≥n: ${JSON.stringify(o.json())}, ${JSON.stringify(e)}`)}const s=await o.json();if(console.log("‚úÖ Backend redeemed authorization code successfully:",s),!s.user?.id||!s.user?.email)throw new Error("La respuesta del servidor no incluye la informaci√≥n del usuario.");const r=s.user.email.toLowerCase();if(t&&r!==t)throw console.error("‚ùå Email mismatch detected after redemption"),new Error(`El usuario autenticado (${r}) no coincide con tu cuenta de Outlook (${t}).`);await h(s.user.id,s.user.email),a.isRegistered=!0,a.userId=s.user.id,a.email=s.user.email,w({email:s.user.email,id:s.user.id,stats:s.user.stats});let i="üéâ Autenticaci√≥n completa!";s.hasRefreshToken?i+=" Tus correos se clasificar√°n autom√°ticamente con acceso permanente.":(console.warn("‚ö†Ô∏è No refresh token received - user will need to re-authenticate periodically"),i+=" Tus correos se clasificar√°n autom√°ticamente. Nota: Deber√°s volver a autenticarte despu√©s de 1 hora."),S(i)}(t,o);if(t.token)return console.warn("‚ö†Ô∏è Received legacy token payload from dialog. Proceeding with deprecated flow."),void await async function(e,t){if(!e.email||!e.userId)throw new Error("Invalid legacy authentication response");if(t&&e.email.toLowerCase()!==t)throw new Error(`Por favor, inicia sesi√≥n con la misma cuenta de Outlook (${t}). Intentaste autenticarte con: ${e.email}`);const o=await fetch(`${n.dialogBaseUrl}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessToken:e.token,refreshToken:e.refreshToken,userId:e.userId,email:e.email,name:e.name,expiresOn:e.expiresOn})});if(!o.ok){const e=await o.json().catch(()=>({error:"Unknown error"}));throw new Error(`Registration failed: ${JSON.stringify(e)}`)}await h(e.userId,e.email),a.isRegistered=!0,a.userId=e.userId,a.email=e.email,w({email:e.email,id:e.userId}),S("üéâ Autenticaci√≥n completa (modo legacy). Considera actualizar la versi√≥n del complemento.")}(t,o);throw new Error("Invalid authentication response from dialog")}catch(e){throw console.error("‚ùå Dialog registration error:",e),e}}({forceConsent:!0})}catch(e){console.error("‚ùå Registration error:",e),a.authRetryCount++,function(e){let t="Registration failed. ";e.message.includes("offline_access")?t+="The app needs permission to work in the background. Please contact your administrator.":e.message.includes("consent")?t+="You must grant permissions to use this add-in.":e.message.includes("administrator")?t+="This add-in requires administrator approval.":e.message.includes("network")||e.message.includes("fetch")?t+="Network error. Please check your internet connection.":t+=e.message||"Please try again or contact support.",b(t)}(e)}finally{A(!1),a.isAuthInProgress=!1}}async function h(e,t){localStorage.setItem("email-classifier-userId",e),localStorage.setItem("email-classifier-email",t);const n=Office.context.roamingSettings;return n.set("email-classifier-userId",e),n.set("email-classifier-email",t),new Promise(e=>{n.saveAsync(t=>{t.status===Office.AsyncResultStatus.Succeeded?console.log("üíæ User credentials saved to localStorage and roamingSettings"):console.error("‚ö†Ô∏è Failed to save roamingSettings:",t.error),e()})})}async function v(){try{console.log("üö™ Logging out user..."),localStorage.removeItem("email-classifier-userId"),localStorage.removeItem("email-classifier-email");const e=Office.context.roamingSettings;e.remove("email-classifier-userId"),e.remove("email-classifier-email"),e.saveAsync(),console.log("‚úÖ Cleared localStorage and roamingSettings"),a.isRegistered=!1,a.userId=null,a.email=null;const t=document.getElementById("status-indicator");t.className="status-box unregistered",t.innerHTML='\n      <div class="status-icon">‚è∏Ô∏è</div>\n      <div class="status-text">\n        <h3>Not Registered</h3>\n        <p>Click below to activate automatic email classification</p>\n      </div>\n    ',document.getElementById("registration-section").style.display="block",document.getElementById("logout-section").style.display="none",document.getElementById("stats-section").style.display="none",console.log("‚úÖ Logged out from add-in"),console.log("üîì Clearing Microsoft session...");const n=`https://login.microsoftonline.com/common/oauth2/v2.0/logout?post_logout_redirect_uri=${encodeURIComponent(window.location.origin)}`;Office.context.ui.displayDialogAsync(n,{height:20,width:20,promptBeforeOpen:!1},e=>{if(e.status===Office.AsyncResultStatus.Succeeded){const t=e.value;setTimeout(()=>{t.close(),console.log("‚úÖ Microsoft session cleared"),S("üëã Signed out completely. Next login will require re-authentication.")},2e3)}else console.log("‚ö†Ô∏è Could not open logout dialog, but local logout succeeded"),S("üëã Signed out successfully. Sign in again to re-activate auto-classification.")})}catch(e){console.error("‚ùå Logout error:",e),b("Failed to sign out. Please try again.")}}async function E(e={}){return function(){if(s){try{console.log("Closing existing dialog..."),s.close()}catch(e){console.log("Dialog already closed or invalid")}s=null}}(),new Promise((t,o)=>{const a=new URLSearchParams;e.forceConsent&&a.set("forceConsent","true");const r=a.toString(),i=r?`${n.dialogBaseUrl}/login.html?${r}`:`${n.dialogBaseUrl}/login.html`;console.log("Opening authentication dialog:",i),Office.context.ui.displayDialogAsync(i,{height:60,width:30,promptBeforeOpen:!1,displayInIframe:!1},e=>{if(e.status===Office.AsyncResultStatus.Failed)return console.error("Failed to open dialog:",e.error),e.error&&12007===e.error.code?(console.log("Dialog already active, clearing reference and retrying..."),s=null,void setTimeout(()=>{o(new Error("Ya hay un dialogo de autenticacion abierto. Cierra la ventana anterior y vuelve a intentar."))},500)):e.error&&12011===e.error.code?void o(new Error("No pudimos abrir la ventana del consentimiento porque el explorador considera diferente la zona de seguridad. Abre Outlook en Edge/Chrome actualizado o agrega https://app-itraffic-rpa.whiteflower-4df565a8.eastus2.azurecontainerapps.io a los sitios de confianza.")):void o(new Error(`Failed to open authentication dialog: ${e.error.message||e.error.code}`));const a=e.value;s=a;let r=!1;const i=()=>{try{const e=localStorage.getItem("office_auth_pending");if(e){const t=JSON.parse(e);if(t.timestamp&&Date.now()-t.timestamp<3e5)return console.log("Found auth code in localStorage (fallback)"),localStorage.removeItem("office_auth_pending"),t;localStorage.removeItem("office_auth_pending")}}catch(e){console.error("Error checking localStorage:",e)}return null},l=async()=>{try{const e=await fetch(`${n.dialogBaseUrl}/auth/bridge?email=pending`);if(e.ok){const t=await e.json();if(t.success&&t.code)return console.log("üì¶ Found auth code in server bridge"),{status:"code",authorizationCode:t.code,redirectUri:t.redirectUri,state:t.state}}}catch(e){}return null},c=setInterval(async()=>{if(r)return void clearInterval(c);let e=i();if(e||(e=await l()),e&&"code"===e.status&&e.authorizationCode){console.log("Retrieved auth code from fallback mechanism"),clearInterval(c),clearTimeout(d),r=!0,s=null;try{a.close()}catch(e){}t(e)}},2e3),d=setTimeout(async()=>{if(!r){let e=i();if(e||(e=await l()),e&&"code"===e.status&&e.authorizationCode){console.log("Retrieved auth code from fallback on timeout"),clearInterval(c),r=!0,s=null;try{a.close()}catch(e){}return void t(e)}console.error("Dialog timeout - no response received"),clearInterval(c),r=!0,s=null,a.close(),o(new Error("Authentication timeout. Please try again."))}},12e4);a.addEventHandler(Office.EventType.DialogMessageReceived,e=>{if(!r){clearTimeout(d),clearInterval(c),r=!0,s=null,a.close();try{const n=JSON.parse(e.message);if(console.log("Received message from dialog:",{status:n.status,hasCode:!!n.authorizationCode,hasToken:!!n.token}),"code"===n.status&&n.authorizationCode)return void t(n);if("success"===n.status&&n.token)return void t(n);o(new Error(n.error||"Authentication failed"))}catch(e){console.error("‚ùå Error parsing dialog message:",e),o(new Error("Invalid response from authentication dialog"))}}}),a.addEventHandler(Office.EventType.DialogEventReceived,async e=>{if(r)return;clearTimeout(d),clearInterval(c),console.log("Dialog event received:",e);let n=i();if(n||(n=await l()),n&&"code"===n.status&&n.authorizationCode)return console.log("Retrieved auth code from fallback after dialog event"),r=!0,s=null,void t(n);r=!0,s=null,12006===e.error?setTimeout(async()=>{let e=i();e||(e=await l()),e&&"code"===e.status&&e.authorizationCode?(console.log("‚úÖ Retrieved auth code from fallback after dialog close delay"),t(e)):o(new Error("Authentication cancelled by user"))},1500):12002===e.error?o(new Error("Dialog navigation failed. Please check your internet connection.")):o(new Error(`Authentication dialog error: ${e.error||"Unknown error"}`))})})})}function w(e){console.log("üé® updateUIForRegisteredUser called with data:",e);const t=document.getElementById("status-indicator");t.className="status-box registered",t.innerHTML=`\n    <div class="status-icon">‚úÖ</div>\n    <div class="status-text">\n      <h3>Active</h3>\n      <p>Auto-classification enabled for ${e.email||"your account"}</p>\n    </div>\n  `,document.getElementById("registration-section").style.display="none",document.getElementById("logout-section").style.display="block",document.getElementById("stats-section").style.display="block";const n=document.getElementById("extraction-section");n.style.display="block",console.log("‚úÖ Extraction section displayed:",n.style.display),e.stats&&(document.getElementById("total-classified").textContent=e.stats.totalClassified||"0",document.getElementById("categories-count").textContent=e.stats.categoriesCount||"0")}function I(e,t){const n=document.getElementById(e);if(!n)return;const o=t||"",a=e=>e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase().trim();if("INPUT"===n.tagName&&o){const t={"input-seller":i.sellers,"input-client":i.clients,"input-currency":i.currencies,"input-status":i.statuses,"input-reservation-type":i.reservationTypes}[e];if(t&&t.length>0){const s=a(o);let r;if(r=t.find(e=>a(e.code)===s),r||(r=t.find(e=>a(e.name)===s)),!(r||"input-status"!==e&&"input-reservation-type"!==e||(r=t.find(e=>{const t=e.name.match(/\[([^\]]+)\]$/);return!!t&&a(t[1])===s}),r||(r=t.find(e=>{const t=e.name.replace(/\s*\[[^\]]+\]$/,"");return a(t)===s})),r))){const e=t.filter(e=>{const t=e.name.replace(/\s*\[[^\]]+\]$/,""),n=a(t);return n.includes(s)||s.includes(n)});e.length>0&&(e.sort((e,t)=>{const n=e.name.replace(/\s*\[[^\]]+\]$/,""),o=t.name.replace(/\s*\[[^\]]+\]$/,""),r=s.includes(a(n)),i=s.includes(a(o));return r&&!i?-1:!r&&i?1:o.length-n.length}),r=e[0])}if(r||"input-status"===e||"input-reservation-type"===e||(r=t.find(e=>a(e.name).includes(s)||s.includes(a(e.name))||a(e.code).includes(s))),r||"input-seller"!==e||(r=t.find(e=>a(e.name).split(" ").some(e=>e===s||s.includes(e)))),r||"input-client"!==e||(r=t.find(e=>e.name.split(" - ").some(e=>a(e).includes(s)||s.includes(a(e))))),!r&&"input-currency"===e){const e={DOLARES:["USD","DOLAR","US$","U$S","DOLLAR","DOLLARS","D√ìLARES"],PESOS:["ARS","PESO","AR$","PESOS ARGENTINOS"],EUROS:["EUR","EURO","‚Ç¨","EUROS"],REALES:["BRL","REAL","R$","REAIS"]};for(const[n,i]of Object.entries(e))if(i.some(e=>a(e)===s)&&(r=t.find(e=>a(e.name).includes(n)),r)){console.log(`üí± Currency alias found: "${o}" -> "${r.name}"`);break}}if(r){n.value=r.name;const t=document.getElementById(`${e}-value`);return t&&(t.value=r.name),n.classList.remove("missing-field"),void console.log(`‚úÖ Field ${e}: matched "${o}" -> "${r.name}"`)}console.warn(`‚ö†Ô∏è Field ${e}: no match found for "${o}" in ${t.length} items`)}}if("SELECT"===n.tagName&&o){const e=n;let t=!1;for(let n=0;n<e.options.length;n++)if(e.options[n].value===o){t=!0;break}if(!t){const t=document.createElement("option");t.value=o,t.text=`${o} (Detectado)`,e.add(t)}}n.value=o,o?n.classList.remove("missing-field"):(n.classList.add("missing-field"),"INPUT"===n.tagName&&(n.placeholder="Requerido - Completar"),n.disabled=!1)}function b(e){a.error=e;const t=document.getElementById("error-section");document.getElementById("error-message").textContent=e,t.style.display="flex"}function S(e){console.log("‚úÖ",e);const t=document.getElementById("status-indicator");t.innerHTML,t.innerHTML=`\n    <div class="status-icon">‚úÖ</div>\n    <div class="status-text">\n      <h3>Success!</h3>\n      <p>${e}</p>\n    </div>\n  `,t.style.background="#dff6dd",t.style.borderColor="#107c10",setTimeout(()=>{t.style.background="",t.style.borderColor=""},3e3)}function A(e){a.isLoading=e;const t=document.getElementById("register-button");t&&(t.disabled=e,t.innerHTML=e?'<span class="button-icon">‚è≥</span><span>Registering...</span>':'<span class="button-icon">‚ú®</span><span>Activate Auto-Classification</span>')}function C(e){e.preventDefault(),Office.context.ui.displayDialogAsync(`${window.location.origin}/help.html`,{height:60,width:40},e=>{e.status===Office.AsyncResultStatus.Failed&&console.error("Failed to open help dialog:",e.error)})}async function T(){if(console.log("üîç handleExtractReservation called"),console.log("   State:",{userId:a.userId,isRegistered:a.isRegistered,email:a.email}),console.log("   Extraction visible:",document.getElementById("extraction-section").style.display),r.isExtracting)console.log("‚ö†Ô∏è Extraction already in progress");else{if(!a.userId){const e=localStorage.getItem("email-classifier-userId"),t=localStorage.getItem("email-classifier-email");if(!e||!t)return console.error("‚ùå No userId in state or localStorage!"),void b("Please register first to use extraction feature");console.log("‚ôªÔ∏è Restored userId from localStorage"),a.userId=e,a.email=t,a.isRegistered=!0}document.getElementById("extraction-error").style.display="none",document.getElementById("extraction-loading").style.display="block",document.getElementById("extraction-results").style.display="none",r.isExtracting=!0,r.error=null;try{console.log("üìß Getting email content...");const e=await async function(){return new Promise((e,t)=>{const n=Office.context.mailbox.item;n?(console.log("üìß Getting email body (includes forwarded emails in body)..."),n.body.getAsync(Office.CoercionType.Text,o=>{if(o.status===Office.AsyncResultStatus.Succeeded){const t=o.value||"",a=n.subject||"",s=`Asunto: ${a}\nDe: ${n.from?.displayName||n.from?.emailAddress||""}\n\n${t}`;console.log(`‚úÖ Email content obtained: ${s.length} characters`),console.log(`   Subject: ${a.substring(0,50)}...`),console.log(`   Body preview: ${t.substring(0,100)}...`),e(s)}else console.error("‚ùå Failed to get email body:",o.error),t(new Error("No se pudo obtener el contenido del email"))})):t(new Error("No email item selected"))})}();if(!e||e.length<50)throw new Error("El contenido del email es demasiado corto o no se pudo obtener");console.log(`‚úÖ Email content obtained: ${e.length} characters`),console.log("üöÄ Sending to extraction API...");const t=await fetch(`${n.apiBaseUrl}/api/extract-reservation`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:a.userId,emailContent:e,conversationId:Office.context.mailbox.item?.conversationId||null})});if(!t.ok){const e=await t.json().catch(()=>({success:!1,error:"Request failed",details:`HTTP ${t.status}: ${t.statusText}`}));throw new Error(e.details||e.error||"Extraction failed")}const o=await t.json();r.hasExtracted=!0,r.data=o.data,r.error=null,function(e){console.log("üìä Displaying extraction results...");const t=document.getElementById("collapsible-header"),n=document.getElementById("toggle-header-btn");t&&n&&(t.style.display="none",n.textContent="üîΩ"),document.getElementById("extraction-results").style.display="block";const o=document.getElementById("confidence-badge"),a=document.getElementById("confidence-text"),s=Math.round(100*(e.confidence||0));a.textContent=`Confianza: ${s}%`,o.className="confidence-badge",s>=80||(s>=60?o.classList.add("medium"):o.classList.add("low")),k(e.passengers||[]);const r=e.passengers||[],i=(r.filter(e=>"ADU"===e.paxType).length,r.filter(e=>"CHD"===e.paxType).length,r.filter(e=>"INF"===e.paxType).length,(new Date).toISOString().split("T")[0]),l=e.travelDate||e.checkIn||i;I("input-reservation-type",e.reservationType||"COMA"),I("input-status",e.status||"PC"),document.getElementById("input-travel-date").value=l,I("input-seller",e.seller),I("input-client",e.client),console.log("‚úÖ Results displayed")}(o.data),document.getElementById("extraction-loading").style.display="none"}catch(e){console.error("‚ùå Extraction error:",e),r.error=e.message||"Unknown error occurred",document.getElementById("extraction-loading").style.display="none";const t=document.getElementById("extraction-error");document.getElementById("extraction-error-message").textContent=e.message||"No se pudo extraer la informaci√≥n. Por favor, intenta nuevamente.",t.style.display="flex"}finally{r.isExtracting=!1}}}function k(e){const t=document.getElementById("passengers-list");document.getElementById("passengers-count").textContent=e.length.toString(),t.innerHTML="",0===e.length&&e.push({});const n=i.genders.length>0?i.genders.map(e=>`<option value="${e.code}">${e.name}</option>`).join(""):'<option value="M">MASCULINO [M]</option><option value="F">FEMENINO [F]</option>',o=i.documentTypes.length>0?i.documentTypes.map(e=>`<option value="${e.code}">${e.name}</option>`).join(""):'<option value="PAS">PASAPORTE [PAS]</option><option value="DNI">DOCUMENTO NACIONAL DE IDENTIDAD [DNI]</option>',a=i.countries.length>0?i.countries.map(e=>`<option value="${e.name}">${e.name}</option>`).join(""):'<option value="ARGENTINA">ARGENTINA</option>\n  ¬† ¬† ¬†<option value="BRASIL">BRASIL</option>\n  ¬† ¬† ¬†<option value="ESTADOS UNIDOS">ESTADOS UNIDOS</option>';if(e.forEach((e,s)=>{const r=document.createElement("div");r.className="passenger-card",r.setAttribute("data-index",s.toString());const i=e.sex||"",l=e.documentType||"",c=e.nationality||"";r.innerHTML=`\n      <div class="passenger-card-header">\n        <h4>Pasajero ${s+1}</h4>\n        <button class="icon-button remove-passenger" data-index="${s}" title="Eliminar">üóëÔ∏è</button>\n      </div>\n      <div class="form-grid">\n        <div class="form-group">\n          <label>Nombre</label>\n          <input type="text" class="passenger-input" data-field="firstName" value="${e.firstName||""}" placeholder="Nombre">\n        </div>\n        <div class="form-group">\n          <label>Apellido</label>\n          <input type="text" class="passenger-input" data-field="lastName" value="${e.lastName||""}" placeholder="Apellido">\n        </div>\n        <div class="form-group">\n          <label>Tipo Pax</label>\n          <select class="passenger-input" data-field="paxType">\n            <option value="ADU" ${"ADU"===e.paxType?"selected":""}>Adulto</option>\n            <option value="CHD" ${"CHD"===e.paxType?"selected":""}>Ni√±o</option>\n            <option value="INF" ${"INF"===e.paxType?"selected":""}>Infante</option>\n          </select>\n        </div>\n        <div class="form-group">\n          <label>Sexo</label>\n          <select class="passenger-input passenger-sex" data-field="sex" data-current="${i}">\n            <option value="">Seleccionar...</option>\n            ${n}\n          </select>\n        </div>\n        <div class="form-group">\n          <label>Fecha Nacimiento</label>\n          <input type="date" class="passenger-input" data-field="birthDate" value="${e.birthDate||""}">\n        </div>\n        <div class="form-group">\n          <label>Tipo Doc.</label>\n          <select class="passenger-input passenger-doctype" data-field="documentType" data-current="${l}">\n            <option value="">Seleccionar...</option>\n            ${o}\n          </select>\n        </div>\n        <div class="form-group">\n          <label>Nro. Doc.</label>\n          <input type="text" class="passenger-input" data-field="documentNumber" value="${e.documentNumber||""}" placeholder="N√∫mero">\n        </div>\n        <div class="form-group">\n          <label>CUIT-CUIL</label>\n          <input type="text" class="passenger-input" data-field="cuilCuit" value="${e.cuilCuit||""}" placeholder="11111111">\n        </div>\n        <div class="form-group full-width">\n          <label>Direcci√≥n</label>\n          <input type="text" class="passenger-input" data-field="direccion" value="${e.direccion||""}" placeholder="Direcci√≥n completa">\n        </div>\n        <div class="form-group">\n          <label>Nacionalidad</label>\n          <select class="passenger-input passenger-nationality" data-field="nationality" data-current="${c}">\n            <option value="">Seleccionar...</option>\n            ${a}\n          </select>\n        </div>\n        \x3c!-- <div class="form-group">\n          <label>Tel√©fono</label>\n          <input type="text" class="passenger-input" data-field="phoneNumber" value="${e.phoneNumber||""}" placeholder="+54...">\n        </div> --\x3e\n      </div>\n    `,t.appendChild(r)}),document.querySelectorAll(".passenger-sex").forEach(e=>{const t=e.getAttribute("data-current");t&&(e.value=t)}),document.querySelectorAll(".passenger-doctype").forEach(e=>{const t=e.getAttribute("data-current");t&&(e.value=t)}),document.querySelectorAll(".passenger-nationality").forEach(e=>{const t=e.getAttribute("data-current");t&&(e.value=t)}),!document.getElementById("add-passenger-btn")){const e=document.createElement("button");e.id="add-passenger-btn",e.className="secondary-button small-button",e.innerHTML="‚ûï Agregar Pasajero",e.onclick=()=>{const e=L();e.push({paxType:"ADU"}),k(e)},t.parentNode?.appendChild(e)}document.querySelectorAll(".remove-passenger").forEach(e=>{e.addEventListener("click",e=>{const t=parseInt(e.target.getAttribute("data-index")||"0"),n=L();n.splice(t,1),k(n)})})}function L(){const e=[];return document.querySelectorAll(".passenger-card").forEach(t=>{const n={};t.querySelectorAll(".passenger-input").forEach(e=>{n[e.getAttribute("data-field")]=e.value}),e.push(n)}),e}async function $(){console.log("üîÑ Re-analyzing email..."),await T()}async function B(){if(console.log("‚úÖ Confirming reservation data..."),!r.data)return void b("No hay datos para confirmar");if(!a.userId){const e=localStorage.getItem("email-classifier-userId"),t=localStorage.getItem("email-classifier-email");if(!e||!t)return void b("Usuario no autenticado");console.log("‚ôªÔ∏è Restored userId from localStorage for confirmation"),a.userId=e,a.email=t,a.isRegistered=!0}const e=(e,t)=>{if(t){const e=document.getElementById(t);if(e&&e.value)return e.value}const n=document.getElementById(e);return n?.value||null},t=(e,t,n)=>{if(!e||!t||0===t.length)return e;const o=e.toUpperCase().trim();if(o.includes("[")&&o.includes("]"))return e;let a=t.find(e=>e.code.toUpperCase()===o);return a||(a=t.find(e=>e.name.toUpperCase()===o)),a||(a=t.find(e=>{const t=e.name.match(/\[([^\]]+)\]$/);return t&&t[1].toUpperCase()===o})),a||(a=t.find(e=>e.name.toUpperCase().includes(o)||e.code.toUpperCase().includes(o))),a?(console.log(`‚úÖ Normalized ${n}: "${e}" -> "${a.name}"`),a.name):(console.warn(`‚ö†Ô∏è Could not normalize ${n}: "${e}"`),e)},n={reservationType:t(e("input-reservation-type","input-reservation-type-value"),i.reservationTypes,"reservationType"),status:t(e("input-status","input-status-value"),i.statuses,"status"),client:t(e("input-client","input-client-value"),i.clients,"client"),travelDate:document.getElementById("input-travel-date").value||null,seller:t(e("input-seller","input-seller-value"),i.sellers,"seller"),passengers:L()};console.log("üìã Confirmed data:",n);const s=document.getElementById("confirm-button"),l=s.innerHTML;s.innerHTML='<span class="button-icon">ü§ñ</span><span>Procesando RPA...</span>',s.disabled=!0;try{console.log("üöÄ Calling RPA service to create reservation...");const e=await o.createReservation(n);console.log("‚úÖ RPA Result:",e),s.innerHTML='<span class="button-icon">‚úÖ</span><span>¬°Procesado!</span>',s.style.background="#107c10",S(`‚úÖ Reserva creada exitosamente en iTraffic: ${e.message}`),setTimeout(()=>{document.getElementById("extraction-results").style.display="none";const e=document.getElementById("collapsible-header"),t=document.getElementById("toggle-header-btn");e&&t&&(e.style.display="block",t.textContent="üîº"),r.data=null,r.hasExtracted=!1},2e3),setTimeout(()=>{s.innerHTML=l,s.disabled=!1,s.style.background=""},5e3)}catch(e){console.error("‚ùå Error creating reservation via RPA:",e),s.innerHTML=l,s.disabled=!1;let t="Error al crear la reserva en iTraffic";e.message&&(t+=": "+e.message),b(t)}}Office.onReady(e=>{e.host===Office.HostType.Outlook&&(console.log("üìß Email Classifier Add-in loaded"),console.log("üîÑ VERSION: 2024-11-06-15:15 - SSO DISABLED - DIALOG ONLY"),console.log("üöÄ Build timestamp:",(new Date).toISOString()),async function(){document.getElementById("register-button").addEventListener("click",y),document.getElementById("retry-button").addEventListener("click",y),document.getElementById("logout-button").addEventListener("click",v),document.getElementById("help-link").addEventListener("click",C),document.getElementById("extract-button").addEventListener("click",T),document.getElementById("reanalyze-button").addEventListener("click",$),document.getElementById("confirm-button").addEventListener("click",B),document.getElementById("retry-extraction-button").addEventListener("click",T),document.getElementById("toggle-header-btn").addEventListener("click",g),async function(){console.log("üìã Loading master data..."),l("seller",!0),l("client",!0),l("contact",!0),l("currency",!0),l("status",!0),l("reservation-type",!0);try{const e=await fetch(`${n.apiBaseUrl}/api/master-data`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)return console.warn("‚ö†Ô∏è Could not load master data, using defaults"),c(),void d();const t=await e.json();t.success&&t.data&&(i.sellers=t.data.sellers||[],i.clients=t.data.clients||[],i.contacts=t.data.contacts||[],i.currencies=t.data.currencies||[],i.statuses=t.data.statuses||[],i.reservationTypes=t.data.reservationTypes||[],i.genders=t.data.genders||[],i.documentTypes=t.data.documentTypes||[],i.countries=t.data.countries||[],i.loaded=!0,console.log("‚úÖ Master data loaded:",{sellers:i.sellers.length,clients:i.clients.length,contacts:i.contacts.length,currencies:i.currencies.length,statuses:i.statuses.length,reservationTypes:i.reservationTypes.length,genders:i.genders.length,documentTypes:i.documentTypes.length,countries:i.countries.length}),function(){const e=document.getElementById("input-seller"),t=document.getElementById("seller-dropdown"),n=document.getElementById("input-seller-value");e&&t&&(e.disabled=!1,e.placeholder="Buscar vendedor...",l("seller",!1),function(e,t,n,o,a){let s=-1,r=[...o];function i(e=""){const n=e.toLowerCase();if(r=o.filter(e=>e.name.toLowerCase().includes(n)||e.code.toLowerCase().includes(n)),t.innerHTML="",0!==r.length){if(r.slice(0,50).forEach((e,n)=>{const o=document.createElement("div");o.className="dropdown-item",o.dataset.value=e[a],o.dataset.index=n.toString(),o.textContent=e.name,o.addEventListener("click",()=>{l(e)}),t.appendChild(o)}),r.length>50){const e=document.createElement("div");e.className="dropdown-empty",e.textContent=`... y ${r.length-50} m√°s. Escribe para filtrar.`,t.appendChild(e)}}else t.innerHTML='<div class="dropdown-empty">No se encontraron resultados</div>'}function l(o){e.value=o.name,n&&(n.value=o[a]),t.classList.remove("active"),s=-1}function c(){i(e.value),t.classList.add("active")}function d(){t.classList.remove("active"),s=-1}function u(){const e=t.querySelectorAll(".dropdown-item");e.forEach((e,t)=>{e.classList.toggle("highlighted",t===s)}),s>=0&&e[s]&&e[s].scrollIntoView({block:"nearest"})}e.addEventListener("focus",()=>{c()}),e.addEventListener("input",()=>{i(e.value),t.classList.add("active"),s=-1}),e.addEventListener("keydown",e=>{const n=t.querySelectorAll(".dropdown-item");switch(e.key){case"ArrowDown":e.preventDefault(),t.classList.contains("active")||c(),s=Math.min(s+1,n.length-1),u();break;case"ArrowUp":e.preventDefault(),s=Math.max(s-1,0),u();break;case"Enter":e.preventDefault(),s>=0&&r[s]&&l(r[s]);break;case"Escape":case"Tab":d()}}),document.addEventListener("click",n=>{e.contains(n.target)||t.contains(n.target)||d()})}(e,t,n,i.sellers,"name"),console.log(`üìã Seller searchable dropdown ready with ${i.sellers.length} options`))}(),function(){const e=document.getElementById("input-client"),t=document.getElementById("client-dropdown"),n=document.getElementById("input-client-value");e&&t&&(e.disabled=!1,e.placeholder="Buscar cliente...",l("client",!1),m(e,t,n,i.clients),console.log(`üìã Client searchable dropdown ready with ${i.clients.length} options (lazy loading)`))}(),function(){const e=document.getElementById("input-contact"),t=document.getElementById("contact-dropdown"),n=document.getElementById("input-contact-value");e&&t&&(e.disabled=!1,e.placeholder="Buscar contacto...",l("contact",!1),m(e,t,n,i.contacts),e.value="",n&&(n.value=""),console.log(`üìã Contact searchable dropdown ready with ${i.contacts.length} options (lazy loading)`))}(),function(){const e=document.getElementById("input-currency"),t=document.getElementById("currency-dropdown"),n=document.getElementById("input-currency-value");if(!e||!t)return;e.disabled=!1,e.placeholder="Buscar moneda...",l("currency",!1);!function(e,t,n,o,a){let s=-1,r=[...o];const i={};for(const[e,t]of Object.entries(a))for(const n of t)i[n.toUpperCase()]=e.toUpperCase();function l(e=""){const n=e.toLowerCase().trim(),s=e.toUpperCase().trim(),l=i[s]||n;if(r=n?o.filter(e=>{const t=e.name.toLowerCase().includes(n)||e.name.toLowerCase().includes(l.toLowerCase()),o=e.code.toLowerCase().includes(n),s=(a[e.name.toUpperCase()]||[]).some(e=>e.toLowerCase().includes(n));return t||o||s}):[...o],t.innerHTML="",0!==r.length){if(r.slice(0,50).forEach((e,n)=>{const o=document.createElement("div");o.className="dropdown-item",o.dataset.value=e.name,o.dataset.index=n.toString(),o.textContent=e.name,o.addEventListener("click",()=>c(e)),t.appendChild(o)}),r.length>50){const e=document.createElement("div");e.className="dropdown-empty",e.textContent=`... y ${r.length-50} m√°s. Escribe para filtrar.`,t.appendChild(e)}}else t.innerHTML='<div class="dropdown-empty">No se encontraron resultados</div>'}function c(o){e.value=o.name,n&&(n.value=o.name),t.classList.remove("active"),s=-1}function d(){l(e.value),t.classList.add("active")}function u(){t.classList.remove("active"),s=-1,n&&e.value&&(n.value=e.value)}function m(){const e=t.querySelectorAll(".dropdown-item");e.forEach((e,t)=>{e.classList.toggle("highlighted",t===s)}),s>=0&&e[s]&&e[s].scrollIntoView({block:"nearest"})}e.addEventListener("focus",()=>d()),e.addEventListener("input",()=>{l(e.value),t.classList.add("active"),s=-1}),e.addEventListener("keydown",e=>{const n=t.querySelectorAll(".dropdown-item");switch(e.key){case"ArrowDown":e.preventDefault(),t.classList.contains("active")||d(),s=Math.min(s+1,n.length-1),m();break;case"ArrowUp":e.preventDefault(),s=Math.max(s-1,0),m();break;case"Enter":e.preventDefault(),s>=0&&r[s]&&c(r[s]);break;case"Escape":case"Tab":u()}}),document.addEventListener("click",n=>{e.contains(n.target)||t.contains(n.target)||u()})}(e,t,n,i.currencies,{DOLARES:["USD","DOLAR","US$","U$S","DOLLAR"],PESOS:["ARS","PESO","$","AR$","PESOS ARGENTINOS"],EUROS:["EUR","EURO","‚Ç¨"],REALES:["BRL","REAL","R$","REAIS"]});const o=i.currencies.find(e=>e.name.toUpperCase().includes("DOLAR"));o?(e.value=o.name,n&&(n.value=o.name)):i.currencies.length>0&&(e.value=i.currencies[0].name,n&&(n.value=i.currencies[0].name)),console.log(`üìã Currency searchable dropdown ready with ${i.currencies.length} options`)}(),function(){const e=document.getElementById("input-status"),t=document.getElementById("status-dropdown"),n=document.getElementById("input-status-value");if(!e||!t)return;e.disabled=!1,e.placeholder="Buscar estado...",l("status",!1),u(e,t,n,i.statuses);const o=i.statuses.find(e=>"FI"===e.code);o&&(e.value=o.name,n&&(n.value=o.code)),console.log(`üìã Status searchable dropdown ready with ${i.statuses.length} options`)}(),function(){const e=document.getElementById("input-reservation-type"),t=document.getElementById("reservation-type-dropdown"),n=document.getElementById("input-reservation-type-value");e&&t&&(e.disabled=!1,e.placeholder="Buscar tipo...",l("reservation-type",!1),u(e,t,n,i.reservationTypes),console.log(`üìã Reservation type searchable dropdown ready with ${i.reservationTypes.length} options`))}())}catch(e){console.error("‚ùå Error loading master data:",e),c(),d()}}(),async function(){console.log("üîå Testing RPA connection...");try{const e=await o.testConnection();e.success?console.log("‚úÖ RPA connection test successful:",e):console.warn("‚ö†Ô∏è RPA connection test failed:",e.message)}catch(e){console.error("‚ùå RPA connection test error:",e)}}(),await f()}())}),window.EmailClassifier={getAccessToken:async function(e){try{const t={allowSignInPrompt:e,allowConsentPrompt:e,forMSGraphAccess:!1};return await Office.auth.getAccessToken(t)}catch(t){if(console.error("SSO error:",t),13001===t.code){if(e)throw new Error("Please sign in to Outlook to use this add-in");return null}if(13002===t.code)throw new Error("You must grant permission to use this add-in");if(13003===t.code)throw new Error("Single sign-on is not supported in your Outlook version");if(13006===t.code)throw new Error("This add-in requires administrator approval. Please contact your IT department.");return 13007===t.code?(console.log("Invalid grant or consent revoked, falling back to dialog auth"),await E()):13012===t.code?(console.log("SSO unavailable (error 13012), falling back to dialog auth"),await E()):(console.log(`SSO failed with error ${t.code}, attempting fallback auth`),await E())}},handleRegister:y,checkRegistrationStatus:f}})();
//# sourceMappingURL=taskpane.js.map