{"version":3,"file":"taskpane.js","mappings":"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","sources":["webpack://outlook-email-classifier-addin/./src/config/config.ts","webpack://outlook-email-classifier-addin/./src/services/rpaService.ts","webpack://outlook-email-classifier-addin/./src/taskpane/taskpane.ts"],"sourcesContent":["/**\r\n * Configuration for Outlook Add-in\r\n */\r\n\r\ninterface Config {\r\n  apiBaseUrl: string;\r\n  dialogBaseUrl: string; // For Office dialogs (MUST be HTTPS)\r\n  environment: 'development' | 'production';\r\n  version: string;\r\n}\r\n\r\n// Determine environment based on hostname\r\nconst isDevelopment = window.location.hostname === 'localhost';\r\n\r\n// Backend URLs\r\nconst LOCAL_BACKEND = 'http://localhost:7071';\r\nconst PROD_BACKEND = 'https://app-itraffic-rpa.whiteflower-4df565a8.eastus2.azurecontainerapps.io';\r\n\r\nexport const config: Config = {\r\n  // Local development uses local backend for API calls\r\n  apiBaseUrl: isDevelopment ? LOCAL_BACKEND : PROD_BACKEND,\r\n  // Office dialogs REQUIRE HTTPS - always use production for dialogs\r\n  dialogBaseUrl: PROD_BACKEND,\r\n  environment: isDevelopment ? 'development' : 'production',\r\n  version: '1.0.0',\r\n};\r\n\r\n// Log configuration on load\r\nconsole.log('üìù Add-in Configuration:', {\r\n  environment: config.environment,\r\n  apiBaseUrl: config.apiBaseUrl,\r\n  dialogBaseUrl: config.dialogBaseUrl,\r\n  version: config.version,\r\n});\r\n","/**\r\n * RPA Service\r\n * Handles communication with the iTraffic RPA Backend\r\n */\r\n\r\nimport { config } from '../config/config';\r\nimport type { ReservationData } from '../types/reservation';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\ninterface RPAReservationRequest {\r\n  reservationData: {\r\n    passengers: Array<{\r\n      lastName: string;\r\n      firstName: string;\r\n      paxType: string;           // \"ADU\", \"CHD\", \"INF\"\r\n      birthDate: string;         // Formato: MM/DD/AAAA\r\n      nationality: string;       // Ej: \"ARGENTINA\"\r\n      sex: string;               // \"M\" o \"F\"\r\n      documentNumber: string;\r\n      documentType: string;      // Ej: \"DNI\", \"PASSPORT\"\r\n      cuilCuit: string;\r\n      direccion: string;\r\n    }>;\r\n    reservationType: string;     // Ej: \"AGENCIAS [COAG]\"\r\n    status: string;              // Ej: \"PENDIENTE DE CONFIRMACION [PC]\"\r\n    client: string;              // Ej: \"DESPEGAR - TEST - 1\"\r\n    travelDate: string;          // Formato: MM/DD/AAAA\r\n    seller: string;              // Ej: \"TEST TEST\"\r\n  };\r\n}\r\n\r\ninterface RPAReservationResponse {\r\n  success: boolean;\r\n  message: string;\r\n  data?: any;\r\n  timestamp: string;\r\n}\r\n\r\ninterface RPAStatusResponse {\r\n  success: boolean;\r\n  status: string;\r\n  message: string;\r\n  timestamp: string;\r\n}\r\n\r\ninterface RPAHealthResponse {\r\n  status: string;\r\n  timestamp: string;\r\n  uptime: number;\r\n}\r\n\r\n// ============================================================================\r\n// RPA Service Class\r\n// ============================================================================\r\n\r\nclass RPAService {\r\n  private readonly baseUrl: string;\r\n  private readonly timeout: number = 60000; // 60 segundos para operaciones RPA\r\n\r\n  constructor() {\r\n    this.baseUrl = config.apiBaseUrl;\r\n    console.log('ü§ñ RPA Service initialized with base URL:', this.baseUrl);\r\n  }\r\n\r\n  /**\r\n   * Health check del servicio RPA\r\n   */\r\n  async healthCheck(): Promise<RPAHealthResponse> {\r\n    console.log('üè• Checking RPA health...');\r\n    \r\n    try {\r\n      const response = await this.fetchWithTimeout(`${this.baseUrl}/health`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        }\r\n      }, 10000); // 10 segundos para health check\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Health check failed: ${response.status} ${response.statusText}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      console.log('‚úÖ RPA health check successful:', data);\r\n      return data;\r\n    } catch (error: any) {\r\n      console.error('‚ùå RPA health check failed:', error);\r\n      throw new Error(`Health check failed: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener estado del servicio RPA\r\n   */\r\n  async getStatus(): Promise<RPAStatusResponse> {\r\n    console.log('üìä Getting RPA status...');\r\n    \r\n    try {\r\n      const response = await this.fetchWithTimeout(`${this.baseUrl}/api/status`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        }\r\n      }, 10000);\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Status check failed: ${response.status} ${response.statusText}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      console.log('‚úÖ RPA status retrieved:', data);\r\n      return data;\r\n    } catch (error: any) {\r\n      console.error('‚ùå RPA status check failed:', error);\r\n      throw new Error(`Status check failed: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Crear reserva en iTraffic mediante RPA\r\n   */\r\n  async createReservation(reservationData: ReservationData): Promise<RPAReservationResponse> {\r\n    console.log('ü§ñ Creating reservation via RPA...');\r\n    console.log('üìã Reservation data:', reservationData);\r\n\r\n    try {\r\n      // Transformar datos al formato esperado por el RPA\r\n      const rpaRequest: RPAReservationRequest = {\r\n        reservationData: {\r\n          passengers: reservationData.passengers.map(p => ({\r\n            lastName: p.lastName || '',\r\n            firstName: p.firstName || '',\r\n            paxType: p.paxType || 'ADU',\r\n            birthDate: this.formatDateForRPA(p.birthDate),\r\n            nationality: p.nationality || '',\r\n            sex: p.sex || 'M',\r\n            documentNumber: p.documentNumber || '',\r\n            documentType: p.documentType || 'DNI',\r\n            cuilCuit: p.cuilCuit || '',\r\n            direccion: p.direccion || ''\r\n          })),\r\n          reservationType: reservationData.reservationType || '',\r\n          status: reservationData.status || '',\r\n          client: reservationData.client || '',\r\n          travelDate: this.formatDateForRPA(reservationData.travelDate),\r\n          seller: reservationData.seller || ''\r\n        }\r\n      };\r\n\r\n      console.log('üì§ Sending to RPA:', rpaRequest);\r\n\r\n      const response = await this.fetchWithTimeout(`${this.baseUrl}/api/reservations`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify(rpaRequest)\r\n      }, this.timeout);\r\n\r\n      const rawText = await response.text();\r\n      console.log('üì• RPA raw response:', rawText);\r\n\r\n      let result: RPAReservationResponse;\r\n      try {\r\n        result = rawText ? JSON.parse(rawText) : { success: false, message: 'Empty response', timestamp: new Date().toISOString() };\r\n      } catch (parseError) {\r\n        console.error('‚ùå Failed to parse RPA response:', parseError);\r\n        throw new Error(`Invalid response format: ${rawText.substring(0, 100)}`);\r\n      }\r\n\r\n      if (!response.ok) {\r\n        console.error('‚ùå RPA request failed:', response.status, result);\r\n        throw new Error(result.message || `RPA request failed: ${response.status}`);\r\n      }\r\n\r\n      if (!result.success) {\r\n        console.error('‚ùå RPA operation failed:', result);\r\n        throw new Error(result.message || 'RPA operation failed');\r\n      }\r\n\r\n      console.log('‚úÖ Reservation created successfully:', result);\r\n      return result;\r\n    } catch (error: any) {\r\n      console.error('‚ùå Create reservation failed:', error);\r\n      \r\n      // Proporcionar mensajes de error m√°s descriptivos\r\n      if (error.name === 'AbortError') {\r\n        throw new Error('La operaci√≥n tard√≥ demasiado tiempo (timeout de 60s). El RPA puede estar procesando la reserva.');\r\n      }\r\n      \r\n      throw new Error(error.message || 'Failed to create reservation');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Test de conexi√≥n con el backend RPA\r\n   */\r\n  async testConnection(): Promise<{ success: boolean; message: string; details?: any }> {\r\n    console.log('üîå Testing RPA connection...');\r\n    \r\n    try {\r\n      const response = await this.fetchWithTimeout(`${this.baseUrl}/api/test-connection`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({\r\n          timestamp: new Date().toISOString(),\r\n          source: 'outlook-addin'\r\n        })\r\n      }, 10000);\r\n\r\n      if (!response.ok) {\r\n        return {\r\n          success: false,\r\n          message: `Connection test failed: ${response.status} ${response.statusText}`\r\n        };\r\n      }\r\n\r\n      const data = await response.json();\r\n      console.log('‚úÖ Connection test successful:', data);\r\n      \r\n      return {\r\n        success: true,\r\n        message: 'Connection successful',\r\n        details: data\r\n      };\r\n    } catch (error: any) {\r\n      console.error('‚ùå Connection test failed:', error);\r\n      return {\r\n        success: false,\r\n        message: `Connection failed: ${error.message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  // ============================================================================\r\n  // Helper Methods\r\n  // ============================================================================\r\n\r\n  /**\r\n   * Fetch con timeout\r\n   */\r\n  private async fetchWithTimeout(url: string, options: RequestInit, timeout: number): Promise<Response> {\r\n    const controller = new AbortController();\r\n    const timeoutId = setTimeout(() => controller.abort(), timeout);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        ...options,\r\n        signal: controller.signal\r\n      });\r\n      clearTimeout(timeoutId);\r\n      return response;\r\n    } catch (error: any) {\r\n      clearTimeout(timeoutId);\r\n      if (error.name === 'AbortError') {\r\n        throw new Error(`Request timeout after ${timeout}ms`);\r\n      }\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Formatear fecha para el RPA (MM/DD/AAAA)\r\n   * Acepta varios formatos de entrada y convierte a MM/DD/AAAA\r\n   */\r\n  private formatDateForRPA(dateString: string | null): string {\r\n    if (!dateString) return '';\r\n\r\n    try {\r\n      // Intentar parsear diferentes formatos\r\n      let date: Date | null = null;\r\n\r\n      // Formato ISO (YYYY-MM-DD o YYYY-MM-DDTHH:mm:ss)\r\n      if (dateString.includes('-')) {\r\n        date = new Date(dateString);\r\n      }\r\n      // Formato DD/MM/AAAA o MM/DD/AAAA\r\n      else if (dateString.includes('/')) {\r\n        const parts = dateString.split('/');\r\n        if (parts.length === 3) {\r\n          // Asumimos DD/MM/AAAA si el primer n√∫mero es > 12\r\n          if (parseInt(parts[0]) > 12) {\r\n            // DD/MM/AAAA -> MM/DD/AAAA\r\n            date = new Date(`${parts[1]}/${parts[0]}/${parts[2]}`);\r\n          } else {\r\n            // Ya est√° en MM/DD/AAAA o ambiguo\r\n            date = new Date(dateString);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!date || isNaN(date.getTime())) {\r\n        console.warn('‚ö†Ô∏è Invalid date format:', dateString);\r\n        return dateString; // Retornar original si no se puede parsear\r\n      }\r\n\r\n      // Formatear a MM/DD/AAAA\r\n      const month = String(date.getMonth() + 1).padStart(2, '0');\r\n      const day = String(date.getDate()).padStart(2, '0');\r\n      const year = date.getFullYear();\r\n\r\n      const formatted = `${month}/${day}/${year}`;\r\n      console.log(`üìÖ Date formatted: ${dateString} -> ${formatted}`);\r\n      return formatted;\r\n    } catch (error) {\r\n      console.error('‚ùå Error formatting date:', error);\r\n      return dateString; // Retornar original en caso de error\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Export Singleton\r\n// ============================================================================\r\n\r\nexport const rpaService = new RPAService();\r\n\r\n","/**\r\n * Email Classifier - Outlook Add-in\r\n * Main taskpane logic with SSO authentication\r\n */\r\n\r\nimport { config } from '../config/config';\r\nimport { rpaService } from '../services/rpaService';\r\nimport type { ReservationData, ExtractionApiResponse, ExtractionApiError, ExtractionState } from '../types/reservation';\r\n\r\n// Application state\r\ninterface AppState {\r\n  isRegistered: boolean;\r\n  userId: string | null;\r\n  email: string | null;\r\n  isLoading: boolean;\r\n  error: string | null;\r\n  isAuthInProgress: boolean;\r\n  authRetryCount: number;\r\n  lastAuthAttempt: number | null;\r\n}\r\n\r\nconst state: AppState = {\r\n  isRegistered: false,\r\n  userId: null,\r\n  email: null,\r\n  isLoading: false,\r\n  error: null,\r\n  isAuthInProgress: false,\r\n  authRetryCount: 0,\r\n  lastAuthAttempt: null,\r\n};\r\n\r\n// Global dialog reference to prevent multiple dialogs\r\nlet activeDialog: Office.Dialog | null = null;\r\n\r\n/**\r\n * Close any active dialog before opening a new one\r\n */\r\nfunction closeActiveDialog(): void {\r\n  if (activeDialog) {\r\n    try {\r\n      console.log('Closing existing dialog...');\r\n      activeDialog.close();\r\n    } catch (e) {\r\n      console.log('Dialog already closed or invalid');\r\n    }\r\n    activeDialog = null;\r\n  }\r\n}\r\n\r\n// Extraction state\r\nconst extractionState: ExtractionState = {\r\n  isExtracting: false,\r\n  hasExtracted: false,\r\n  data: null,\r\n  error: null,\r\n  isEditing: false,\r\n};\r\n\r\n// Master data state\r\ninterface MasterData {\r\n  sellers: Array<{ code: string; name: string }>;\r\n  clients: Array<{ code: string; name: string; displayName?: string; cuit?: string }>;\r\n  contacts: Array<{ code: string; name: string; displayName?: string; email?: string; phone?: string }>;\r\n  currencies: Array<{ code: string; name: string }>;\r\n  statuses: Array<{ code: string; name: string }>;\r\n  reservationTypes: Array<{ code: string; name: string }>;\r\n  genders: Array<{ code: string; name: string }>;\r\n  documentTypes: Array<{ code: string; name: string }>;\r\n  countries: Array<{ code: string; name: string; fiscalCode?: string }>;\r\n  loaded: boolean;\r\n}\r\n\r\nconst masterData: MasterData = {\r\n  sellers: [],\r\n  clients: [],\r\n  contacts: [],\r\n  currencies: [],\r\n  statuses: [],\r\n  reservationTypes: [],\r\n  genders: [],\r\n  documentTypes: [],\r\n  countries: [],\r\n  loaded: false,\r\n};\r\n\r\n/**\r\n * Office.js initialization\r\n */\r\nOffice.onReady((info) => {\r\n  if (info.host === Office.HostType.Outlook) {\r\n    console.log('üìß Email Classifier Add-in loaded');\r\n    console.log('üîÑ VERSION: 2024-11-06-15:15 - SSO DISABLED - DIALOG ONLY');\r\n    console.log('üöÄ Build timestamp:', new Date().toISOString());\r\n    initializeApp();\r\n  }\r\n});\r\n\r\n/**\r\n * Initialize the application\r\n */\r\nasync function initializeApp(): Promise<void> {\r\n  // Keep loading visible while checking registration\r\n  // Don't hide it yet - let checkRegistrationStatus do it\r\n\r\n  // Setup event listeners\r\n  document.getElementById('register-button')!.addEventListener('click', handleRegister);\r\n  document.getElementById('retry-button')!.addEventListener('click', handleRegister);\r\n  document.getElementById('logout-button')!.addEventListener('click', handleLogout);\r\n  document.getElementById('help-link')!.addEventListener('click', showHelp);\r\n\r\n  // Extraction event listeners\r\n  document.getElementById('extract-button')!.addEventListener('click', handleExtractReservation);\r\n  document.getElementById('reanalyze-button')!.addEventListener('click', handleReanalyze);\r\n  document.getElementById('confirm-button')!.addEventListener('click', handleConfirmReservation);\r\n  document.getElementById('retry-extraction-button')!.addEventListener('click', handleExtractReservation);\r\n\r\n  // Header toggle\r\n  document.getElementById('toggle-header-btn')!.addEventListener('click', toggleHeader);\r\n\r\n  // Load master data for dropdowns (in parallel with registration check)\r\n  loadMasterData();\r\n\r\n  // Test RPA connection\r\n  testRPAConnection();\r\n\r\n  // Check if user is already registered (this will hide loading when done)\r\n  await checkRegistrationStatus();\r\n}\r\n\r\n/**\r\n * Load master data from API (sellers, clients, currencies, statuses, reservationTypes)\r\n */\r\nasync function loadMasterData(): Promise<void> {\r\n  console.log('üìã Loading master data...');\r\n\r\n  // Show loaders\r\n  showFieldLoader('seller', true);\r\n  showFieldLoader('client', true);\r\n  showFieldLoader('contact', true);\r\n  showFieldLoader('currency', true);\r\n  showFieldLoader('status', true);\r\n  showFieldLoader('reservation-type', true);\r\n\r\n  try {\r\n    const response = await fetch(`${config.apiBaseUrl}/api/master-data`, {\r\n      method: 'GET',\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n\r\n    if (!response.ok) {\r\n      console.warn('‚ö†Ô∏è Could not load master data, using defaults');\r\n      hideAllFieldLoaders();\r\n      enableMasterDataFields();\r\n      return;\r\n    }\r\n\r\n    const result = await response.json();\r\n\r\n    if (result.success && result.data) {\r\n      masterData.sellers = result.data.sellers || [];\r\n      masterData.clients = result.data.clients || [];\r\n      masterData.contacts = result.data.contacts || [];\r\n      masterData.currencies = result.data.currencies || [];\r\n      masterData.statuses = result.data.statuses || [];\r\n      masterData.reservationTypes = result.data.reservationTypes || [];\r\n      masterData.genders = result.data.genders || [];\r\n      masterData.documentTypes = result.data.documentTypes || [];\r\n      masterData.countries = result.data.countries || [];\r\n      masterData.loaded = true;\r\n\r\n      console.log('‚úÖ Master data loaded:', {\r\n        sellers: masterData.sellers.length,\r\n        clients: masterData.clients.length,\r\n        contacts: masterData.contacts.length,\r\n        currencies: masterData.currencies.length,\r\n        statuses: masterData.statuses.length,\r\n        reservationTypes: masterData.reservationTypes.length,\r\n        genders: masterData.genders.length,\r\n        documentTypes: masterData.documentTypes.length,\r\n        countries: masterData.countries.length\r\n      });\r\n\r\n      // Populate dropdowns\r\n      populateSellerDropdown();\r\n      populateClientDatalist();\r\n      populateContactDropdown();\r\n      populateCurrencyDropdown();\r\n      populateStatusDropdown();\r\n      populateReservationTypeDropdown();\r\n    }\r\n  } catch (error) {\r\n    console.error('‚ùå Error loading master data:', error);\r\n    hideAllFieldLoaders();\r\n    enableMasterDataFields();\r\n  }\r\n}\r\n\r\n/**\r\n * Show/hide field loader\r\n */\r\nfunction showFieldLoader(field: 'seller' | 'client' | 'contact' | 'currency' | 'status' | 'reservation-type', show: boolean): void {\r\n  const loader = document.getElementById(`${field}-loader`);\r\n  if (loader) {\r\n    if (show) {\r\n      loader.classList.add('active');\r\n    } else {\r\n      loader.classList.remove('active');\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hide all field loaders\r\n */\r\nfunction hideAllFieldLoaders(): void {\r\n  showFieldLoader('seller', false);\r\n  showFieldLoader('client', false);\r\n  showFieldLoader('contact', false);\r\n  showFieldLoader('currency', false);\r\n  showFieldLoader('status', false);\r\n  showFieldLoader('reservation-type', false);\r\n}\r\n\r\n/**\r\n * Enable master data fields after loading\r\n */\r\nfunction enableMasterDataFields(): void {\r\n  const sellerInput = document.getElementById('input-seller') as HTMLInputElement;\r\n  const clientInput = document.getElementById('input-client') as HTMLInputElement;\r\n  const contactInput = document.getElementById('input-contact') as HTMLInputElement;\r\n  const currencyInput = document.getElementById('input-currency') as HTMLInputElement;\r\n  const statusInput = document.getElementById('input-status') as HTMLInputElement;\r\n  const reservationTypeInput = document.getElementById('input-reservation-type') as HTMLInputElement;\r\n\r\n  if (sellerInput) {\r\n    sellerInput.disabled = false;\r\n    sellerInput.placeholder = 'Buscar vendedor...';\r\n  }\r\n  if (clientInput) {\r\n    clientInput.disabled = false;\r\n    clientInput.placeholder = 'Buscar cliente...';\r\n  }\r\n  if (contactInput) {\r\n    contactInput.disabled = false;\r\n    contactInput.placeholder = 'Buscar contacto...';\r\n  }\r\n  if (currencyInput) {\r\n    currencyInput.disabled = false;\r\n    currencyInput.placeholder = 'Buscar moneda...';\r\n  }\r\n  if (statusInput) {\r\n    statusInput.disabled = false;\r\n    statusInput.placeholder = 'Buscar estado...';\r\n  }\r\n  if (reservationTypeInput) {\r\n    reservationTypeInput.disabled = false;\r\n    reservationTypeInput.placeholder = 'Buscar tipo...';\r\n  }\r\n}\r\n\r\n/**\r\n * Populate seller dropdown with master data (searchable)\r\n */\r\nfunction populateSellerDropdown(): void {\r\n  const input = document.getElementById('input-seller') as HTMLInputElement;\r\n  const dropdown = document.getElementById('seller-dropdown') as HTMLDivElement;\r\n  const hiddenInput = document.getElementById('input-seller-value') as HTMLInputElement;\r\n\r\n  if (!input || !dropdown) return;\r\n\r\n  // Enable input\r\n  input.disabled = false;\r\n  input.placeholder = 'Buscar vendedor...';\r\n  showFieldLoader('seller', false);\r\n\r\n  // Setup searchable dropdown\r\n  setupSearchableDropdown(input, dropdown, hiddenInput, masterData.sellers, 'name');\r\n\r\n  console.log(`üìã Seller searchable dropdown ready with ${masterData.sellers.length} options`);\r\n}\r\n\r\n/**\r\n * Populate client dropdown with master data (searchable with lazy loading)\r\n * Shows full format like iTraffic: \"CODE - NAME - Cuit:XXX\"\r\n */\r\nfunction populateClientDatalist(): void {\r\n  const input = document.getElementById('input-client') as HTMLInputElement;\r\n  const dropdown = document.getElementById('client-dropdown') as HTMLDivElement;\r\n  const hiddenInput = document.getElementById('input-client-value') as HTMLInputElement;\r\n\r\n  if (!input || !dropdown) return;\r\n\r\n  // Enable input\r\n  input.disabled = false;\r\n  input.placeholder = 'Buscar cliente...';\r\n  showFieldLoader('client', false);\r\n\r\n  // Setup searchable dropdown with lazy loading - shows displayName if available\r\n  setupSearchableDropdownForClients(input, dropdown, hiddenInput, masterData.clients);\r\n\r\n  console.log(`üìã Client searchable dropdown ready with ${masterData.clients.length} options (lazy loading)`);\r\n}\r\n\r\n/**\r\n * Populate contact dropdown with master data (separate contacts list)\r\n * Shows format: \"CODE - NAME\"\r\n * Field starts empty - user must select a contact\r\n */\r\nfunction populateContactDropdown(): void {\r\n  const input = document.getElementById('input-contact') as HTMLInputElement;\r\n  const dropdown = document.getElementById('contact-dropdown') as HTMLDivElement;\r\n  const hiddenInput = document.getElementById('input-contact-value') as HTMLInputElement;\r\n\r\n  if (!input || !dropdown) return;\r\n\r\n  // Enable input\r\n  input.disabled = false;\r\n  input.placeholder = 'Buscar contacto...';\r\n  showFieldLoader('contact', false);\r\n\r\n  // Setup searchable dropdown with lazy loading - uses contacts list\r\n  setupSearchableDropdownForClients(input, dropdown, hiddenInput, masterData.contacts);\r\n\r\n  // Leave empty by default - user must select\r\n  input.value = '';\r\n  if (hiddenInput) hiddenInput.value = '';\r\n\r\n  console.log(`üìã Contact searchable dropdown ready with ${masterData.contacts.length} options (lazy loading)`);\r\n}\r\n\r\n/**\r\n * Populate currency dropdown with master data (searchable with aliases)\r\n */\r\nfunction populateCurrencyDropdown(): void {\r\n  const input = document.getElementById('input-currency') as HTMLInputElement;\r\n  const dropdown = document.getElementById('currency-dropdown') as HTMLDivElement;\r\n  const hiddenInput = document.getElementById('input-currency-value') as HTMLInputElement;\r\n\r\n  if (!input || !dropdown) return;\r\n\r\n  // Enable input\r\n  input.disabled = false;\r\n  input.placeholder = 'Buscar moneda...';\r\n  showFieldLoader('currency', false);\r\n\r\n  // Currency aliases for common abbreviations\r\n  const currencyAliases: Record<string, string[]> = {\r\n    'DOLARES': ['USD', 'DOLAR', 'US$', 'U$S', 'DOLLAR'],\r\n    'PESOS': ['ARS', 'PESO', '$', 'AR$', 'PESOS ARGENTINOS'],\r\n    'EUROS': ['EUR', 'EURO', '‚Ç¨'],\r\n    'REALES': ['BRL', 'REAL', 'R$', 'REAIS'],\r\n  };\r\n\r\n  // Setup searchable dropdown with alias support\r\n  setupSearchableDropdownWithAliases(input, dropdown, hiddenInput, masterData.currencies, currencyAliases);\r\n\r\n  // Set default value to DOLARES if exists\r\n  const dolares = masterData.currencies.find(c => c.name.toUpperCase().includes('DOLAR'));\r\n  if (dolares) {\r\n    input.value = dolares.name;\r\n    if (hiddenInput) hiddenInput.value = dolares.name;\r\n  } else if (masterData.currencies.length > 0) {\r\n    input.value = masterData.currencies[0].name;\r\n    if (hiddenInput) hiddenInput.value = masterData.currencies[0].name;\r\n  }\r\n\r\n  console.log(`üìã Currency searchable dropdown ready with ${masterData.currencies.length} options`);\r\n}\r\n\r\n/**\r\n * Populate status dropdown with master data (searchable with lazy loading)\r\n * Shows only name (no code)\r\n */\r\nfunction populateStatusDropdown(): void {\r\n  const input = document.getElementById('input-status') as HTMLInputElement;\r\n  const dropdown = document.getElementById('status-dropdown') as HTMLDivElement;\r\n  const hiddenInput = document.getElementById('input-status-value') as HTMLInputElement;\r\n\r\n  if (!input || !dropdown) return;\r\n\r\n  // Enable input\r\n  input.disabled = false;\r\n  input.placeholder = 'Buscar estado...';\r\n  showFieldLoader('status', false);\r\n\r\n  // Setup searchable dropdown with lazy loading - name only display\r\n  setupSearchableDropdownLazyNameOnly(input, dropdown, hiddenInput, masterData.statuses);\r\n\r\n  // Set default value to CONFIRMACION if exists\r\n  const confirmacion = masterData.statuses.find(s => s.code === 'FI');\r\n  if (confirmacion) {\r\n    input.value = confirmacion.name;\r\n    if (hiddenInput) hiddenInput.value = confirmacion.code;\r\n  }\r\n\r\n  console.log(`üìã Status searchable dropdown ready with ${masterData.statuses.length} options`);\r\n}\r\n\r\n/**\r\n * Populate reservation type dropdown with master data (searchable with lazy loading)\r\n * Shows only name (no code)\r\n */\r\nfunction populateReservationTypeDropdown(): void {\r\n  const input = document.getElementById('input-reservation-type') as HTMLInputElement;\r\n  const dropdown = document.getElementById('reservation-type-dropdown') as HTMLDivElement;\r\n  const hiddenInput = document.getElementById('input-reservation-type-value') as HTMLInputElement;\r\n\r\n  if (!input || !dropdown) return;\r\n\r\n  // Enable input\r\n  input.disabled = false;\r\n  input.placeholder = 'Buscar tipo...';\r\n  showFieldLoader('reservation-type', false);\r\n\r\n  // Setup searchable dropdown with lazy loading - name only display\r\n  setupSearchableDropdownLazyNameOnly(input, dropdown, hiddenInput, masterData.reservationTypes);\r\n\r\n  console.log(`üìã Reservation type searchable dropdown ready with ${masterData.reservationTypes.length} options`);\r\n}\r\n\r\n/**\r\n * Setup a searchable dropdown component\r\n */\r\nfunction setupSearchableDropdown(\r\n  input: HTMLInputElement,\r\n  dropdown: HTMLDivElement,\r\n  hiddenInput: HTMLInputElement | null,\r\n  items: Array<{ code: string; name: string }>,\r\n  displayField: 'name' | 'code'\r\n): void {\r\n  let highlightedIndex = -1;\r\n  let filteredItems = [...items];\r\n\r\n  // Render dropdown items\r\n  function renderDropdown(filter: string = ''): void {\r\n    const searchTerm = filter.toLowerCase();\r\n    filteredItems = items.filter(item =>\r\n      item.name.toLowerCase().includes(searchTerm) ||\r\n      item.code.toLowerCase().includes(searchTerm)\r\n    );\r\n\r\n    dropdown.innerHTML = '';\r\n\r\n    if (filteredItems.length === 0) {\r\n      dropdown.innerHTML = '<div class=\"dropdown-empty\">No se encontraron resultados</div>';\r\n      return;\r\n    }\r\n\r\n    // Limit to 50 items for performance\r\n    const displayItems = filteredItems.slice(0, 50);\r\n\r\n    displayItems.forEach((item, index) => {\r\n      const div = document.createElement('div');\r\n      div.className = 'dropdown-item';\r\n      div.dataset.value = item[displayField];\r\n      div.dataset.index = index.toString();\r\n      div.textContent = item.name;\r\n\r\n      div.addEventListener('click', () => {\r\n        selectItem(item);\r\n      });\r\n\r\n      dropdown.appendChild(div);\r\n    });\r\n\r\n    if (filteredItems.length > 50) {\r\n      const moreDiv = document.createElement('div');\r\n      moreDiv.className = 'dropdown-empty';\r\n      moreDiv.textContent = `... y ${filteredItems.length - 50} m√°s. Escribe para filtrar.`;\r\n      dropdown.appendChild(moreDiv);\r\n    }\r\n  }\r\n\r\n  // Select an item\r\n  function selectItem(item: { code: string; name: string }): void {\r\n    input.value = item.name;\r\n    if (hiddenInput) hiddenInput.value = item[displayField];\r\n    dropdown.classList.remove('active');\r\n    highlightedIndex = -1;\r\n  }\r\n\r\n  // Show dropdown\r\n  function showDropdown(): void {\r\n    renderDropdown(input.value);\r\n    dropdown.classList.add('active');\r\n  }\r\n\r\n  // Hide dropdown\r\n  function hideDropdown(): void {\r\n    dropdown.classList.remove('active');\r\n    highlightedIndex = -1;\r\n  }\r\n\r\n  // Update highlight\r\n  function updateHighlight(): void {\r\n    const items = dropdown.querySelectorAll('.dropdown-item');\r\n    items.forEach((item, index) => {\r\n      item.classList.toggle('highlighted', index === highlightedIndex);\r\n    });\r\n\r\n    // Scroll into view\r\n    if (highlightedIndex >= 0 && items[highlightedIndex]) {\r\n      items[highlightedIndex].scrollIntoView({ block: 'nearest' });\r\n    }\r\n  }\r\n\r\n  // Event: Focus - show dropdown\r\n  input.addEventListener('focus', () => {\r\n    showDropdown();\r\n  });\r\n\r\n  // Event: Input - filter items\r\n  input.addEventListener('input', () => {\r\n    renderDropdown(input.value);\r\n    dropdown.classList.add('active');\r\n    highlightedIndex = -1;\r\n  });\r\n\r\n  // Event: Keydown - navigation\r\n  input.addEventListener('keydown', (e) => {\r\n    const items = dropdown.querySelectorAll('.dropdown-item');\r\n\r\n    switch (e.key) {\r\n      case 'ArrowDown':\r\n        e.preventDefault();\r\n        if (!dropdown.classList.contains('active')) {\r\n          showDropdown();\r\n        }\r\n        highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);\r\n        updateHighlight();\r\n        break;\r\n\r\n      case 'ArrowUp':\r\n        e.preventDefault();\r\n        highlightedIndex = Math.max(highlightedIndex - 1, 0);\r\n        updateHighlight();\r\n        break;\r\n\r\n      case 'Enter':\r\n        e.preventDefault();\r\n        if (highlightedIndex >= 0 && filteredItems[highlightedIndex]) {\r\n          selectItem(filteredItems[highlightedIndex]);\r\n        }\r\n        break;\r\n\r\n      case 'Escape':\r\n        hideDropdown();\r\n        break;\r\n\r\n      case 'Tab':\r\n        hideDropdown();\r\n        break;\r\n    }\r\n  });\r\n\r\n  // Event: Click outside - hide dropdown\r\n  document.addEventListener('click', (e) => {\r\n    if (!input.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {\r\n      hideDropdown();\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Setup a searchable dropdown with lazy loading (for large datasets like clients)\r\n * - Only renders visible items initially\r\n * - Loads more items as user scrolls\r\n * - Searches across ALL items when filtering\r\n */\r\nfunction setupSearchableDropdownLazy(\r\n  input: HTMLInputElement,\r\n  dropdown: HTMLDivElement,\r\n  hiddenInput: HTMLInputElement | null,\r\n  items: Array<{ code: string; name: string }>,\r\n  displayField: 'name' | 'code'\r\n): void {\r\n  let highlightedIndex = -1;\r\n  let filteredItems = [...items];\r\n  let renderedCount = 0;\r\n  const BATCH_SIZE = 30; // Items to load per batch\r\n  const INITIAL_LOAD = 30; // Initial items to show\r\n\r\n  // Render dropdown items with lazy loading\r\n  function renderDropdown(filter: string = '', loadMore: boolean = false): void {\r\n    const searchTerm = filter.toLowerCase().trim();\r\n\r\n    // Filter ALL items (search over complete dataset)\r\n    if (searchTerm) {\r\n      filteredItems = items.filter(item =>\r\n        item.name.toLowerCase().includes(searchTerm) ||\r\n        item.code.toLowerCase().includes(searchTerm)\r\n      );\r\n    } else {\r\n      filteredItems = [...items];\r\n    }\r\n\r\n    // If not loading more, reset the dropdown\r\n    if (!loadMore) {\r\n      dropdown.innerHTML = '';\r\n      renderedCount = 0;\r\n    }\r\n\r\n    if (filteredItems.length === 0) {\r\n      dropdown.innerHTML = '<div class=\"dropdown-empty\">No se encontraron resultados</div>';\r\n      return;\r\n    }\r\n\r\n    // Calculate how many items to render\r\n    const startIndex = renderedCount;\r\n    const endIndex = Math.min(startIndex + (loadMore ? BATCH_SIZE : INITIAL_LOAD), filteredItems.length);\r\n\r\n    // Render items\r\n    for (let i = startIndex; i < endIndex; i++) {\r\n      const item = filteredItems[i];\r\n      const div = document.createElement('div');\r\n      div.className = 'dropdown-item';\r\n      div.dataset.value = item[displayField];\r\n      div.dataset.index = i.toString();\r\n      // Show code and name for clients\r\n      div.textContent = `${item.code} - ${item.name}`;\r\n\r\n      div.addEventListener('click', () => {\r\n        selectItem(item);\r\n      });\r\n\r\n      dropdown.appendChild(div);\r\n    }\r\n\r\n    renderedCount = endIndex;\r\n\r\n    // Show \"load more\" indicator if there are more items\r\n    const existingMore = dropdown.querySelector('.dropdown-more');\r\n    if (existingMore) existingMore.remove();\r\n\r\n    if (renderedCount < filteredItems.length) {\r\n      const moreDiv = document.createElement('div');\r\n      moreDiv.className = 'dropdown-empty dropdown-more';\r\n      moreDiv.textContent = `Mostrando ${renderedCount} de ${filteredItems.length}. Scroll para ver m√°s...`;\r\n      dropdown.appendChild(moreDiv);\r\n    }\r\n  }\r\n\r\n  // Select an item\r\n  function selectItem(item: { code: string; name: string }): void {\r\n    input.value = `${item.code} - ${item.name}`;\r\n    if (hiddenInput) hiddenInput.value = item[displayField];\r\n    dropdown.classList.remove('active');\r\n    highlightedIndex = -1;\r\n  }\r\n\r\n  // Show dropdown\r\n  function showDropdown(): void {\r\n    renderDropdown(input.value);\r\n    dropdown.classList.add('active');\r\n  }\r\n\r\n  // Hide dropdown\r\n  function hideDropdown(): void {\r\n    dropdown.classList.remove('active');\r\n    highlightedIndex = -1;\r\n    // Sync hidden input with visible input value when closing without selection\r\n    if (hiddenInput && input.value) {\r\n      hiddenInput.value = input.value;\r\n    }\r\n  }\r\n\r\n  // Update highlight\r\n  function updateHighlight(): void {\r\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\r\n    visibleItems.forEach((item, index) => {\r\n      item.classList.toggle('highlighted', index === highlightedIndex);\r\n    });\r\n\r\n    // Scroll into view\r\n    if (highlightedIndex >= 0 && visibleItems[highlightedIndex]) {\r\n      visibleItems[highlightedIndex].scrollIntoView({ block: 'nearest' });\r\n    }\r\n  }\r\n\r\n  // Event: Focus - show dropdown\r\n  input.addEventListener('focus', () => {\r\n    showDropdown();\r\n  });\r\n\r\n  // Event: Input - filter items (searches ALL items)\r\n  input.addEventListener('input', () => {\r\n    renderDropdown(input.value);\r\n    dropdown.classList.add('active');\r\n    highlightedIndex = -1;\r\n  });\r\n\r\n  // Event: Scroll - lazy load more items\r\n  dropdown.addEventListener('scroll', () => {\r\n    const scrollBottom = dropdown.scrollTop + dropdown.clientHeight;\r\n    const scrollHeight = dropdown.scrollHeight;\r\n\r\n    // Load more when user scrolls near the bottom (within 50px)\r\n    if (scrollHeight - scrollBottom < 50 && renderedCount < filteredItems.length) {\r\n      renderDropdown(input.value, true);\r\n    }\r\n  });\r\n\r\n  // Event: Keydown - navigation\r\n  input.addEventListener('keydown', (e) => {\r\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\r\n\r\n    switch (e.key) {\r\n      case 'ArrowDown':\r\n        e.preventDefault();\r\n        if (!dropdown.classList.contains('active')) {\r\n          showDropdown();\r\n        }\r\n        highlightedIndex = Math.min(highlightedIndex + 1, visibleItems.length - 1);\r\n        updateHighlight();\r\n        break;\r\n\r\n      case 'ArrowUp':\r\n        e.preventDefault();\r\n        highlightedIndex = Math.max(highlightedIndex - 1, 0);\r\n        updateHighlight();\r\n        break;\r\n\r\n      case 'Enter':\r\n        e.preventDefault();\r\n        if (highlightedIndex >= 0 && highlightedIndex < renderedCount) {\r\n          selectItem(filteredItems[highlightedIndex]);\r\n        }\r\n        break;\r\n\r\n      case 'Escape':\r\n        hideDropdown();\r\n        break;\r\n\r\n      case 'Tab':\r\n        hideDropdown();\r\n        break;\r\n    }\r\n  });\r\n\r\n  // Event: Click outside - hide dropdown\r\n  document.addEventListener('click', (e) => {\r\n    if (!input.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {\r\n      hideDropdown();\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Setup a searchable dropdown with lazy loading - NAME ONLY display (for clients)\r\n * Shows only the name without the code\r\n */\r\nfunction setupSearchableDropdownLazyNameOnly(\r\n  input: HTMLInputElement,\r\n  dropdown: HTMLDivElement,\r\n  hiddenInput: HTMLInputElement | null,\r\n  items: Array<{ code: string; name: string }>\r\n): void {\r\n  let highlightedIndex = -1;\r\n  let filteredItems = [...items];\r\n  let renderedCount = 0;\r\n  const BATCH_SIZE = 30;\r\n  const INITIAL_LOAD = 30;\r\n\r\n  function renderDropdown(filter: string = '', loadMore: boolean = false): void {\r\n    const searchTerm = filter.toLowerCase().trim();\r\n\r\n    if (searchTerm) {\r\n      filteredItems = items.filter(item =>\r\n        item.name.toLowerCase().includes(searchTerm) ||\r\n        item.code.toLowerCase().includes(searchTerm)\r\n      );\r\n    } else {\r\n      filteredItems = [...items];\r\n    }\r\n\r\n    if (!loadMore) {\r\n      dropdown.innerHTML = '';\r\n      renderedCount = 0;\r\n    }\r\n\r\n    if (filteredItems.length === 0) {\r\n      dropdown.innerHTML = '<div class=\"dropdown-empty\">No se encontraron resultados</div>';\r\n      return;\r\n    }\r\n\r\n    const startIndex = renderedCount;\r\n    const endIndex = Math.min(startIndex + (loadMore ? BATCH_SIZE : INITIAL_LOAD), filteredItems.length);\r\n\r\n    for (let i = startIndex; i < endIndex; i++) {\r\n      const item = filteredItems[i];\r\n      const div = document.createElement('div');\r\n      div.className = 'dropdown-item';\r\n      div.dataset.value = item.name;\r\n      div.dataset.index = i.toString();\r\n      // Show only name (no code)\r\n      div.textContent = item.name;\r\n\r\n      div.addEventListener('click', () => selectItem(item));\r\n      dropdown.appendChild(div);\r\n    }\r\n\r\n    renderedCount = endIndex;\r\n\r\n    const existingMore = dropdown.querySelector('.dropdown-more');\r\n    if (existingMore) existingMore.remove();\r\n\r\n    if (renderedCount < filteredItems.length) {\r\n      const moreDiv = document.createElement('div');\r\n      moreDiv.className = 'dropdown-empty dropdown-more';\r\n      moreDiv.textContent = `Mostrando ${renderedCount} de ${filteredItems.length}. Scroll para ver m√°s...`;\r\n      dropdown.appendChild(moreDiv);\r\n    }\r\n  }\r\n\r\n  function selectItem(item: { code: string; name: string }): void {\r\n    // Show only name when selected\r\n    input.value = item.name;\r\n    if (hiddenInput) hiddenInput.value = item.name;\r\n    dropdown.classList.remove('active');\r\n    highlightedIndex = -1;\r\n  }\r\n\r\n  function showDropdown(): void {\r\n    renderDropdown(input.value);\r\n    dropdown.classList.add('active');\r\n  }\r\n\r\n  function hideDropdown(): void {\r\n    dropdown.classList.remove('active');\r\n    highlightedIndex = -1;\r\n    // Sync hidden input with visible input value when closing without selection\r\n    if (hiddenInput && input.value) {\r\n      hiddenInput.value = input.value;\r\n    }\r\n  }\r\n\r\n  function updateHighlight(): void {\r\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\r\n    visibleItems.forEach((item, index) => {\r\n      item.classList.toggle('highlighted', index === highlightedIndex);\r\n    });\r\n    if (highlightedIndex >= 0 && visibleItems[highlightedIndex]) {\r\n      visibleItems[highlightedIndex].scrollIntoView({ block: 'nearest' });\r\n    }\r\n  }\r\n\r\n  input.addEventListener('focus', () => showDropdown());\r\n\r\n  input.addEventListener('input', () => {\r\n    renderDropdown(input.value);\r\n    dropdown.classList.add('active');\r\n    highlightedIndex = -1;\r\n  });\r\n\r\n  dropdown.addEventListener('scroll', () => {\r\n    const scrollBottom = dropdown.scrollTop + dropdown.clientHeight;\r\n    const scrollMax = dropdown.scrollHeight - 50;\r\n\r\n    if (scrollBottom >= scrollMax && renderedCount < filteredItems.length) {\r\n      renderDropdown(input.value, true);\r\n    }\r\n  });\r\n\r\n  input.addEventListener('keydown', (e) => {\r\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\r\n\r\n    switch (e.key) {\r\n      case 'ArrowDown':\r\n        e.preventDefault();\r\n        if (!dropdown.classList.contains('active')) showDropdown();\r\n        highlightedIndex = Math.min(highlightedIndex + 1, visibleItems.length - 1);\r\n        updateHighlight();\r\n        break;\r\n      case 'ArrowUp':\r\n        e.preventDefault();\r\n        highlightedIndex = Math.max(highlightedIndex - 1, 0);\r\n        updateHighlight();\r\n        break;\r\n      case 'Enter':\r\n        e.preventDefault();\r\n        if (highlightedIndex >= 0 && filteredItems[highlightedIndex]) {\r\n          selectItem(filteredItems[highlightedIndex]);\r\n        }\r\n        break;\r\n      case 'Escape':\r\n      case 'Tab':\r\n        hideDropdown();\r\n        break;\r\n    }\r\n  });\r\n\r\n  document.addEventListener('click', (e) => {\r\n    if (!input.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {\r\n      hideDropdown();\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Setup a searchable dropdown for clients with displayName support\r\n * Shows full format like iTraffic: \"CODE - NAME - Cuit:XXX\"\r\n */\r\nfunction setupSearchableDropdownForClients(\r\n  input: HTMLInputElement,\r\n  dropdown: HTMLDivElement,\r\n  hiddenInput: HTMLInputElement | null,\r\n  items: Array<{ code: string; name: string; displayName?: string }>\r\n): void {\r\n  let highlightedIndex = -1;\r\n  let filteredItems = [...items];\r\n  let renderedCount = 0;\r\n  const BATCH_SIZE = 30;\r\n  const INITIAL_LOAD = 30;\r\n\r\n  function renderDropdown(filter: string = '', loadMore: boolean = false): void {\r\n    const searchTerm = filter.toLowerCase().trim();\r\n\r\n    if (searchTerm) {\r\n      filteredItems = items.filter(item =>\r\n        item.name.toLowerCase().includes(searchTerm) ||\r\n        item.code.toLowerCase().includes(searchTerm) ||\r\n        (item.displayName && item.displayName.toLowerCase().includes(searchTerm))\r\n      );\r\n    } else {\r\n      filteredItems = [...items];\r\n    }\r\n\r\n    if (!loadMore) {\r\n      dropdown.innerHTML = '';\r\n      renderedCount = 0;\r\n    }\r\n\r\n    if (filteredItems.length === 0) {\r\n      dropdown.innerHTML = '<div class=\"dropdown-empty\">No se encontraron resultados</div>';\r\n      return;\r\n    }\r\n\r\n    const startIndex = renderedCount;\r\n    const endIndex = Math.min(startIndex + (loadMore ? BATCH_SIZE : INITIAL_LOAD), filteredItems.length);\r\n\r\n    for (let i = startIndex; i < endIndex; i++) {\r\n      const item = filteredItems[i];\r\n      const div = document.createElement('div');\r\n      div.className = 'dropdown-item';\r\n      div.dataset.value = item.displayName || `${item.code} - ${item.name}`;\r\n      div.dataset.index = i.toString();\r\n      // Show displayName if available, otherwise \"CODE - NAME\"\r\n      div.textContent = item.displayName || `${item.code} - ${item.name}`;\r\n\r\n      div.addEventListener('click', () => selectItem(item));\r\n      dropdown.appendChild(div);\r\n    }\r\n\r\n    renderedCount = endIndex;\r\n\r\n    const existingMore = dropdown.querySelector('.dropdown-more');\r\n    if (existingMore) existingMore.remove();\r\n\r\n    if (renderedCount < filteredItems.length) {\r\n      const moreDiv = document.createElement('div');\r\n      moreDiv.className = 'dropdown-empty dropdown-more';\r\n      moreDiv.textContent = `Mostrando ${renderedCount} de ${filteredItems.length}. Scroll para ver m√°s...`;\r\n      dropdown.appendChild(moreDiv);\r\n    }\r\n  }\r\n\r\n  function selectItem(item: { code: string; name: string; displayName?: string }): void {\r\n    // Show displayName when selected (full format like iTraffic)\r\n    const displayValue = item.displayName || `${item.code} - ${item.name}`;\r\n    input.value = displayValue;\r\n    if (hiddenInput) hiddenInput.value = displayValue;\r\n    dropdown.classList.remove('active');\r\n    highlightedIndex = -1;\r\n  }\r\n\r\n  function showDropdown(): void {\r\n    renderDropdown(input.value);\r\n    dropdown.classList.add('active');\r\n  }\r\n\r\n  function hideDropdown(): void {\r\n    dropdown.classList.remove('active');\r\n    highlightedIndex = -1;\r\n    // Sync hidden input with visible input value when closing without selection\r\n    if (hiddenInput && input.value) {\r\n      hiddenInput.value = input.value;\r\n    }\r\n  }\r\n\r\n  function updateHighlight(): void {\r\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\r\n    visibleItems.forEach((item, index) => {\r\n      item.classList.toggle('highlighted', index === highlightedIndex);\r\n    });\r\n    if (highlightedIndex >= 0 && visibleItems[highlightedIndex]) {\r\n      visibleItems[highlightedIndex].scrollIntoView({ block: 'nearest' });\r\n    }\r\n  }\r\n\r\n  input.addEventListener('focus', () => showDropdown());\r\n\r\n  input.addEventListener('input', () => {\r\n    renderDropdown(input.value);\r\n    dropdown.classList.add('active');\r\n    highlightedIndex = -1;\r\n  });\r\n\r\n  dropdown.addEventListener('scroll', () => {\r\n    const scrollBottom = dropdown.scrollTop + dropdown.clientHeight;\r\n    const scrollMax = dropdown.scrollHeight - 50;\r\n\r\n    if (scrollBottom >= scrollMax && renderedCount < filteredItems.length) {\r\n      renderDropdown(input.value, true);\r\n    }\r\n  });\r\n\r\n  input.addEventListener('keydown', (e) => {\r\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\r\n\r\n    switch (e.key) {\r\n      case 'ArrowDown':\r\n        e.preventDefault();\r\n        if (!dropdown.classList.contains('active')) showDropdown();\r\n        highlightedIndex = Math.min(highlightedIndex + 1, visibleItems.length - 1);\r\n        updateHighlight();\r\n        break;\r\n      case 'ArrowUp':\r\n        e.preventDefault();\r\n        highlightedIndex = Math.max(highlightedIndex - 1, 0);\r\n        updateHighlight();\r\n        break;\r\n      case 'Enter':\r\n        e.preventDefault();\r\n        if (highlightedIndex >= 0 && filteredItems[highlightedIndex]) {\r\n          selectItem(filteredItems[highlightedIndex]);\r\n        }\r\n        break;\r\n      case 'Escape':\r\n      case 'Tab':\r\n        hideDropdown();\r\n        break;\r\n    }\r\n  });\r\n\r\n  document.addEventListener('click', (e) => {\r\n    if (!input.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {\r\n      hideDropdown();\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Setup a searchable dropdown with alias support (for currencies)\r\n * Allows searching by common abbreviations like USD -> DOLARES\r\n */\r\nfunction setupSearchableDropdownWithAliases(\r\n  input: HTMLInputElement,\r\n  dropdown: HTMLDivElement,\r\n  hiddenInput: HTMLInputElement | null,\r\n  items: Array<{ code: string; name: string }>,\r\n  aliases: Record<string, string[]>\r\n): void {\r\n  let highlightedIndex = -1;\r\n  let filteredItems = [...items];\r\n\r\n  // Build reverse alias map: USD -> DOLARES\r\n  const reverseAliases: Record<string, string> = {};\r\n  for (const [mainName, aliasList] of Object.entries(aliases)) {\r\n    for (const alias of aliasList) {\r\n      reverseAliases[alias.toUpperCase()] = mainName.toUpperCase();\r\n    }\r\n  }\r\n\r\n  function renderDropdown(filter: string = ''): void {\r\n    const searchTerm = filter.toLowerCase().trim();\r\n    const searchTermUpper = filter.toUpperCase().trim();\r\n\r\n    // Check if search term matches an alias\r\n    const resolvedTerm = reverseAliases[searchTermUpper] || searchTerm;\r\n\r\n    if (searchTerm) {\r\n      filteredItems = items.filter(item => {\r\n        const nameMatch = item.name.toLowerCase().includes(searchTerm) ||\r\n          item.name.toLowerCase().includes(resolvedTerm.toLowerCase());\r\n        const codeMatch = item.code.toLowerCase().includes(searchTerm);\r\n\r\n        // Also check if any alias of this item matches\r\n        const itemAliases = aliases[item.name.toUpperCase()] || [];\r\n        const aliasMatch = itemAliases.some(a => a.toLowerCase().includes(searchTerm));\r\n\r\n        return nameMatch || codeMatch || aliasMatch;\r\n      });\r\n    } else {\r\n      filteredItems = [...items];\r\n    }\r\n\r\n    dropdown.innerHTML = '';\r\n\r\n    if (filteredItems.length === 0) {\r\n      dropdown.innerHTML = '<div class=\"dropdown-empty\">No se encontraron resultados</div>';\r\n      return;\r\n    }\r\n\r\n    const displayItems = filteredItems.slice(0, 50);\r\n\r\n    displayItems.forEach((item, index) => {\r\n      const div = document.createElement('div');\r\n      div.className = 'dropdown-item';\r\n      div.dataset.value = item.name;\r\n      div.dataset.index = index.toString();\r\n      div.textContent = item.name;\r\n\r\n      div.addEventListener('click', () => selectItem(item));\r\n      dropdown.appendChild(div);\r\n    });\r\n\r\n    if (filteredItems.length > 50) {\r\n      const moreDiv = document.createElement('div');\r\n      moreDiv.className = 'dropdown-empty';\r\n      moreDiv.textContent = `... y ${filteredItems.length - 50} m√°s. Escribe para filtrar.`;\r\n      dropdown.appendChild(moreDiv);\r\n    }\r\n  }\r\n\r\n  function selectItem(item: { code: string; name: string }): void {\r\n    input.value = item.name;\r\n    if (hiddenInput) hiddenInput.value = item.name;\r\n    dropdown.classList.remove('active');\r\n    highlightedIndex = -1;\r\n  }\r\n\r\n  function showDropdown(): void {\r\n    renderDropdown(input.value);\r\n    dropdown.classList.add('active');\r\n  }\r\n\r\n  function hideDropdown(): void {\r\n    dropdown.classList.remove('active');\r\n    highlightedIndex = -1;\r\n    // Sync hidden input with visible input value when closing without selection\r\n    if (hiddenInput && input.value) {\r\n      hiddenInput.value = input.value;\r\n    }\r\n  }\r\n\r\n  function updateHighlight(): void {\r\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\r\n    visibleItems.forEach((item, index) => {\r\n      item.classList.toggle('highlighted', index === highlightedIndex);\r\n    });\r\n    if (highlightedIndex >= 0 && visibleItems[highlightedIndex]) {\r\n      visibleItems[highlightedIndex].scrollIntoView({ block: 'nearest' });\r\n    }\r\n  }\r\n\r\n  input.addEventListener('focus', () => showDropdown());\r\n\r\n  input.addEventListener('input', () => {\r\n    renderDropdown(input.value);\r\n    dropdown.classList.add('active');\r\n    highlightedIndex = -1;\r\n  });\r\n\r\n  input.addEventListener('keydown', (e) => {\r\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\r\n\r\n    switch (e.key) {\r\n      case 'ArrowDown':\r\n        e.preventDefault();\r\n        if (!dropdown.classList.contains('active')) showDropdown();\r\n        highlightedIndex = Math.min(highlightedIndex + 1, visibleItems.length - 1);\r\n        updateHighlight();\r\n        break;\r\n      case 'ArrowUp':\r\n        e.preventDefault();\r\n        highlightedIndex = Math.max(highlightedIndex - 1, 0);\r\n        updateHighlight();\r\n        break;\r\n      case 'Enter':\r\n        e.preventDefault();\r\n        if (highlightedIndex >= 0 && filteredItems[highlightedIndex]) {\r\n          selectItem(filteredItems[highlightedIndex]);\r\n        }\r\n        break;\r\n      case 'Escape':\r\n      case 'Tab':\r\n        hideDropdown();\r\n        break;\r\n    }\r\n  });\r\n\r\n  document.addEventListener('click', (e) => {\r\n    if (!input.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {\r\n      hideDropdown();\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Toggle header visibility\r\n */\r\nfunction toggleHeader(): void {\r\n  const header = document.getElementById('collapsible-header')!;\r\n  const btn = document.getElementById('toggle-header-btn')!;\r\n\r\n  if (header.style.display === 'none') {\r\n    header.style.display = 'block';\r\n    btn.textContent = 'üîº';\r\n  } else {\r\n    header.style.display = 'none';\r\n    btn.textContent = 'üîΩ';\r\n  }\r\n}\r\n\r\n/**\r\n * Get current user email from Outlook\r\n */\r\nfunction getCurrentUserEmail(): string | null {\r\n  try {\r\n    // Get email from Outlook mailbox\r\n    const userProfile = Office.context.mailbox?.userProfile;\r\n    if (userProfile && userProfile.emailAddress) {\r\n      return userProfile.emailAddress.toLowerCase();\r\n    }\r\n    return null;\r\n  } catch (error) {\r\n    console.error('‚ùå Error getting current user email:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Check if user is already registered\r\n */\r\nasync function checkRegistrationStatus(): Promise<void> {\r\n  try {\r\n    // Get current Outlook user email\r\n    const currentEmail = getCurrentUserEmail();\r\n    console.log('üìß Current Outlook user:', currentEmail);\r\n\r\n    // Check if we have a cached userId in localStorage\r\n    const cachedUserId = localStorage.getItem('email-classifier-userId');\r\n    const cachedEmail = localStorage.getItem('email-classifier-email');\r\n\r\n    if (!cachedUserId || !cachedEmail) {\r\n      console.log('‚è≠Ô∏è No cached user found - user must login manually');\r\n      // Hide loading, show registration UI\r\n      document.getElementById('loading')!.style.display = 'none';\r\n      document.getElementById('app-content')!.style.display = 'block';\r\n      return;\r\n    }\r\n\r\n    // Validate that cached email matches current Outlook email\r\n    if (currentEmail && cachedEmail.toLowerCase() !== currentEmail) {\r\n      console.log('‚ö†Ô∏è Cached email does not match current Outlook email');\r\n      console.log('   Cached:', cachedEmail);\r\n      console.log('   Current:', currentEmail);\r\n      console.log('   Clearing cache and requiring re-login');\r\n\r\n      localStorage.removeItem('email-classifier-userId');\r\n      localStorage.removeItem('email-classifier-email');\r\n\r\n      // Hide loading, show registration UI\r\n      document.getElementById('loading')!.style.display = 'none';\r\n      document.getElementById('app-content')!.style.display = 'block';\r\n      return;\r\n    }\r\n\r\n    console.log('üîç Found cached user:', cachedEmail, '- verifying with backend...');\r\n\r\n    // Verify with production backend where user data is stored\r\n    const response = await fetch(`${config.dialogBaseUrl}/auth/status?userId=${cachedUserId}`);\r\n\r\n    if (!response.ok) {\r\n      console.log('‚ö†Ô∏è User verification failed - clearing cache');\r\n      localStorage.removeItem('email-classifier-userId');\r\n      localStorage.removeItem('email-classifier-email');\r\n\r\n      // Hide loading, show registration UI\r\n      document.getElementById('loading')!.style.display = 'none';\r\n      document.getElementById('app-content')!.style.display = 'block';\r\n      return;\r\n    }\r\n\r\n    const data = await response.json();\r\n\r\n    if (data.isRegistered && data.user) {\r\n      console.log('‚úÖ User verified - updating UI');\r\n\r\n      // Update state\r\n      state.isRegistered = true;\r\n      state.userId = data.user.userId;\r\n      state.email = data.user.email;\r\n\r\n      // Hide loading, show app\r\n      document.getElementById('loading')!.style.display = 'none';\r\n      document.getElementById('app-content')!.style.display = 'block';\r\n\r\n      // Update UI\r\n      updateUIForRegisteredUser(data.user);\r\n    } else {\r\n      console.log('‚ö†Ô∏è User not found in backend - clearing cache');\r\n      localStorage.removeItem('email-classifier-userId');\r\n      localStorage.removeItem('email-classifier-email');\r\n\r\n      // Hide loading, show registration UI\r\n      document.getElementById('loading')!.style.display = 'none';\r\n      document.getElementById('app-content')!.style.display = 'block';\r\n    }\r\n  } catch (error) {\r\n    console.error('‚ùå Error checking registration status:', error);\r\n    // Hide loading, show registration UI\r\n    document.getElementById('loading')!.style.display = 'none';\r\n    document.getElementById('app-content')!.style.display = 'block';\r\n  }\r\n}\r\n\r\n/**\r\n * Handle registration button click - SSO Flow\r\n */\r\nasync function handleRegister(): Promise<void> {\r\n  // Prevent multiple simultaneous authentication attempts\r\n  if (state.isAuthInProgress) {\r\n    console.log('‚ö†Ô∏è Authentication already in progress, ignoring request');\r\n    showError('Authentication is already in progress. Please wait.');\r\n    return;\r\n  }\r\n\r\n  // Implement exponential backoff for retries\r\n  const now = Date.now();\r\n  if (state.lastAuthAttempt && (now - state.lastAuthAttempt) < 2000) {\r\n    console.log('‚ö†Ô∏è Too many authentication attempts, please wait');\r\n    showError('Please wait a moment before trying again.');\r\n    return;\r\n  }\r\n\r\n  hideError();\r\n  setLoading(true);\r\n  state.isAuthInProgress = true;\r\n  state.lastAuthAttempt = now;\r\n\r\n  try {\r\n    console.log('üîê Starting SSO authentication... [VERSION 2024-12-02-DIALOG-PREFERRED]');\r\n\r\n    // Get current Outlook email for validation\r\n    const currentOutlookEmail = getCurrentUserEmail();\r\n    if (!currentOutlookEmail) {\r\n      throw new Error('No se pudo obtener el email de Outlook. Por favor, aseg√∫rate de que Outlook est√© completamente cargado.');\r\n    }\r\n\r\n    console.log('üìß Current Outlook email:', currentOutlookEmail);\r\n\r\n    // TEMPORARY: Skip SSO and always use dialog flow\r\n    // SSO + OBO flow has issues with token exchange, dialog flow works reliably\r\n    // TODO: Fix OBO flow and re-enable SSO for better UX\r\n    console.log('‚ö†Ô∏è Skipping SSO, using dialog authentication (more reliable)...');\r\n    await handleRegisterViaDialog({ forceConsent: true });\r\n    return;\r\n\r\n    // Get SSO token from Office (DISABLED - code below kept for future re-enablement)\r\n    /*\r\n    console.log('üîë Requesting SSO token from Office.auth.getAccessToken()...');\r\n    let ssoToken: string;\r\n    \r\n    try {\r\n      ssoToken = await getOfficeSSToken();\r\n      console.log('‚úÖ SSO token obtained successfully');\r\n      console.log('   Token length:', ssoToken.length);\r\n    } catch (ssoError: any) {\r\n      console.error('‚ùå SSO failed:', ssoError);\r\n      \r\n      // If SSO fails, fall back to dialog flow\r\n      // 13001: No user signed in\r\n      // 13012: API not compatible / sideload\r\n      // 13000: General SSO not available\r\n      // 13003: SSO not supported in this version\r\n      if (ssoError.code === 13001 || ssoError.code === 13012 || ssoError.code === 13000 || ssoError.code === 13003) {\r\n        console.log('‚ö†Ô∏è SSO not available (code: ' + ssoError.code + '), falling back to dialog auth...');\r\n        // Use forceConsent=true to ensure refresh tokens for personal Microsoft accounts\r\n        await handleRegisterViaDialog({ forceConsent: true });\r\n        return;\r\n      }\r\n      \r\n      throw ssoError;\r\n    }\r\n    \r\n    // Exchange SSO token for Graph token via backend OBO flow\r\n    // Must use production backend which has the client_secret for OBO\r\n    console.log('üîÑ Exchanging SSO token for Graph tokens via OBO flow...');\r\n    const exchangeResponse = await fetch(`${config.dialogBaseUrl}/auth/exchange-token`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({ ssoToken })\r\n    });\r\n\r\n    if (!exchangeResponse.ok) {\r\n      const errorData = await exchangeResponse.json().catch(() => ({ error: 'Unknown error' }));\r\n      throw new Error(`Token exchange failed: ${errorData.error || exchangeResponse.statusText}`);\r\n    }\r\n\r\n    const exchangeData = await exchangeResponse.json();\r\n    console.log('‚úÖ Token exchange successful:', exchangeData);\r\n    \r\n    // Validate email matches\r\n    if (exchangeData.email.toLowerCase() !== currentOutlookEmail) {\r\n      console.error('‚ùå Email mismatch after exchange!');\r\n      console.error('   Backend email:', exchangeData.email);\r\n      console.error('   Outlook email:', currentOutlookEmail);\r\n      throw new Error(\r\n        `Error de coherencia: El email autenticado (${exchangeData.email}) no coincide con tu cuenta de Outlook (${currentOutlookEmail})`\r\n      );\r\n    }\r\n    \r\n    // Save to localStorage AND roamingSettings for persistence across contexts\r\n    localStorage.setItem('email-classifier-userId', exchangeData.userId);\r\n    localStorage.setItem('email-classifier-email', exchangeData.email);\r\n    \r\n    // Also save to roamingSettings to share with ribbon commands\r\n    const settings = Office.context.roamingSettings;\r\n    settings.set('email-classifier-userId', exchangeData.userId);\r\n    settings.set('email-classifier-email', exchangeData.email);\r\n    await settings.saveAsync();\r\n    \r\n    console.log('üíæ User credentials saved to localStorage and roamingSettings');\r\n    \r\n    // Update state\r\n    state.isRegistered = true;\r\n    state.userId = exchangeData.userId;\r\n    state.email = exchangeData.email;\r\n\r\n    // Update UI\r\n    updateUIForRegisteredUser({\r\n      email: exchangeData.email,\r\n      id: exchangeData.userId\r\n    });\r\n    \r\n    // Show success message\r\n    const message = exchangeData.hasRefreshToken\r\n      ? 'üéâ Autenticaci√≥n completa! Tus emails se clasificar√°n autom√°ticamente sin vencimiento.'\r\n      : 'üéâ Autenticaci√≥n completa! Tus emails se clasificar√°n autom√°ticamente.';\r\n    \r\n    showSuccessMessage(message);\r\n    */\r\n\r\n  } catch (error: any) {\r\n    console.error('‚ùå Registration error:', error);\r\n    state.authRetryCount++;\r\n    handleRegistrationError(error);\r\n  } finally {\r\n    setLoading(false);\r\n    state.isAuthInProgress = false;\r\n  }\r\n}\r\n\r\n/**\r\n * Get SSO token from Office.auth.getAccessToken()\r\n */\r\nfunction getOfficeSSToken(): Promise<string> {\r\n  return new Promise((resolve, reject) => {\r\n    Office.auth.getAccessToken({\r\n      allowSignInPrompt: true,\r\n      allowConsentPrompt: true,\r\n      forMSGraphAccess: true\r\n    })\r\n      .then(token => resolve(token))\r\n      .catch(error => reject(error));\r\n  });\r\n}\r\n\r\n/**\r\n * Fallback: Handle registration via dialog (for sideload scenarios)\r\n */\r\ninterface DialogOptions {\r\n  forceConsent?: boolean;\r\n}\r\n\r\nasync function handleRegisterViaDialog(options: DialogOptions = {}): Promise<void> {\r\n  try {\r\n    console.log('ü™ü Using dialog-based authentication fallback');\r\n    if (options.forceConsent) {\r\n      console.log('üôè Forcing consent screen for offline_access permission');\r\n    }\r\n\r\n    // Additional check to prevent dialog loops\r\n    if (state.authRetryCount > 3) {\r\n      throw new Error('Too many authentication attempts. Please refresh the page and try again.');\r\n    }\r\n\r\n    const dialogResult = await getAccessTokenViaDialog(options);\r\n    if (!dialogResult) {\r\n      throw new Error('Failed to obtain authorization via dialog');\r\n    }\r\n\r\n    console.log('‚úÖ Dialog returned payload:', {\r\n      status: dialogResult.status,\r\n      hasCode: !!dialogResult.authorizationCode,\r\n      hasToken: !!dialogResult.token\r\n    });\r\n\r\n    // Reset retry count on any successful dialog response\r\n    state.authRetryCount = 0;\r\n\r\n    const currentOutlookEmail = getCurrentUserEmail();\r\n\r\n    if (dialogResult.authorizationCode) {\r\n      await completeRegistrationWithAuthorizationCode(dialogResult, currentOutlookEmail, options);\r\n      return;\r\n    }\r\n\r\n    if (dialogResult.token) {\r\n      console.warn('‚ö†Ô∏è Received legacy token payload from dialog. Proceeding with deprecated flow.');\r\n      await completeLegacyRegistration(dialogResult, currentOutlookEmail);\r\n      return;\r\n    }\r\n\r\n    throw new Error('Invalid authentication response from dialog');\r\n  } catch (error: any) {\r\n    console.error('‚ùå Dialog registration error:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nasync function completeRegistrationWithAuthorizationCode(\r\n  dialogResult: any,\r\n  currentOutlookEmail: string | null,\r\n  options: DialogOptions = {}\r\n): Promise<void> {\r\n  console.log('üì° Redeeming authorization code via backend (confidential client)...');\r\n  console.log('‚ÑπÔ∏è Backend will use client_secret to get access_token + refresh_token');\r\n\r\n  // Use dialogBaseUrl for token exchange since the auth code was issued there\r\n  const redeemResponse = await fetch(`${config.dialogBaseUrl}/auth/redeem-code`, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json'\r\n    },\r\n    body: JSON.stringify({\r\n      code: dialogResult.authorizationCode,\r\n      redirectUri: dialogResult.redirectUri\r\n    })\r\n  });\r\n\r\n  if (!redeemResponse.ok) {\r\n    const errorData = await redeemResponse.json().catch(() => ({ error: 'Unknown error' }));\r\n    console.error('‚ùå Authorization code redemption failed:', errorData);\r\n\r\n    if (redeemResponse.status === 403 && errorData.requiresInteractiveAuth) {\r\n      console.error('‚ùå Consent required but cannot reopen dialog programmatically (Error 12011)');\r\n      throw new Error(\r\n        'Se requiere consentimiento adicional. Por favor, haz clic en \"Retry\" para autorizar nuevamente. ' +\r\n        'Si el problema persiste, contacta a tu administrador de TI.'\r\n      );\r\n    }\r\n\r\n    throw new Error(`No se pudo completar la autenticaci√≥n: ${errorData.error || redeemResponse.statusText}`);\r\n  }\r\n\r\n  const redeemData = await redeemResponse.json();\r\n  console.log('‚úÖ Backend redeemed authorization code successfully:', redeemData);\r\n\r\n  if (!redeemData.user?.id || !redeemData.user?.email) {\r\n    throw new Error('La respuesta del servidor no incluye la informaci√≥n del usuario.');\r\n  }\r\n\r\n  const backendEmail = redeemData.user.email.toLowerCase();\r\n  if (currentOutlookEmail && backendEmail !== currentOutlookEmail) {\r\n    console.error('‚ùå Email mismatch detected after redemption');\r\n    throw new Error(\r\n      `El usuario autenticado (${backendEmail}) no coincide con tu cuenta de Outlook (${currentOutlookEmail}).`\r\n    );\r\n  }\r\n\r\n  await persistUserSession(redeemData.user.id, redeemData.user.email);\r\n  state.isRegistered = true;\r\n  state.userId = redeemData.user.id;\r\n  state.email = redeemData.user.email;\r\n\r\n  updateUIForRegisteredUser({\r\n    email: redeemData.user.email,\r\n    id: redeemData.user.id,\r\n    stats: redeemData.user.stats\r\n  });\r\n\r\n  // Show appropriate message based on refresh token availability\r\n  let successMessage = 'üéâ Autenticaci√≥n completa!';\r\n  if (redeemData.hasRefreshToken) {\r\n    successMessage += ' Tus correos se clasificar√°n autom√°ticamente con acceso permanente.';\r\n  } else {\r\n    console.warn('‚ö†Ô∏è No refresh token received - user will need to re-authenticate periodically');\r\n    successMessage += ' Tus correos se clasificar√°n autom√°ticamente. Nota: Deber√°s volver a autenticarte despu√©s de 1 hora.';\r\n  }\r\n  showSuccessMessage(successMessage);\r\n}\r\n\r\nasync function completeLegacyRegistration(messageData: any, currentOutlookEmail: string | null): Promise<void> {\r\n  if (!messageData.email || !messageData.userId) {\r\n    throw new Error('Invalid legacy authentication response');\r\n  }\r\n\r\n  if (currentOutlookEmail && messageData.email.toLowerCase() !== currentOutlookEmail) {\r\n    throw new Error(\r\n      `Por favor, inicia sesi√≥n con la misma cuenta de Outlook (${currentOutlookEmail}). ` +\r\n      `Intentaste autenticarte con: ${messageData.email}`\r\n    );\r\n  }\r\n\r\n  // Use dialogBaseUrl for registration since it stores user data in production CosmosDB\r\n  const registerResponse = await fetch(`${config.dialogBaseUrl}/auth/register`, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json'\r\n    },\r\n    body: JSON.stringify({\r\n      accessToken: messageData.token,\r\n      refreshToken: messageData.refreshToken,\r\n      userId: messageData.userId,\r\n      email: messageData.email,\r\n      name: messageData.name,\r\n      expiresOn: messageData.expiresOn\r\n    })\r\n  });\r\n\r\n  if (!registerResponse.ok) {\r\n    const errorData = await registerResponse.json().catch(() => ({ error: 'Unknown error' }));\r\n    throw new Error(`Registration failed: ${errorData.error || registerResponse.statusText}`);\r\n  }\r\n\r\n  await persistUserSession(messageData.userId, messageData.email);\r\n  state.isRegistered = true;\r\n  state.userId = messageData.userId;\r\n  state.email = messageData.email;\r\n\r\n  updateUIForRegisteredUser({\r\n    email: messageData.email,\r\n    id: messageData.userId\r\n  });\r\n\r\n  showSuccessMessage('üéâ Autenticaci√≥n completa (modo legacy). Considera actualizar la versi√≥n del complemento.');\r\n}\r\n\r\nasync function persistUserSession(userId: string, email: string): Promise<void> {\r\n  // Save to localStorage\r\n  localStorage.setItem('email-classifier-userId', userId);\r\n  localStorage.setItem('email-classifier-email', email);\r\n\r\n  // Save to roamingSettings to share with ribbon commands\r\n  const settings = Office.context.roamingSettings;\r\n  settings.set('email-classifier-userId', userId);\r\n  settings.set('email-classifier-email', email);\r\n\r\n  // Save settings asynchronously\r\n  return new Promise((resolve) => {\r\n    settings.saveAsync((result) => {\r\n      if (result.status === Office.AsyncResultStatus.Succeeded) {\r\n        console.log('üíæ User credentials saved to localStorage and roamingSettings');\r\n      } else {\r\n        console.error('‚ö†Ô∏è Failed to save roamingSettings:', result.error);\r\n      }\r\n      resolve();\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Handle logout button click\r\n */\r\nasync function handleLogout(): Promise<void> {\r\n  try {\r\n    console.log('üö™ Logging out user...');\r\n\r\n    // Clear localStorage\r\n    localStorage.removeItem('email-classifier-userId');\r\n    localStorage.removeItem('email-classifier-email');\r\n\r\n    // Clear roamingSettings\r\n    const settings = Office.context.roamingSettings;\r\n    settings.remove('email-classifier-userId');\r\n    settings.remove('email-classifier-email');\r\n    settings.saveAsync();\r\n\r\n    console.log('‚úÖ Cleared localStorage and roamingSettings');\r\n\r\n    // Reset state\r\n    state.isRegistered = false;\r\n    state.userId = null;\r\n    state.email = null;\r\n\r\n    // Reset UI\r\n    const statusBox = document.getElementById('status-indicator')!;\r\n    statusBox.className = 'status-box unregistered';\r\n    statusBox.innerHTML = `\r\n      <div class=\"status-icon\">‚è∏Ô∏è</div>\r\n      <div class=\"status-text\">\r\n        <h3>Not Registered</h3>\r\n        <p>Click below to activate automatic email classification</p>\r\n      </div>\r\n    `;\r\n\r\n    // Show registration button, hide logout button\r\n    document.getElementById('registration-section')!.style.display = 'block';\r\n    document.getElementById('logout-section')!.style.display = 'none';\r\n    document.getElementById('stats-section')!.style.display = 'none';\r\n\r\n    console.log('‚úÖ Logged out from add-in');\r\n\r\n    // Logout from Microsoft account (clear MSAL cache)\r\n    console.log('üîì Clearing Microsoft session...');\r\n    const clientId = '6637590b-a6a4-4e53-b429-a766c66f03c3';\r\n    const logoutUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/logout?post_logout_redirect_uri=${encodeURIComponent(window.location.origin)}`;\r\n\r\n    // Open logout in a hidden dialog to clear Microsoft session\r\n    Office.context.ui.displayDialogAsync(\r\n      logoutUrl,\r\n      { height: 20, width: 20, promptBeforeOpen: false },\r\n      (result) => {\r\n        if (result.status === Office.AsyncResultStatus.Succeeded) {\r\n          const dialog = result.value;\r\n          // Close dialog after 2 seconds\r\n          setTimeout(() => {\r\n            dialog.close();\r\n            console.log('‚úÖ Microsoft session cleared');\r\n            showSuccessMessage('üëã Signed out completely. Next login will require re-authentication.');\r\n          }, 2000);\r\n        } else {\r\n          console.log('‚ö†Ô∏è Could not open logout dialog, but local logout succeeded');\r\n          showSuccessMessage('üëã Signed out successfully. Sign in again to re-activate auto-classification.');\r\n        }\r\n      }\r\n    );\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Logout error:', error);\r\n    showError('Failed to sign out. Please try again.');\r\n  }\r\n}\r\n\r\n/**\r\n * Get access token using Office.js SSO with fallback to dialog auth\r\n */\r\nasync function getAccessToken(allowPrompt: boolean): Promise<string | null> {\r\n  try {\r\n    const options: Office.AuthOptions = {\r\n      allowSignInPrompt: allowPrompt,\r\n      allowConsentPrompt: allowPrompt,\r\n      forMSGraphAccess: false, // We're accessing our own API, not Graph\r\n    };\r\n\r\n    const token = await Office.auth.getAccessToken(options);\r\n    return token;\r\n\r\n  } catch (error: any) {\r\n    console.error('SSO error:', error);\r\n\r\n    // Handle specific error codes\r\n    if (error.code === 13001) {\r\n      // User is not signed in\r\n      if (allowPrompt) {\r\n        throw new Error('Please sign in to Outlook to use this add-in');\r\n      }\r\n      return null;\r\n    } else if (error.code === 13002) {\r\n      // User aborted consent\r\n      throw new Error('You must grant permission to use this add-in');\r\n    } else if (error.code === 13003) {\r\n      // SSO not supported\r\n      throw new Error('Single sign-on is not supported in your Outlook version');\r\n    } else if (error.code === 13006) {\r\n      // Admin consent required\r\n      throw new Error('This add-in requires administrator approval. Please contact your IT department.');\r\n    } else if (error.code === 13007) {\r\n      // Invalid grant or consent revoked\r\n      console.log('Invalid grant or consent revoked, falling back to dialog auth');\r\n      return await getAccessTokenViaDialog();\r\n    } else if (error.code === 13012) {\r\n      // API not compatible or sideloading in Outlook\r\n      // This is EXPECTED when sideloading in Outlook - use fallback auth\r\n      console.log('SSO unavailable (error 13012), falling back to dialog auth');\r\n      return await getAccessTokenViaDialog();\r\n    }\r\n\r\n    // For any other error, try fallback auth\r\n    console.log(`SSO failed with error ${error.code}, attempting fallback auth`);\r\n    return await getAccessTokenViaDialog();\r\n  }\r\n}\r\n\r\n/**\r\n * Fallback authentication using Office dialog\r\n */\r\nasync function getAccessTokenViaDialog(options: DialogOptions = {}): Promise<any> {\r\n  // Close any existing dialog first to prevent \"already has an active dialog\" error\r\n  closeActiveDialog();\r\n\r\n  return new Promise((resolve, reject) => {\r\n    const params = new URLSearchParams();\r\n    if (options.forceConsent) {\r\n      params.set('forceConsent', 'true');\r\n    }\r\n    const queryString = params.toString();\r\n    // Office dialogs REQUIRE HTTPS - use dialogBaseUrl (always production)\r\n    const dialogUrl = queryString\r\n      ? `${config.dialogBaseUrl}/login.html?${queryString}`\r\n      : `${config.dialogBaseUrl}/login.html`;\r\n\r\n    console.log('Opening authentication dialog:', dialogUrl);\r\n\r\n    const dialogOptions: Office.DialogOptions = {\r\n      height: 60,\r\n      width: 30,\r\n      promptBeforeOpen: false,\r\n      displayInIframe: false // Azure AD blocks iframing; always use pop-out window\r\n    };\r\n\r\n    Office.context.ui.displayDialogAsync(\r\n      dialogUrl,\r\n      dialogOptions,\r\n      (result) => {\r\n        if (result.status === Office.AsyncResultStatus.Failed) {\r\n          console.error('Failed to open dialog:', result.error);\r\n\r\n          // Handle \"already has an active dialog\" error (12007)\r\n          if (result.error && result.error.code === 12007) {\r\n            console.log('Dialog already active, clearing reference and retrying...');\r\n            activeDialog = null;\r\n            // Retry once after clearing\r\n            setTimeout(() => {\r\n              reject(new Error('Ya hay un dialogo de autenticacion abierto. Cierra la ventana anterior y vuelve a intentar.'));\r\n            }, 500);\r\n            return;\r\n          }\r\n\r\n          if (result.error && result.error.code === 12011) {\r\n            const guidance = 'No pudimos abrir la ventana del consentimiento porque el explorador considera diferente la zona de seguridad. Abre Outlook en Edge/Chrome actualizado o agrega https://app-itraffic-rpa.whiteflower-4df565a8.eastus2.azurecontainerapps.io a los sitios de confianza.';\r\n            reject(new Error(guidance));\r\n            return;\r\n          }\r\n\r\n          reject(new Error(`Failed to open authentication dialog: ${result.error.message || result.error.code}`));\r\n          return;\r\n        }\r\n\r\n        // Store reference to active dialog\r\n        const dialog = result.value;\r\n        activeDialog = dialog;\r\n        let dialogClosed = false;\r\n\r\n        // Function to check localStorage for auth code (fallback mechanism)\r\n        const checkLocalStorageForAuth = (): any | null => {\r\n          try {\r\n            const stored = localStorage.getItem('office_auth_pending');\r\n            if (stored) {\r\n              const data = JSON.parse(stored);\r\n              // Only use if less than 5 minutes old\r\n              if (data.timestamp && (Date.now() - data.timestamp) < 300000) {\r\n                console.log('Found auth code in localStorage (fallback)');\r\n                localStorage.removeItem('office_auth_pending');\r\n                return data;\r\n              } else {\r\n                // Clean up old entry\r\n                localStorage.removeItem('office_auth_pending');\r\n              }\r\n            }\r\n          } catch (e) {\r\n            console.error('Error checking localStorage:', e);\r\n          }\r\n          return null;\r\n        };\r\n\r\n        // Function to check server bridge for auth code (handles cross-context scenario)\r\n        // Bridge must use same URL as dialog (production) since that's where auth code is stored\r\n        const checkServerBridgeForAuth = async (): Promise<any | null> => {\r\n          try {\r\n            const response = await fetch(`${config.dialogBaseUrl}/auth/bridge?email=pending`);\r\n            if (response.ok) {\r\n              const data = await response.json();\r\n              if (data.success && data.code) {\r\n                console.log('üì¶ Found auth code in server bridge');\r\n                return {\r\n                  status: 'code',\r\n                  authorizationCode: data.code,\r\n                  redirectUri: data.redirectUri,\r\n                  state: data.state\r\n                };\r\n              }\r\n            }\r\n          } catch (e) {\r\n            // Silently fail - bridge might not exist or have no data\r\n          }\r\n          return null;\r\n        };\r\n\r\n        // Poll localStorage and server bridge every 2 seconds as fallback\r\n        const localStorageInterval = setInterval(async () => {\r\n          if (dialogClosed) {\r\n            clearInterval(localStorageInterval);\r\n            return;\r\n          }\r\n\r\n          // First check localStorage\r\n          let authData = checkLocalStorageForAuth();\r\n\r\n          // If not in localStorage, check server bridge\r\n          if (!authData) {\r\n            authData = await checkServerBridgeForAuth();\r\n          }\r\n\r\n          if (authData && authData.status === 'code' && authData.authorizationCode) {\r\n            console.log('Retrieved auth code from fallback mechanism');\r\n            clearInterval(localStorageInterval);\r\n            clearTimeout(timeout);\r\n            dialogClosed = true;\r\n            activeDialog = null;\r\n            try { dialog.close(); } catch (e) { /* dialog might already be closed */ }\r\n            resolve(authData);\r\n          }\r\n        }, 2000);\r\n\r\n        // Set a timeout to prevent infinite waiting\r\n        const timeout = setTimeout(async () => {\r\n          if (!dialogClosed) {\r\n            // Before failing, check localStorage one more time\r\n            let authData = checkLocalStorageForAuth();\r\n            if (!authData) {\r\n              authData = await checkServerBridgeForAuth();\r\n            }\r\n\r\n            if (authData && authData.status === 'code' && authData.authorizationCode) {\r\n              console.log('Retrieved auth code from fallback on timeout');\r\n              clearInterval(localStorageInterval);\r\n              dialogClosed = true;\r\n              activeDialog = null;\r\n              try { dialog.close(); } catch (e) { /* dialog might already be closed */ }\r\n              resolve(authData);\r\n              return;\r\n            }\r\n\r\n            console.error('Dialog timeout - no response received');\r\n            clearInterval(localStorageInterval);\r\n            dialogClosed = true;\r\n            activeDialog = null;\r\n            dialog.close();\r\n            reject(new Error('Authentication timeout. Please try again.'));\r\n          }\r\n        }, 120000); // 2 minute timeout\r\n\r\n        // Listen for messages from the dialog\r\n        dialog.addEventHandler(Office.EventType.DialogMessageReceived, (arg: any) => {\r\n          if (dialogClosed) return;\r\n\r\n          clearTimeout(timeout);\r\n          clearInterval(localStorageInterval);\r\n          dialogClosed = true;\r\n          activeDialog = null;\r\n          dialog.close();\r\n\r\n          try {\r\n            const message = JSON.parse(arg.message);\r\n\r\n            console.log('Received message from dialog:', {\r\n              status: message.status,\r\n              hasCode: !!message.authorizationCode,\r\n              hasToken: !!message.token\r\n            });\r\n\r\n            if (message.status === 'code' && message.authorizationCode) {\r\n              resolve(message);\r\n              return;\r\n            }\r\n\r\n            if (message.status === 'success' && message.token) {\r\n              resolve(message);\r\n              return;\r\n            }\r\n\r\n            reject(new Error(message.error || 'Authentication failed'));\r\n          } catch (error) {\r\n            console.error('‚ùå Error parsing dialog message:', error);\r\n            reject(new Error('Invalid response from authentication dialog'));\r\n          }\r\n        });\r\n\r\n        // Handle dialog closed by user\r\n        dialog.addEventHandler(Office.EventType.DialogEventReceived, async (arg: any) => {\r\n          if (dialogClosed) return;\r\n\r\n          clearTimeout(timeout);\r\n          clearInterval(localStorageInterval);\r\n\r\n          console.log('Dialog event received:', arg);\r\n\r\n          // Before failing, check localStorage and server bridge for auth code\r\n          let authData = checkLocalStorageForAuth();\r\n          if (!authData) {\r\n            authData = await checkServerBridgeForAuth();\r\n          }\r\n\r\n          if (authData && authData.status === 'code' && authData.authorizationCode) {\r\n            console.log('Retrieved auth code from fallback after dialog event');\r\n            dialogClosed = true;\r\n            activeDialog = null;\r\n            resolve(authData);\r\n            return;\r\n          }\r\n\r\n          dialogClosed = true;\r\n          activeDialog = null;\r\n\r\n          if (arg.error === 12006) {\r\n            // User closed dialog - wait a bit and check again\r\n            setTimeout(async () => {\r\n              let delayedAuthData = checkLocalStorageForAuth();\r\n              if (!delayedAuthData) {\r\n                delayedAuthData = await checkServerBridgeForAuth();\r\n              }\r\n\r\n              if (delayedAuthData && delayedAuthData.status === 'code' && delayedAuthData.authorizationCode) {\r\n                console.log('‚úÖ Retrieved auth code from fallback after dialog close delay');\r\n                resolve(delayedAuthData);\r\n              } else {\r\n                reject(new Error('Authentication cancelled by user'));\r\n              }\r\n            }, 1500);\r\n          } else if (arg.error === 12002) {\r\n            // Dialog navigation error\r\n            reject(new Error('Dialog navigation failed. Please check your internet connection.'));\r\n          } else {\r\n            reject(new Error(`Authentication dialog error: ${arg.error || 'Unknown error'}`));\r\n          }\r\n        });\r\n      }\r\n    );\r\n  });\r\n}\r\n\r\n/**\r\n * Update UI for registered user\r\n */\r\nfunction updateUIForRegisteredUser(data: any): void {\r\n  console.log('üé® updateUIForRegisteredUser called with data:', data);\r\n\r\n  // Update status indicator\r\n  const statusBox = document.getElementById('status-indicator')!;\r\n  statusBox.className = 'status-box registered';\r\n  statusBox.innerHTML = `\r\n    <div class=\"status-icon\">‚úÖ</div>\r\n    <div class=\"status-text\">\r\n      <h3>Active</h3>\r\n      <p>Auto-classification enabled for ${data.email || 'your account'}</p>\r\n    </div>\r\n  `;\r\n\r\n  // Hide registration button, show logout button\r\n  document.getElementById('registration-section')!.style.display = 'none';\r\n  document.getElementById('logout-section')!.style.display = 'block';\r\n\r\n  // Show stats section\r\n  document.getElementById('stats-section')!.style.display = 'block';\r\n\r\n  // Show extraction section\r\n  const extractionSection = document.getElementById('extraction-section')!;\r\n  extractionSection.style.display = 'block';\r\n  console.log('‚úÖ Extraction section displayed:', extractionSection.style.display);\r\n\r\n  // Update stats if available\r\n  if (data.stats) {\r\n    document.getElementById('total-classified')!.textContent = data.stats.totalClassified || '0';\r\n    document.getElementById('categories-count')!.textContent = data.stats.categoriesCount || '0';\r\n  }\r\n}\r\n\r\n/**\r\n * Update field status (highlight if missing)\r\n * Handles both Inputs and Selects. For Selects, adds the option if missing.\r\n * For searchable dropdowns, finds the best match from master data.\r\n */\r\nfunction updateFieldStatus(elementId: string, value: string | null): void {\r\n  const element = document.getElementById(elementId) as HTMLInputElement | HTMLSelectElement;\r\n  if (!element) return;\r\n\r\n  const valToSet = value || '';\r\n\r\n  // Helper function to normalize text (remove accents)\r\n  const normalizeText = (text: string): string => {\r\n    return text.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').toUpperCase().trim();\r\n  };\r\n\r\n  // Special handling for searchable dropdown fields - find best match from master data\r\n  if (element.tagName === 'INPUT' && valToSet) {\r\n    const searchableFields: Record<string, Array<{ code: string; name: string }>> = {\r\n      'input-seller': masterData.sellers,\r\n      'input-client': masterData.clients,\r\n      'input-currency': masterData.currencies,\r\n      'input-status': masterData.statuses,\r\n      'input-reservation-type': masterData.reservationTypes,\r\n    };\r\n\r\n    const dataSource = searchableFields[elementId];\r\n    if (dataSource && dataSource.length > 0) {\r\n      const searchTerm = normalizeText(valToSet);\r\n      let match: { code: string; name: string } | undefined;\r\n\r\n      // 1. Try exact match by code\r\n      match = dataSource.find(item =>\r\n        normalizeText(item.code) === searchTerm\r\n      );\r\n\r\n      // 2. Try exact match by name (normalized)\r\n      if (!match) {\r\n        match = dataSource.find(item =>\r\n          normalizeText(item.name) === searchTerm\r\n        );\r\n      }\r\n\r\n      // 3. For status/reservationType, check if name contains [CODE] and match\r\n      // Format is \"NAME [CODE]\" so search for items where the code in brackets matches\r\n      if (!match && (elementId === 'input-status' || elementId === 'input-reservation-type')) {\r\n        match = dataSource.find(item => {\r\n          // Extract code from name if it's in format \"NAME [CODE]\"\r\n          const codeMatch = item.name.match(/\\[([^\\]]+)\\]$/);\r\n          if (codeMatch) {\r\n            return normalizeText(codeMatch[1]) === searchTerm;\r\n          }\r\n          return false;\r\n        });\r\n\r\n        // Also try matching status name without code (e.g., \"Pendiente de confirmaci√≥n\" -> \"PENDIENTE DE CONFIRMACION [PC]\")\r\n        if (!match) {\r\n          // First try to find exact match of name part\r\n          match = dataSource.find(item => {\r\n            const nameWithoutCode = item.name.replace(/\\s*\\[[^\\]]+\\]$/, '');\r\n            return normalizeText(nameWithoutCode) === searchTerm;\r\n          });\r\n        }\r\n\r\n        // Then try partial match but prefer longer matches (more specific)\r\n        if (!match) {\r\n          const candidates = dataSource.filter(item => {\r\n            const nameWithoutCode = item.name.replace(/\\s*\\[[^\\]]+\\]$/, '');\r\n            const normalizedName = normalizeText(nameWithoutCode);\r\n            return normalizedName.includes(searchTerm) || searchTerm.includes(normalizedName);\r\n          });\r\n\r\n          // Sort by name length descending to prefer more specific matches\r\n          // e.g., \"PENDIENTE DE CONFIRMACION\" over \"CONFIRMACION\"\r\n          if (candidates.length > 0) {\r\n            candidates.sort((a, b) => {\r\n              const aName = a.name.replace(/\\s*\\[[^\\]]+\\]$/, '');\r\n              const bName = b.name.replace(/\\s*\\[[^\\]]+\\]$/, '');\r\n              // Prefer exact contains match\r\n              const aContains = searchTerm.includes(normalizeText(aName));\r\n              const bContains = searchTerm.includes(normalizeText(bName));\r\n              if (aContains && !bContains) return -1;\r\n              if (!aContains && bContains) return 1;\r\n              // Then prefer longer names (more specific)\r\n              return bName.length - aName.length;\r\n            });\r\n            match = candidates[0];\r\n          }\r\n        }\r\n      }\r\n\r\n      // 4. Try partial match - search term contains or is contained in name/code (normalized)\r\n      // For status fields, this is handled above with better specificity\r\n      if (!match && elementId !== 'input-status' && elementId !== 'input-reservation-type') {\r\n        match = dataSource.find(item =>\r\n          normalizeText(item.name).includes(searchTerm) ||\r\n          searchTerm.includes(normalizeText(item.name)) ||\r\n          normalizeText(item.code).includes(searchTerm)\r\n        );\r\n      }\r\n\r\n      // 5. For sellers, try matching first part of name (e.g., \"TEST\" matches \"TEST TEST\")\r\n      if (!match && elementId === 'input-seller') {\r\n        match = dataSource.find(item => {\r\n          const nameParts = normalizeText(item.name).split(' ');\r\n          return nameParts.some(part => part === searchTerm || searchTerm.includes(part));\r\n        });\r\n      }\r\n\r\n      // 6. For clients, try matching just the client name/code without the full format\r\n      if (!match && elementId === 'input-client') {\r\n        match = dataSource.find(item => {\r\n          // Client format: \"CODE - NAME - Cuit:XXX\" or just \"NAME\"\r\n          const parts = item.name.split(' - ');\r\n          return parts.some(part =>\r\n            normalizeText(part).includes(searchTerm) ||\r\n            searchTerm.includes(normalizeText(part))\r\n          );\r\n        });\r\n      }\r\n\r\n      // 7. For currency, use alias mapping (USD -> DOLARES, EUR -> EUROS, etc.)\r\n      if (!match && elementId === 'input-currency') {\r\n        const currencyAliases: Record<string, string[]> = {\r\n          'DOLARES': ['USD', 'DOLAR', 'US$', 'U$S', 'DOLLAR', 'DOLLARS', 'D√ìLARES'],\r\n          'PESOS': ['ARS', 'PESO', 'AR$', 'PESOS ARGENTINOS'],\r\n          'EUROS': ['EUR', 'EURO', '‚Ç¨', 'EUROS'],\r\n          'REALES': ['BRL', 'REAL', 'R$', 'REAIS'],\r\n        };\r\n\r\n        // Find which currency this alias belongs to\r\n        for (const [currencyName, aliases] of Object.entries(currencyAliases)) {\r\n          if (aliases.some(alias => normalizeText(alias) === searchTerm)) {\r\n            // Find the currency in master data\r\n            match = dataSource.find(item => normalizeText(item.name).includes(currencyName));\r\n            if (match) {\r\n              console.log(`üí± Currency alias found: \"${valToSet}\" -> \"${match.name}\"`);\r\n              break;\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      if (match) {\r\n        // Set the display value\r\n        element.value = match.name;\r\n\r\n        // Also set hidden value if exists\r\n        const hiddenInput = document.getElementById(`${elementId}-value`) as HTMLInputElement;\r\n        if (hiddenInput) {\r\n          // Always store the name (which includes the code for status/reservationType)\r\n          // The RPA needs the full name to do hasText match in iTraffic dropdowns\r\n          hiddenInput.value = match.name;\r\n        }\r\n\r\n        element.classList.remove('missing-field');\r\n        console.log(`‚úÖ Field ${elementId}: matched \"${valToSet}\" -> \"${match.name}\"`);\r\n        return;\r\n      } else {\r\n        console.warn(`‚ö†Ô∏è Field ${elementId}: no match found for \"${valToSet}\" in ${dataSource.length} items`);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Special handling for Select elements: Add option if it doesn't exist\r\n  if (element.tagName === 'SELECT' && valToSet) {\r\n    const select = element as HTMLSelectElement;\r\n    let exists = false;\r\n    // Check if value exists (case insensitive check might be better but strict for now)\r\n    for (let i = 0; i < select.options.length; i++) {\r\n      if (select.options[i].value === valToSet) {\r\n        exists = true;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (!exists) {\r\n      const option = document.createElement('option');\r\n      option.value = valToSet;\r\n      option.text = `${valToSet} (Detectado)`;\r\n      select.add(option);\r\n    }\r\n  }\r\n\r\n  element.value = valToSet;\r\n\r\n  if (!valToSet) {\r\n    element.classList.add('missing-field');\r\n    // Only set placeholder for inputs, not selects\r\n    if (element.tagName === 'INPUT') {\r\n      (element as HTMLInputElement).placeholder = 'Requerido - Completar';\r\n    }\r\n    // Ensure it's enabled\r\n    element.disabled = false;\r\n  } else {\r\n    element.classList.remove('missing-field');\r\n  }\r\n}\r\n\r\n/**\r\n * Handle registration errors with user-friendly messages\r\n */\r\nfunction handleRegistrationError(error: any): void {\r\n  let userMessage = 'Registration failed. ';\r\n\r\n  if (error.message.includes('offline_access')) {\r\n    userMessage += 'The app needs permission to work in the background. Please contact your administrator.';\r\n  } else if (error.message.includes('consent')) {\r\n    userMessage += 'You must grant permissions to use this add-in.';\r\n  } else if (error.message.includes('administrator')) {\r\n    userMessage += 'This add-in requires administrator approval.';\r\n  } else if (error.message.includes('network') || error.message.includes('fetch')) {\r\n    userMessage += 'Network error. Please check your internet connection.';\r\n  } else {\r\n    userMessage += error.message || 'Please try again or contact support.';\r\n  }\r\n\r\n  showError(userMessage);\r\n}\r\n\r\n/**\r\n * Show error message\r\n */\r\nfunction showError(message: string): void {\r\n  state.error = message;\r\n  const errorSection = document.getElementById('error-section')!;\r\n  const errorMessage = document.getElementById('error-message')!;\r\n\r\n  errorMessage.textContent = message;\r\n  errorSection.style.display = 'flex';\r\n}\r\n\r\n/**\r\n * Hide error message\r\n */\r\nfunction hideError(): void {\r\n  state.error = null;\r\n  document.getElementById('error-section')!.style.display = 'none';\r\n}\r\n\r\n/**\r\n * Show success message\r\n */\r\nfunction showSuccessMessage(message: string): void {\r\n  // You could implement a toast/notification here\r\n  console.log('‚úÖ', message);\r\n\r\n  // For now, temporarily update status box\r\n  const statusBox = document.getElementById('status-indicator')!;\r\n  const originalContent = statusBox.innerHTML;\r\n\r\n  statusBox.innerHTML = `\r\n    <div class=\"status-icon\">‚úÖ</div>\r\n    <div class=\"status-text\">\r\n      <h3>Success!</h3>\r\n      <p>${message}</p>\r\n    </div>\r\n  `;\r\n\r\n  statusBox.style.background = '#dff6dd';\r\n  statusBox.style.borderColor = '#107c10';\r\n\r\n  setTimeout(() => {\r\n    statusBox.style.background = '';\r\n    statusBox.style.borderColor = '';\r\n  }, 3000);\r\n}\r\n\r\n/**\r\n * Set loading state\r\n */\r\nfunction setLoading(loading: boolean): void {\r\n  state.isLoading = loading;\r\n  const button = document.getElementById('register-button') as HTMLButtonElement;\r\n\r\n  if (button) {\r\n    button.disabled = loading;\r\n    button.innerHTML = loading\r\n      ? '<span class=\"button-icon\">‚è≥</span><span>Registering...</span>'\r\n      : '<span class=\"button-icon\">‚ú®</span><span>Activate Auto-Classification</span>';\r\n  }\r\n}\r\n\r\n/**\r\n * Show help dialog\r\n */\r\nfunction showHelp(event: Event): void {\r\n  event.preventDefault();\r\n\r\n  Office.context.ui.displayDialogAsync(\r\n    `${window.location.origin}/help.html`,\r\n    { height: 60, width: 40 },\r\n    (result) => {\r\n      if (result.status === Office.AsyncResultStatus.Failed) {\r\n        console.error('Failed to open help dialog:', result.error);\r\n      }\r\n    }\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// RESERVATION EXTRACTION FEATURE\r\n// ============================================================================\r\n\r\n/**\r\n * Handle extraction button click\r\n */\r\nasync function handleExtractReservation(): Promise<void> {\r\n  console.log('üîç handleExtractReservation called');\r\n  console.log('   State:', { userId: state.userId, isRegistered: state.isRegistered, email: state.email });\r\n  console.log('   Extraction visible:', document.getElementById('extraction-section')!.style.display);\r\n\r\n  if (extractionState.isExtracting) {\r\n    console.log('‚ö†Ô∏è Extraction already in progress');\r\n    return;\r\n  }\r\n\r\n  // Ensure userId is available - check localStorage if not in state\r\n  if (!state.userId) {\r\n    const cachedUserId = localStorage.getItem('email-classifier-userId');\r\n    const cachedEmail = localStorage.getItem('email-classifier-email');\r\n\r\n    if (cachedUserId && cachedEmail) {\r\n      console.log('‚ôªÔ∏è Restored userId from localStorage');\r\n      state.userId = cachedUserId;\r\n      state.email = cachedEmail;\r\n      state.isRegistered = true;\r\n    } else {\r\n      console.error('‚ùå No userId in state or localStorage!');\r\n      showError('Please register first to use extraction feature');\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Hide any previous errors\r\n  document.getElementById('extraction-error')!.style.display = 'none';\r\n\r\n  // Show loading\r\n  document.getElementById('extraction-loading')!.style.display = 'block';\r\n  document.getElementById('extraction-results')!.style.display = 'none';\r\n\r\n  extractionState.isExtracting = true;\r\n  extractionState.error = null;\r\n\r\n  try {\r\n    console.log('üìß Getting email content...');\r\n\r\n    // Get email content from current item\r\n    const emailContent = await getEmailConversationContent();\r\n\r\n    if (!emailContent || emailContent.length < 50) {\r\n      throw new Error('El contenido del email es demasiado corto o no se pudo obtener');\r\n    }\r\n\r\n    console.log(`‚úÖ Email content obtained: ${emailContent.length} characters`);\r\n    console.log('üöÄ Sending to extraction API...');\r\n\r\n    // Call backend extraction API\r\n    const response = await fetch(`${config.apiBaseUrl}/api/extract-reservation`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        userId: state.userId,\r\n        emailContent: emailContent,\r\n        conversationId: Office.context.mailbox.item?.conversationId || null\r\n      })\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorData: ExtractionApiError = await response.json().catch(() => ({\r\n        success: false,\r\n        error: 'Request failed',\r\n        details: `HTTP ${response.status}: ${response.statusText}`\r\n      }));\r\n\r\n      throw new Error(errorData.details || errorData.error || 'Extraction failed');\r\n    }\r\n\r\n    const result: ExtractionApiResponse = await response.json();\r\n\r\n    // Update state\r\n    extractionState.hasExtracted = true;\r\n    extractionState.data = result.data;\r\n    extractionState.error = null;\r\n\r\n    // Display results\r\n    displayExtractionResults(result.data);\r\n\r\n    // Hide loading\r\n    document.getElementById('extraction-loading')!.style.display = 'none';\r\n\r\n  } catch (error: any) {\r\n    console.error('‚ùå Extraction error:', error);\r\n\r\n    extractionState.error = error.message || 'Unknown error occurred';\r\n\r\n    // Hide loading\r\n    document.getElementById('extraction-loading')!.style.display = 'none';\r\n\r\n    // Show error\r\n    const errorSection = document.getElementById('extraction-error')!;\r\n    const errorMessage = document.getElementById('extraction-error-message')!;\r\n\r\n    errorMessage.textContent = error.message || 'No se pudo extraer la informaci√≥n. Por favor, intenta nuevamente.';\r\n    errorSection.style.display = 'flex';\r\n\r\n  } finally {\r\n    extractionState.isExtracting = false;\r\n  }\r\n}\r\n\r\n/**\r\n * Get email conversation content (including forwarded emails and replies)\r\n */\r\nasync function getEmailConversationContent(): Promise<string> {\r\n  return new Promise((resolve, reject) => {\r\n    const item = Office.context.mailbox.item;\r\n\r\n    if (!item) {\r\n      reject(new Error('No email item selected'));\r\n      return;\r\n    }\r\n\r\n    console.log('üìß Getting email body (includes forwarded emails in body)...');\r\n\r\n    // Get body as plain text (includes forwarded emails)\r\n    // Office.CoercionType.Text preserves forwarded content and email chains\r\n    item.body.getAsync(Office.CoercionType.Text, (result) => {\r\n      if (result.status === Office.AsyncResultStatus.Succeeded) {\r\n        const bodyContent = result.value || '';\r\n\r\n        // Also get subject\r\n        const subject = item.subject || '';\r\n\r\n        // Get sender info\r\n        const from = item.from?.displayName || item.from?.emailAddress || '';\r\n\r\n        // Combine all information\r\n        // The body content already includes forwarded emails, so we just need to add context\r\n        const fullContent = `Asunto: ${subject}\r\nDe: ${from}\r\n\r\n${bodyContent}`;\r\n\r\n        console.log(`‚úÖ Email content obtained: ${fullContent.length} characters`);\r\n        console.log(`   Subject: ${subject.substring(0, 50)}...`);\r\n        console.log(`   Body preview: ${bodyContent.substring(0, 100)}...`);\r\n\r\n        resolve(fullContent);\r\n      } else {\r\n        console.error('‚ùå Failed to get email body:', result.error);\r\n        reject(new Error('No se pudo obtener el contenido del email'));\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Display extraction results in the UI\r\n */\r\nfunction displayExtractionResults(data: ReservationData): void {\r\n  console.log('üìä Displaying extraction results...');\r\n\r\n  // Auto-collapse header to show results\r\n  const header = document.getElementById('collapsible-header');\r\n  const btn = document.getElementById('toggle-header-btn');\r\n  if (header && btn) {\r\n    header.style.display = 'none';\r\n    btn.textContent = 'üîΩ';\r\n  }\r\n\r\n  // Show results section\r\n  document.getElementById('extraction-results')!.style.display = 'block';\r\n\r\n  // Update confidence badge\r\n  const confidenceBadge = document.getElementById('confidence-badge')!;\r\n  const confidenceText = document.getElementById('confidence-text')!;\r\n  const confidencePercent = Math.round((data.confidence || 0) * 100);\r\n\r\n  confidenceText.textContent = `Confianza: ${confidencePercent}%`;\r\n\r\n  // Set badge color based on confidence\r\n  confidenceBadge.className = 'confidence-badge';\r\n  if (confidencePercent >= 80) {\r\n    // High confidence - green (default)\r\n  } else if (confidencePercent >= 60) {\r\n    confidenceBadge.classList.add('medium');\r\n  } else {\r\n    confidenceBadge.classList.add('low');\r\n  }\r\n\r\n  // Display passengers\r\n  displayPassengers(data.passengers || []);\r\n\r\n  // Calculate passenger counts\r\n  const passengers = data.passengers || [];\r\n  const adults = passengers.filter(p => p.paxType === 'ADU').length;\r\n  const children = passengers.filter(p => p.paxType === 'CHD').length;\r\n  const infants = passengers.filter(p => p.paxType === 'INF').length;\r\n\r\n  // Set default dates\r\n  const today = new Date().toISOString().split('T')[0];\r\n  const travelDate = data.travelDate || data.checkIn || today;\r\n\r\n  // Populate iTraffic fields (solo campos visibles)\r\n  // Campos comentados en HTML - no intentar acceder\r\n  // (document.getElementById('input-codigo') as HTMLInputElement).value = data.codigo || '';\r\n  // (document.getElementById('input-estado-deuda') as HTMLInputElement).value = data.estadoDeuda || 'A√∫n no posee estado deudor';\r\n\r\n  updateFieldStatus('input-reservation-type', data.reservationType || 'COMA'); // Default to Mayorista?\r\n  updateFieldStatus('input-status', data.status || 'PC'); // Default to Pendiente\r\n\r\n  // Campos de fecha comentados en HTML\r\n  // (document.getElementById('input-reservation-date') as HTMLInputElement).value = data.reservationDate || today;\r\n  (document.getElementById('input-travel-date') as HTMLInputElement).value = travelDate;\r\n  // (document.getElementById('input-tour-end-date') as HTMLInputElement).value = data.tourEndDate || data.checkOut || '';\r\n  // (document.getElementById('input-due-date') as HTMLInputElement).value = data.dueDate || today;\r\n\r\n  updateFieldStatus('input-seller', data.seller);\r\n  // (document.getElementById('input-passenger-name') as HTMLInputElement).value = data.passengerName || (passengers.length > 0 ? `${passengers[0].firstName} ${passengers[0].lastName}` : '');\r\n\r\n  updateFieldStatus('input-client', data.client);\r\n\r\n  // Campos comentados en HTML - no intentar acceder\r\n  // const contactHiddenInput = document.getElementById('input-contact-value') as HTMLInputElement;\r\n  // if (contactHiddenInput) contactHiddenInput.value = '';\r\n\r\n  // (document.getElementById('input-commission') as HTMLInputElement).value = data.commission?.toString() || '';\r\n  // updateFieldStatus('input-currency', data.currency || 'DOLARES');\r\n  // (document.getElementById('input-exchange-rate') as HTMLInputElement).value = data.exchangeRate?.toString() || '1430.00';\r\n\r\n  // (document.getElementById('input-adults') as HTMLInputElement).value = adults.toString();\r\n  // (document.getElementById('input-children') as HTMLInputElement).value = children.toString();\r\n  // (document.getElementById('input-infants') as HTMLInputElement).value = infants.toString();\r\n\r\n  // (document.getElementById('input-trip-name') as HTMLInputElement).value = data.tripName || '';\r\n  // (document.getElementById('input-product-code') as HTMLInputElement).value = data.productCode || data.reservationCode || '';\r\n\r\n  // Secciones comentadas en HTML\r\n  // if (data.flights && data.flights.length > 0) {\r\n  //   displayFlights(data.flights);\r\n  //   document.getElementById('flights-group')!.style.display = 'block';\r\n  // } else {\r\n  //   document.getElementById('flights-group')!.style.display = 'none';\r\n  // }\r\n\r\n  // if (data.services && data.services.length > 0) {\r\n  //   displayServices(data.services);\r\n  //   document.getElementById('services-group')!.style.display = 'block';\r\n  // } else {\r\n  //   document.getElementById('services-group')!.style.display = 'none';\r\n  // }\r\n\r\n  console.log('‚úÖ Results displayed');\r\n}\r\n\r\n/**\r\n * Calculate age from date of birth\r\n */\r\nfunction calculateAge(dateOfBirth: string): number | null {\r\n  try {\r\n    const birthDate = new Date(dateOfBirth);\r\n    const today = new Date();\r\n    let age = today.getFullYear() - birthDate.getFullYear();\r\n    const monthDiff = today.getMonth() - birthDate.getMonth();\r\n    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {\r\n      age--;\r\n    }\r\n    return age;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Display passengers list with editable inputs\r\n */\r\nfunction displayPassengers(passengers: any[]): void {\r\n  const passengersList = document.getElementById('passengers-list')!;\r\n  const passengersCount = document.getElementById('passengers-count')!;\r\n\r\n  passengersCount.textContent = passengers.length.toString();\r\n  passengersList.innerHTML = '';\r\n\r\n  if (passengers.length === 0) {\r\n    // Add empty row for manual entry if needed\r\n    passengers.push({});\r\n  }\r\n\r\n  // Build gender options\r\n  const genderOptions = masterData.genders.length > 0\r\n    ? masterData.genders.map(g => `<option value=\"${g.code}\">${g.name}</option>`).join('')\r\n    : `<option value=\"M\">MASCULINO [M]</option><option value=\"F\">FEMENINO [F]</option>`;\r\n\r\n  // Build document type options\r\n  const docTypeOptions = masterData.documentTypes.length > 0\r\n    ? masterData.documentTypes.map(dt => `<option value=\"${dt.code}\">${dt.name}</option>`).join('')\r\n    : `<option value=\"PAS\">PASAPORTE [PAS]</option><option value=\"DNI\">DOCUMENTO NACIONAL DE IDENTIDAD [DNI]</option>`;\r\n\r\n  // Build nationality options (countries)\r\n  const nationalityOptions = masterData.countries.length > 0\r\n    ? masterData.countries.map(c =>\r\n      `<option value=\"${c.name}\">${c.name}</option>`\r\n    ).join('')\r\n    : `<option value=\"ARGENTINA\">ARGENTINA</option>\r\n  ¬† ¬† ¬†<option value=\"BRASIL\">BRASIL</option>\r\n  ¬† ¬† ¬†<option value=\"ESTADOS UNIDOS\">ESTADOS UNIDOS</option>`;\r\n\r\n  passengers.forEach((passenger, index) => {\r\n    const card = document.createElement('div');\r\n    card.className = 'passenger-card';\r\n    card.setAttribute('data-index', index.toString());\r\n\r\n    // Set selected for current values\r\n    const currentSex = passenger.sex || '';\r\n    const currentDocType = passenger.documentType || '';\r\n    const currentNationality = passenger.nationality || '';\r\n\r\n    card.innerHTML = `\r\n      <div class=\"passenger-card-header\">\r\n        <h4>Pasajero ${index + 1}</h4>\r\n        <button class=\"icon-button remove-passenger\" data-index=\"${index}\" title=\"Eliminar\">üóëÔ∏è</button>\r\n      </div>\r\n      <div class=\"form-grid\">\r\n        <div class=\"form-group\">\r\n          <label>Nombre</label>\r\n          <input type=\"text\" class=\"passenger-input\" data-field=\"firstName\" value=\"${passenger.firstName || ''}\" placeholder=\"Nombre\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Apellido</label>\r\n          <input type=\"text\" class=\"passenger-input\" data-field=\"lastName\" value=\"${passenger.lastName || ''}\" placeholder=\"Apellido\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Tipo Pax</label>\r\n          <select class=\"passenger-input\" data-field=\"paxType\">\r\n            <option value=\"ADU\" ${passenger.paxType === 'ADU' ? 'selected' : ''}>Adulto</option>\r\n            <option value=\"CHD\" ${passenger.paxType === 'CHD' ? 'selected' : ''}>Ni√±o</option>\r\n            <option value=\"INF\" ${passenger.paxType === 'INF' ? 'selected' : ''}>Infante</option>\r\n          </select>\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Sexo</label>\r\n          <select class=\"passenger-input passenger-sex\" data-field=\"sex\" data-current=\"${currentSex}\">\r\n            <option value=\"\">Seleccionar...</option>\r\n            ${genderOptions}\r\n          </select>\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Fecha Nacimiento</label>\r\n          <input type=\"date\" class=\"passenger-input\" data-field=\"birthDate\" value=\"${passenger.birthDate || ''}\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Tipo Doc.</label>\r\n          <select class=\"passenger-input passenger-doctype\" data-field=\"documentType\" data-current=\"${currentDocType}\">\r\n            <option value=\"\">Seleccionar...</option>\r\n            ${docTypeOptions}\r\n          </select>\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Nro. Doc.</label>\r\n          <input type=\"text\" class=\"passenger-input\" data-field=\"documentNumber\" value=\"${passenger.documentNumber || ''}\" placeholder=\"N√∫mero\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>CUIT-CUIL</label>\r\n          <input type=\"text\" class=\"passenger-input\" data-field=\"cuilCuit\" value=\"${passenger.cuilCuit || ''}\" placeholder=\"11111111\">\r\n        </div>\r\n        <div class=\"form-group full-width\">\r\n          <label>Direcci√≥n</label>\r\n          <input type=\"text\" class=\"passenger-input\" data-field=\"direccion\" value=\"${passenger.direccion || ''}\" placeholder=\"Direcci√≥n completa\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Nacionalidad</label>\r\n          <select class=\"passenger-input passenger-nationality\" data-field=\"nationality\" data-current=\"${currentNationality}\">\r\n            <option value=\"\">Seleccionar...</option>\r\n            ${nationalityOptions}\r\n          </select>\r\n        </div>\r\n        <!-- <div class=\"form-group\">\r\n          <label>Tel√©fono</label>\r\n          <input type=\"text\" class=\"passenger-input\" data-field=\"phoneNumber\" value=\"${passenger.phoneNumber || ''}\" placeholder=\"+54...\">\r\n        </div> -->\r\n      </div>\r\n    `;\r\n\r\n    passengersList.appendChild(card);\r\n  });\r\n\r\n  // Set selected values for selects after adding to DOM\r\n  document.querySelectorAll('.passenger-sex').forEach((select: any) => {\r\n    const current = select.getAttribute('data-current');\r\n    if (current) select.value = current;\r\n  });\r\n  document.querySelectorAll('.passenger-doctype').forEach((select: any) => {\r\n    const current = select.getAttribute('data-current');\r\n    if (current) select.value = current;\r\n  });\r\n  document.querySelectorAll('.passenger-nationality').forEach((select: any) => {\r\n    const current = select.getAttribute('data-current');\r\n    if (current) select.value = current;\r\n  });\r\n\r\n  // Add \"Add Passenger\" button if not exists\r\n  if (!document.getElementById('add-passenger-btn')) {\r\n    const addBtn = document.createElement('button');\r\n    addBtn.id = 'add-passenger-btn';\r\n    addBtn.className = 'secondary-button small-button';\r\n    addBtn.innerHTML = '‚ûï Agregar Pasajero';\r\n    addBtn.onclick = () => {\r\n      const currentData = getPassengersFromInputs();\r\n      currentData.push({ paxType: 'ADU' });\r\n      displayPassengers(currentData);\r\n    };\r\n    passengersList.parentNode?.appendChild(addBtn);\r\n  }\r\n\r\n  // Add event listeners for remove buttons\r\n  document.querySelectorAll('.remove-passenger').forEach(btn => {\r\n    btn.addEventListener('click', (e) => {\r\n      const idx = parseInt((e.target as HTMLElement).getAttribute('data-index') || '0');\r\n      const currentData = getPassengersFromInputs();\r\n      currentData.splice(idx, 1);\r\n      displayPassengers(currentData);\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Test RPA connection on startup\r\n */\r\nasync function testRPAConnection(): Promise<void> {\r\n  console.log('üîå Testing RPA connection...');\r\n  \r\n  try {\r\n    const result = await rpaService.testConnection();\r\n    \r\n    if (result.success) {\r\n      console.log('‚úÖ RPA connection test successful:', result);\r\n    } else {\r\n      console.warn('‚ö†Ô∏è RPA connection test failed:', result.message);\r\n    }\r\n  } catch (error: any) {\r\n    console.error('‚ùå RPA connection test error:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Helper to get passengers data from inputs\r\n */\r\nfunction getPassengersFromInputs(): any[] {\r\n  const passengers: any[] = [];\r\n  document.querySelectorAll('.passenger-card').forEach(card => {\r\n    const p: any = {};\r\n    card.querySelectorAll('.passenger-input').forEach((input: any) => {\r\n      p[input.getAttribute('data-field')] = input.value;\r\n    });\r\n    passengers.push(p);\r\n  });\r\n  return passengers;\r\n}\r\n\r\n\r\n/**\r\n * Display flights list with editable inputs\r\n */\r\nfunction displayFlights(flights: any[]): void {\r\n  const flightsList = document.getElementById('flights-list')!;\r\n  const flightsCount = document.getElementById('flights-count')!;\r\n\r\n  flightsCount.textContent = flights.length.toString();\r\n  flightsList.innerHTML = '';\r\n\r\n  if (flights.length === 0) {\r\n    flights.push({});\r\n  }\r\n\r\n  flights.forEach((flight, index) => {\r\n    const card = document.createElement('div');\r\n    card.className = 'flight-card';\r\n    card.setAttribute('data-index', index.toString());\r\n\r\n    card.innerHTML = `\r\n      <div class=\"flight-card-header\">\r\n        <h4>Vuelo ${index + 1}</h4>\r\n        <button class=\"icon-button remove-flight\" data-index=\"${index}\" title=\"Eliminar\">üóëÔ∏è</button>\r\n      </div>\r\n      <div class=\"form-grid\">\r\n        <div class=\"form-group\">\r\n          <label>Origen</label>\r\n          <input type=\"text\" class=\"flight-input\" data-field=\"origin\" value=\"${flight.origin || ''}\" placeholder=\"EZE\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Destino</label>\r\n          <input type=\"text\" class=\"flight-input\" data-field=\"destination\" value=\"${flight.destination || ''}\" placeholder=\"MIA\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Aerol√≠nea</label>\r\n          <input type=\"text\" class=\"flight-input\" data-field=\"airline\" value=\"${flight.airline || ''}\" placeholder=\"AA\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Nro. Vuelo</label>\r\n          <input type=\"text\" class=\"flight-input\" data-field=\"flightNumber\" value=\"${flight.flightNumber || ''}\" placeholder=\"900\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Fecha Salida</label>\r\n          <input type=\"date\" class=\"flight-input\" data-field=\"departureDate\" value=\"${flight.departureDate || ''}\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Hora Salida</label>\r\n          <input type=\"time\" class=\"flight-input\" data-field=\"departureTime\" value=\"${flight.departureTime || ''}\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Fecha Llegada</label>\r\n          <input type=\"date\" class=\"flight-input\" data-field=\"arrivalDate\" value=\"${flight.arrivalDate || ''}\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Hora Llegada</label>\r\n          <input type=\"time\" class=\"flight-input\" data-field=\"arrivalTime\" value=\"${flight.arrivalTime || ''}\">\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    flightsList.appendChild(card);\r\n  });\r\n\r\n  // Add \"Add Flight\" button if not exists\r\n  if (!document.getElementById('add-flight-btn')) {\r\n    const addBtn = document.createElement('button');\r\n    addBtn.id = 'add-flight-btn';\r\n    addBtn.className = 'secondary-button small-button';\r\n    addBtn.innerHTML = '‚ûï Agregar Vuelo';\r\n    addBtn.onclick = () => {\r\n      const currentData = getFlightsFromInputs();\r\n      currentData.push({});\r\n      displayFlights(currentData);\r\n    };\r\n    flightsList.parentNode?.appendChild(addBtn);\r\n  }\r\n\r\n  // Add event listeners for remove buttons\r\n  document.querySelectorAll('.remove-flight').forEach(btn => {\r\n    btn.addEventListener('click', (e) => {\r\n      const idx = parseInt((e.target as HTMLElement).getAttribute('data-index') || '0');\r\n      const currentData = getFlightsFromInputs();\r\n      currentData.splice(idx, 1);\r\n      displayFlights(currentData);\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Helper to get flights data from inputs\r\n */\r\nfunction getFlightsFromInputs(): any[] {\r\n  const flights: any[] = [];\r\n  document.querySelectorAll('.flight-card').forEach(card => {\r\n    const f: any = {};\r\n    card.querySelectorAll('.flight-input').forEach((input: any) => {\r\n      f[input.getAttribute('data-field')] = input.value;\r\n    });\r\n    flights.push(f);\r\n  });\r\n  return flights;\r\n}\r\n\r\n\r\n/**\r\n * Display services list with editable inputs\r\n */\r\nfunction displayServices(services: any[]): void {\r\n  const servicesList = document.getElementById('services-list')!;\r\n  const servicesCount = document.getElementById('services-count')!;\r\n\r\n  servicesCount.textContent = services.length.toString();\r\n  servicesList.innerHTML = '';\r\n\r\n  if (services.length === 0) {\r\n    services.push({});\r\n  }\r\n\r\n  services.forEach((service, index) => {\r\n    const card = document.createElement('div');\r\n    card.className = 'service-card';\r\n    card.setAttribute('data-index', index.toString());\r\n\r\n    card.innerHTML = `\r\n      <div class=\"service-card-header\">\r\n        <h4>Servicio ${index + 1}</h4>\r\n        <button class=\"icon-button remove-service\" data-index=\"${index}\" title=\"Eliminar\">üóëÔ∏è</button>\r\n      </div>\r\n      <div class=\"form-grid\">\r\n        <div class=\"form-group\">\r\n          <label>Tipo</label>\r\n          <select class=\"service-input\" data-field=\"type\">\r\n            <option value=\"transfer\" ${service.type === 'transfer' ? 'selected' : ''}>Traslado</option>\r\n            <option value=\"excursion\" ${service.type === 'excursion' ? 'selected' : ''}>Excursi√≥n</option>\r\n            <option value=\"meal\" ${service.type === 'meal' ? 'selected' : ''}>Comida</option>\r\n            <option value=\"other\" ${service.type === 'other' || !service.type ? 'selected' : ''}>Otro</option>\r\n          </select>\r\n        </div>\r\n        <div class=\"form-group full-width\">\r\n          <label>Descripci√≥n</label>\r\n          <input type=\"text\" class=\"service-input\" data-field=\"description\" value=\"${service.description || ''}\" placeholder=\"Descripci√≥n del servicio\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Fecha</label>\r\n          <input type=\"date\" class=\"service-input\" data-field=\"date\" value=\"${service.date || ''}\">\r\n        </div>\r\n        <div class=\"form-group\">\r\n          <label>Ubicaci√≥n</label>\r\n          <input type=\"text\" class=\"service-input\" data-field=\"location\" value=\"${service.location || ''}\" placeholder=\"Lugar\">\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    servicesList.appendChild(card);\r\n  });\r\n\r\n  // Add \"Add Service\" button if not exists\r\n  if (!document.getElementById('add-service-btn')) {\r\n    const addBtn = document.createElement('button');\r\n    addBtn.id = 'add-service-btn';\r\n    addBtn.className = 'secondary-button small-button';\r\n    addBtn.innerHTML = '‚ûï Agregar Servicio';\r\n    addBtn.onclick = () => {\r\n      const currentData = getServicesFromInputs();\r\n      currentData.push({});\r\n      displayServices(currentData);\r\n    };\r\n    servicesList.parentNode?.appendChild(addBtn);\r\n  }\r\n\r\n  // Add event listeners for remove buttons\r\n  document.querySelectorAll('.remove-service').forEach(btn => {\r\n    btn.addEventListener('click', (e) => {\r\n      const idx = parseInt((e.target as HTMLElement).getAttribute('data-index') || '0');\r\n      const currentData = getServicesFromInputs();\r\n      currentData.splice(idx, 1);\r\n      displayServices(currentData);\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Helper to get services data from inputs\r\n */\r\nfunction getServicesFromInputs(): any[] {\r\n  const services: any[] = [];\r\n  document.querySelectorAll('.service-card').forEach(card => {\r\n    const s: any = {};\r\n    card.querySelectorAll('.service-input').forEach((input: any) => {\r\n      s[input.getAttribute('data-field')] = input.value;\r\n    });\r\n    services.push(s);\r\n  });\r\n  return services;\r\n}\r\n\r\n\r\n/**\r\n * Handle re-analyze button click\r\n */\r\nasync function handleReanalyze(): Promise<void> {\r\n  console.log('üîÑ Re-analyzing email...');\r\n\r\n  // Simply call extract again\r\n  await handleExtractReservation();\r\n}\r\n\r\n/**\r\n * Handle confirm button click\r\n */\r\nasync function handleConfirmReservation(): Promise<void> {\r\n  console.log('‚úÖ Confirming reservation data...');\r\n\r\n  if (!extractionState.data) {\r\n    showError('No hay datos para confirmar');\r\n    return;\r\n  }\r\n\r\n  // Ensure userId is available - check localStorage if not in state\r\n  if (!state.userId) {\r\n    const cachedUserId = localStorage.getItem('email-classifier-userId');\r\n    const cachedEmail = localStorage.getItem('email-classifier-email');\r\n\r\n    if (cachedUserId && cachedEmail) {\r\n      console.log('‚ôªÔ∏è Restored userId from localStorage for confirmation');\r\n      state.userId = cachedUserId;\r\n      state.email = cachedEmail;\r\n      state.isRegistered = true;\r\n    } else {\r\n      showError('Usuario no autenticado');\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Collect current values from form (in case user edited them)\r\n  // For searchable dropdowns, use hidden input value (code) when available\r\n  const getFieldValue = (inputId: string, hiddenId?: string): string | null => {\r\n    if (hiddenId) {\r\n      const hiddenInput = document.getElementById(hiddenId) as HTMLInputElement;\r\n      if (hiddenInput && hiddenInput.value) {\r\n        return hiddenInput.value;\r\n      }\r\n    }\r\n    const input = document.getElementById(inputId) as HTMLInputElement;\r\n    return input?.value || null;\r\n  };\r\n\r\n  // Helper to ensure field values match iTraffic format\r\n  // This re-validates and converts codes to full names if needed\r\n  const normalizeFieldValue = (\r\n    value: string | null,\r\n    dataSource: Array<{ code: string; name: string }>,\r\n    fieldName: string\r\n  ): string | null => {\r\n    if (!value || !dataSource || dataSource.length === 0) return value;\r\n\r\n    const searchTerm = value.toUpperCase().trim();\r\n\r\n    // If already in correct format (contains brackets for status/type), return as-is\r\n    if (searchTerm.includes('[') && searchTerm.includes(']')) {\r\n      return value;\r\n    }\r\n\r\n    // Try to find match\r\n    let match = dataSource.find(item => item.code.toUpperCase() === searchTerm);\r\n\r\n    if (!match) {\r\n      match = dataSource.find(item => item.name.toUpperCase() === searchTerm);\r\n    }\r\n\r\n    if (!match) {\r\n      // Check if code is inside name brackets\r\n      match = dataSource.find(item => {\r\n        const codeMatch = item.name.match(/\\[([^\\]]+)\\]$/);\r\n        return codeMatch && codeMatch[1].toUpperCase() === searchTerm;\r\n      });\r\n    }\r\n\r\n    if (!match) {\r\n      // Partial match\r\n      match = dataSource.find(item =>\r\n        item.name.toUpperCase().includes(searchTerm) ||\r\n        item.code.toUpperCase().includes(searchTerm)\r\n      );\r\n    }\r\n\r\n    if (match) {\r\n      console.log(`‚úÖ Normalized ${fieldName}: \"${value}\" -> \"${match.name}\"`);\r\n      return match.name;\r\n    }\r\n\r\n    console.warn(`‚ö†Ô∏è Could not normalize ${fieldName}: \"${value}\"`);\r\n    return value;\r\n  };\r\n\r\n  // Solo incluir campos que realmente usamos en el RPA\r\n  const confirmedData = {\r\n    // Campos usados en RPA\r\n    reservationType: normalizeFieldValue(\r\n      getFieldValue('input-reservation-type', 'input-reservation-type-value'),\r\n      masterData.reservationTypes,\r\n      'reservationType'\r\n    ),\r\n    status: normalizeFieldValue(\r\n      getFieldValue('input-status', 'input-status-value'),\r\n      masterData.statuses,\r\n      'status'\r\n    ),\r\n    client: normalizeFieldValue(\r\n      getFieldValue('input-client', 'input-client-value'),\r\n      masterData.clients,\r\n      'client'\r\n    ),\r\n    travelDate: (document.getElementById('input-travel-date') as HTMLInputElement).value || null,\r\n    seller: normalizeFieldValue(\r\n      getFieldValue('input-seller', 'input-seller-value'),\r\n      masterData.sellers,\r\n      'seller'\r\n    ),\r\n    passengers: getPassengersFromInputs()\r\n  };\r\n\r\n  console.log('üìã Confirmed data:', confirmedData);\r\n\r\n  // Update confirm button to show loading\r\n  const confirmButton = document.getElementById('confirm-button') as HTMLButtonElement;\r\n  const originalHTML = confirmButton.innerHTML;\r\n\r\n  confirmButton.innerHTML = '<span class=\"button-icon\">ü§ñ</span><span>Procesando RPA...</span>';\r\n  confirmButton.disabled = true;\r\n\r\n  try {\r\n    // Llamar directamente al servicio RPA para crear la reserva\r\n    console.log('üöÄ Calling RPA service to create reservation...');\r\n    const rpaResult = await rpaService.createReservation(confirmedData as ReservationData);\r\n\r\n    console.log('‚úÖ RPA Result:', rpaResult);\r\n\r\n    // Success\r\n    confirmButton.innerHTML = '<span class=\"button-icon\">‚úÖ</span><span>¬°Procesado!</span>';\r\n    confirmButton.style.background = '#107c10';\r\n    showSuccessMessage(`‚úÖ Reserva creada exitosamente en iTraffic: ${rpaResult.message}`);\r\n\r\n    // Reset UI after success\r\n    setTimeout(() => {\r\n      // Hide results\r\n      document.getElementById('extraction-results')!.style.display = 'none';\r\n      // Show header again\r\n      const header = document.getElementById('collapsible-header');\r\n      const btn = document.getElementById('toggle-header-btn');\r\n      if (header && btn) {\r\n        header.style.display = 'block';\r\n        btn.textContent = 'üîº';\r\n      }\r\n      // Clear data\r\n      extractionState.data = null;\r\n      extractionState.hasExtracted = false;\r\n    }, 2000);\r\n\r\n    // Reset button after 5 seconds\r\n    setTimeout(() => {\r\n      confirmButton.innerHTML = originalHTML;\r\n      confirmButton.disabled = false;\r\n      confirmButton.style.background = '';\r\n    }, 5000);\r\n\r\n  } catch (error: any) {\r\n    console.error('‚ùå Error creating reservation via RPA:', error);\r\n\r\n    // Reset button\r\n    confirmButton.innerHTML = originalHTML;\r\n    confirmButton.disabled = false;\r\n\r\n    // Mostrar error m√°s descriptivo\r\n    let errorMessage = 'Error al crear la reserva en iTraffic';\r\n    if (error.message) {\r\n      errorMessage += ': ' + error.message;\r\n    }\r\n    \r\n    showError(errorMessage);\r\n  }\r\n}\r\n\r\n/**\r\n * Export for testing (if needed)\r\n */\r\n(window as any).EmailClassifier = {\r\n  getAccessToken,\r\n  handleRegister,\r\n  checkRegistrationStatus,\r\n};\r\n"],"names":["isDevelopment","window","location","hostname","PROD_BACKEND","config","apiBaseUrl","dialogBaseUrl","environment","version","console","log","rpaService","constructor","timeout","this","baseUrl","healthCheck","response","fetchWithTimeout","method","headers","ok","Error","status","statusText","data","json","error","message","getStatus","createReservation","reservationData","rpaRequest","passengers","map","p","lastName","firstName","paxType","birthDate","formatDateForRPA","nationality","sex","documentNumber","documentType","cuilCuit","direccion","reservationType","client","travelDate","seller","body","JSON","stringify","rawText","text","result","parse","success","timestamp","Date","toISOString","parseError","substring","name","testConnection","source","details","url","options","controller","AbortController","timeoutId","setTimeout","abort","fetch","signal","clearTimeout","dateString","date","includes","parts","split","length","parseInt","isNaN","getTime","warn","month","String","getMonth","padStart","formatted","getDate","getFullYear","state","isRegistered","userId","email","isLoading","isAuthInProgress","authRetryCount","lastAuthAttempt","activeDialog","extractionState","isExtracting","hasExtracted","isEditing","masterData","sellers","clients","contacts","currencies","statuses","reservationTypes","genders","documentTypes","countries","loaded","showFieldLoader","field","show","loader","document","getElementById","classList","add","remove","hideAllFieldLoaders","enableMasterDataFields","sellerInput","clientInput","contactInput","currencyInput","statusInput","reservationTypeInput","disabled","placeholder","setupSearchableDropdownLazyNameOnly","input","dropdown","hiddenInput","items","highlightedIndex","filteredItems","renderedCount","renderDropdown","filter","loadMore","searchTerm","toLowerCase","trim","item","code","innerHTML","startIndex","endIndex","Math","min","i","div","createElement","className","dataset","value","index","toString","textContent","addEventListener","selectItem","appendChild","existingMore","querySelector","moreDiv","showDropdown","hideDropdown","updateHighlight","visibleItems","querySelectorAll","forEach","toggle","scrollIntoView","block","scrollTop","clientHeight","scrollHeight","e","key","preventDefault","contains","max","target","setupSearchableDropdownForClients","displayName","displayValue","toggleHeader","header","btn","style","display","getCurrentUserEmail","userProfile","Office","context","mailbox","emailAddress","async","checkRegistrationStatus","currentEmail","cachedUserId","localStorage","getItem","cachedEmail","removeItem","user","updateUIForRegisteredUser","handleRegister","showError","now","setLoading","currentOutlookEmail","forceConsent","dialogResult","getAccessTokenViaDialog","hasCode","authorizationCode","hasToken","token","redeemResponse","redirectUri","errorData","catch","requiresInteractiveAuth","redeemData","id","backendEmail","persistUserSession","stats","successMessage","hasRefreshToken","showSuccessMessage","completeRegistrationWithAuthorizationCode","messageData","registerResponse","accessToken","refreshToken","expiresOn","completeLegacyRegistration","handleRegisterViaDialog","userMessage","handleRegistrationError","setItem","settings","roamingSettings","set","Promise","resolve","saveAsync","AsyncResultStatus","Succeeded","handleLogout","statusBox","logoutUrl","encodeURIComponent","origin","ui","displayDialogAsync","height","width","promptBeforeOpen","dialog","close","closeActiveDialog","reject","params","URLSearchParams","queryString","dialogUrl","displayInIframe","Failed","dialogClosed","checkLocalStorageForAuth","stored","checkServerBridgeForAuth","localStorageInterval","setInterval","clearInterval","authData","addEventHandler","EventType","DialogMessageReceived","arg","DialogEventReceived","delayedAuthData","extractionSection","totalClassified","categoriesCount","updateFieldStatus","elementId","element","valToSet","normalizeText","normalize","replace","toUpperCase","tagName","dataSource","match","find","codeMatch","nameWithoutCode","candidates","normalizedName","sort","a","b","aName","bName","aContains","bContains","some","part","currencyAliases","currencyName","aliases","Object","entries","alias","select","exists","option","errorSection","background","borderColor","loading","button","showHelp","event","handleExtractReservation","emailContent","getAsync","CoercionType","Text","bodyContent","subject","fullContent","from","getEmailConversationContent","conversationId","confidenceBadge","confidenceText","confidencePercent","round","confidence","displayPassengers","today","checkIn","displayExtractionResults","passengersList","push","genderOptions","g","join","docTypeOptions","dt","nationalityOptions","c","passenger","card","setAttribute","currentSex","currentDocType","currentNationality","phoneNumber","current","getAttribute","addBtn","onclick","currentData","getPassengersFromInputs","parentNode","idx","splice","handleReanalyze","handleConfirmReservation","getFieldValue","inputId","hiddenId","normalizeFieldValue","fieldName","confirmedData","confirmButton","originalHTML","rpaResult","errorMessage","onReady","info","host","HostType","Outlook","displayField","slice","setupSearchableDropdown","populateSellerDropdown","populateClientDatalist","populateContactDropdown","reverseAliases","mainName","aliasList","searchTermUpper","resolvedTerm","nameMatch","aliasMatch","setupSearchableDropdownWithAliases","dolares","populateCurrencyDropdown","confirmacion","s","populateStatusDropdown","populateReservationTypeDropdown","loadMasterData","testRPAConnection","initializeApp","EmailClassifier","getAccessToken","allowPrompt","allowSignInPrompt","allowConsentPrompt","forMSGraphAccess","auth"],"ignoreList":[],"sourceRoot":""}