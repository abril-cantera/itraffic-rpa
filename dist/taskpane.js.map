{"version":3,"file":"taskpane.js","mappings":"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","sources":["webpack://outlook-email-classifier-addin/./src/config/config.ts","webpack://outlook-email-classifier-addin/./src/services/rpaService.ts","webpack://outlook-email-classifier-addin/./src/taskpane/taskpane.ts"],"sourcesContent":["/**\n * Configuration for Outlook Add-in\n */\n\ninterface Config {\n  apiBaseUrl: string;\n  dialogBaseUrl: string; // For Office dialogs (MUST be HTTPS)\n  environment: 'development' | 'production';\n  version: string;\n}\n\n// Determine environment based on hostname\nconst isDevelopment = window.location.hostname === 'localhost';\n\n// Backend URLs\nconst LOCAL_BACKEND = 'http://localhost:7071';\nconst PROD_BACKEND = 'https://happy-flower-09b6bd81e.4.azurestaticapps.net';\n\nexport const config: Config = {\n  // Local development uses local backend for API calls\n  apiBaseUrl: isDevelopment ? LOCAL_BACKEND : PROD_BACKEND,\n  // Office dialogs REQUIRE HTTPS - always use production for dialogs\n  dialogBaseUrl: PROD_BACKEND,\n  environment: isDevelopment ? 'development' : 'production',\n  version: '1.0.0',\n};\n\n// Log configuration on load\nconsole.log('üìù Add-in Configuration:', {\n  environment: config.environment,\n  apiBaseUrl: config.apiBaseUrl,\n  dialogBaseUrl: config.dialogBaseUrl,\n  version: config.version,\n});\n","/**\n * RPA Service\n * Handles communication with the iTraffic RPA Backend\n */\n\nimport { config } from '../config/config';\nimport type { ReservationData } from '../types/reservation';\n\n// ============================================================================\n// Types\n// ============================================================================\n\ninterface RPAReservationRequest {\n  reservationData: {\n    passengers: Array<{\n      lastName: string;\n      firstName: string;\n      paxType: string;           // \"ADU\", \"CHD\", \"INF\"\n      birthDate: string;         // Formato: MM/DD/AAAA\n      nationality: string;       // Ej: \"ARGENTINA\"\n      sex: string;               // \"M\" o \"F\"\n      documentNumber: string;\n      documentType: string;      // Ej: \"DNI\", \"PASSPORT\"\n      cuilCuit: string;\n      direccion: string;\n    }>;\n    reservationType: string;     // Ej: \"AGENCIAS [COAG]\"\n    status: string;              // Ej: \"PENDIENTE DE CONFIRMACION [PC]\"\n    client: string;              // Ej: \"DESPEGAR - TEST - 1\"\n    travelDate: string;          // Formato: MM/DD/AAAA\n    seller: string;              // Ej: \"TEST TEST\"\n  };\n}\n\ninterface RPAReservationResponse {\n  success: boolean;\n  message: string;\n  data?: any;\n  timestamp: string;\n}\n\ninterface RPAStatusResponse {\n  success: boolean;\n  status: string;\n  message: string;\n  timestamp: string;\n}\n\ninterface RPAHealthResponse {\n  status: string;\n  timestamp: string;\n  uptime: number;\n}\n\n// ============================================================================\n// RPA Service Class\n// ============================================================================\n\nclass RPAService {\n  private readonly baseUrl: string;\n  private readonly timeout: number = 60000; // 60 segundos para operaciones RPA\n\n  constructor() {\n    this.baseUrl = config.apiBaseUrl;\n    console.log('ü§ñ RPA Service initialized with base URL:', this.baseUrl);\n  }\n\n  /**\n   * Health check del servicio RPA\n   */\n  async healthCheck(): Promise<RPAHealthResponse> {\n    console.log('üè• Checking RPA health...');\n    \n    try {\n      const response = await this.fetchWithTimeout(`${this.baseUrl}/health`, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, 10000); // 10 segundos para health check\n\n      if (!response.ok) {\n        throw new Error(`Health check failed: ${response.status} ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      console.log('‚úÖ RPA health check successful:', data);\n      return data;\n    } catch (error: any) {\n      console.error('‚ùå RPA health check failed:', error);\n      throw new Error(`Health check failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * Obtener estado del servicio RPA\n   */\n  async getStatus(): Promise<RPAStatusResponse> {\n    console.log('üìä Getting RPA status...');\n    \n    try {\n      const response = await this.fetchWithTimeout(`${this.baseUrl}/api/status`, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, 10000);\n\n      if (!response.ok) {\n        throw new Error(`Status check failed: ${response.status} ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      console.log('‚úÖ RPA status retrieved:', data);\n      return data;\n    } catch (error: any) {\n      console.error('‚ùå RPA status check failed:', error);\n      throw new Error(`Status check failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * Crear reserva en iTraffic mediante RPA\n   */\n  async createReservation(reservationData: ReservationData): Promise<RPAReservationResponse> {\n    console.log('ü§ñ Creating reservation via RPA...');\n    console.log('üìã Reservation data:', reservationData);\n\n    try {\n      // Transformar datos al formato esperado por el RPA\n      const rpaRequest: RPAReservationRequest = {\n        reservationData: {\n          passengers: reservationData.passengers.map(p => ({\n            lastName: p.lastName || '',\n            firstName: p.firstName || '',\n            paxType: p.paxType || 'ADU',\n            birthDate: this.formatDateForRPA(p.birthDate),\n            nationality: p.nationality || '',\n            sex: p.sex || 'M',\n            documentNumber: p.documentNumber || '',\n            documentType: p.documentType || 'DNI',\n            cuilCuit: p.cuilCuit || '',\n            direccion: p.direccion || ''\n          })),\n          reservationType: reservationData.reservationType || '',\n          status: reservationData.status || '',\n          client: reservationData.client || '',\n          travelDate: this.formatDateForRPA(reservationData.travelDate),\n          seller: reservationData.seller || ''\n        }\n      };\n\n      console.log('üì§ Sending to RPA:', rpaRequest);\n\n      const response = await this.fetchWithTimeout(`${this.baseUrl}/api/reservations`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(rpaRequest)\n      }, this.timeout);\n\n      const rawText = await response.text();\n      console.log('üì• RPA raw response:', rawText);\n\n      let result: RPAReservationResponse;\n      try {\n        result = rawText ? JSON.parse(rawText) : { success: false, message: 'Empty response', timestamp: new Date().toISOString() };\n      } catch (parseError) {\n        console.error('‚ùå Failed to parse RPA response:', parseError);\n        throw new Error(`Invalid response format: ${rawText.substring(0, 100)}`);\n      }\n\n      if (!response.ok) {\n        console.error('‚ùå RPA request failed:', response.status, result);\n        throw new Error(result.message || `RPA request failed: ${response.status}`);\n      }\n\n      if (!result.success) {\n        console.error('‚ùå RPA operation failed:', result);\n        throw new Error(result.message || 'RPA operation failed');\n      }\n\n      console.log('‚úÖ Reservation created successfully:', result);\n      return result;\n    } catch (error: any) {\n      console.error('‚ùå Create reservation failed:', error);\n      \n      // Proporcionar mensajes de error m√°s descriptivos\n      if (error.name === 'AbortError') {\n        throw new Error('La operaci√≥n tard√≥ demasiado tiempo (timeout de 60s). El RPA puede estar procesando la reserva.');\n      }\n      \n      throw new Error(error.message || 'Failed to create reservation');\n    }\n  }\n\n  /**\n   * Test de conexi√≥n con el backend RPA\n   */\n  async testConnection(): Promise<{ success: boolean; message: string; details?: any }> {\n    console.log('üîå Testing RPA connection...');\n    \n    try {\n      const response = await this.fetchWithTimeout(`${this.baseUrl}/api/test-connection`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          timestamp: new Date().toISOString(),\n          source: 'outlook-addin'\n        })\n      }, 10000);\n\n      if (!response.ok) {\n        return {\n          success: false,\n          message: `Connection test failed: ${response.status} ${response.statusText}`\n        };\n      }\n\n      const data = await response.json();\n      console.log('‚úÖ Connection test successful:', data);\n      \n      return {\n        success: true,\n        message: 'Connection successful',\n        details: data\n      };\n    } catch (error: any) {\n      console.error('‚ùå Connection test failed:', error);\n      return {\n        success: false,\n        message: `Connection failed: ${error.message}`\n      };\n    }\n  }\n\n  // ============================================================================\n  // Helper Methods\n  // ============================================================================\n\n  /**\n   * Fetch con timeout\n   */\n  private async fetchWithTimeout(url: string, options: RequestInit, timeout: number): Promise<Response> {\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), timeout);\n\n    try {\n      const response = await fetch(url, {\n        ...options,\n        signal: controller.signal\n      });\n      clearTimeout(timeoutId);\n      return response;\n    } catch (error: any) {\n      clearTimeout(timeoutId);\n      if (error.name === 'AbortError') {\n        throw new Error(`Request timeout after ${timeout}ms`);\n      }\n      throw error;\n    }\n  }\n\n  /**\n   * Formatear fecha para el RPA (MM/DD/AAAA)\n   * Acepta varios formatos de entrada y convierte a MM/DD/AAAA\n   */\n  private formatDateForRPA(dateString: string | null): string {\n    if (!dateString) return '';\n\n    try {\n      // Intentar parsear diferentes formatos\n      let date: Date | null = null;\n\n      // Formato ISO (YYYY-MM-DD o YYYY-MM-DDTHH:mm:ss)\n      if (dateString.includes('-')) {\n        date = new Date(dateString);\n      }\n      // Formato DD/MM/AAAA o MM/DD/AAAA\n      else if (dateString.includes('/')) {\n        const parts = dateString.split('/');\n        if (parts.length === 3) {\n          // Asumimos DD/MM/AAAA si el primer n√∫mero es > 12\n          if (parseInt(parts[0]) > 12) {\n            // DD/MM/AAAA -> MM/DD/AAAA\n            date = new Date(`${parts[1]}/${parts[0]}/${parts[2]}`);\n          } else {\n            // Ya est√° en MM/DD/AAAA o ambiguo\n            date = new Date(dateString);\n          }\n        }\n      }\n\n      if (!date || isNaN(date.getTime())) {\n        console.warn('‚ö†Ô∏è Invalid date format:', dateString);\n        return dateString; // Retornar original si no se puede parsear\n      }\n\n      // Formatear a MM/DD/AAAA\n      const month = String(date.getMonth() + 1).padStart(2, '0');\n      const day = String(date.getDate()).padStart(2, '0');\n      const year = date.getFullYear();\n\n      const formatted = `${month}/${day}/${year}`;\n      console.log(`üìÖ Date formatted: ${dateString} -> ${formatted}`);\n      return formatted;\n    } catch (error) {\n      console.error('‚ùå Error formatting date:', error);\n      return dateString; // Retornar original en caso de error\n    }\n  }\n}\n\n// ============================================================================\n// Export Singleton\n// ============================================================================\n\nexport const rpaService = new RPAService();\n\n","/**\n * Email Classifier - Outlook Add-in\n * Main taskpane logic with SSO authentication\n */\n\nimport { config } from '../config/config';\nimport { rpaService } from '../services/rpaService';\nimport type { ReservationData, ExtractionApiResponse, ExtractionApiError, ExtractionState } from '../types/reservation';\n\n// Application state\ninterface AppState {\n  isRegistered: boolean;\n  userId: string | null;\n  email: string | null;\n  isLoading: boolean;\n  error: string | null;\n  isAuthInProgress: boolean;\n  authRetryCount: number;\n  lastAuthAttempt: number | null;\n}\n\nconst state: AppState = {\n  isRegistered: false,\n  userId: null,\n  email: null,\n  isLoading: false,\n  error: null,\n  isAuthInProgress: false,\n  authRetryCount: 0,\n  lastAuthAttempt: null,\n};\n\n// Global dialog reference to prevent multiple dialogs\nlet activeDialog: Office.Dialog | null = null;\n\n/**\n * Close any active dialog before opening a new one\n */\nfunction closeActiveDialog(): void {\n  if (activeDialog) {\n    try {\n      console.log('Closing existing dialog...');\n      activeDialog.close();\n    } catch (e) {\n      console.log('Dialog already closed or invalid');\n    }\n    activeDialog = null;\n  }\n}\n\n// Extraction state\nconst extractionState: ExtractionState = {\n  isExtracting: false,\n  hasExtracted: false,\n  data: null,\n  error: null,\n  isEditing: false,\n};\n\n// Master data state\ninterface MasterData {\n  sellers: Array<{ code: string; name: string }>;\n  clients: Array<{ code: string; name: string; displayName?: string; cuit?: string }>;\n  contacts: Array<{ code: string; name: string; displayName?: string; email?: string; phone?: string }>;\n  currencies: Array<{ code: string; name: string }>;\n  statuses: Array<{ code: string; name: string }>;\n  reservationTypes: Array<{ code: string; name: string }>;\n  genders: Array<{ code: string; name: string }>;\n  documentTypes: Array<{ code: string; name: string }>;\n  countries: Array<{ code: string; name: string; fiscalCode?: string }>;\n  loaded: boolean;\n}\n\nconst masterData: MasterData = {\n  sellers: [],\n  clients: [],\n  contacts: [],\n  currencies: [],\n  statuses: [],\n  reservationTypes: [],\n  genders: [],\n  documentTypes: [],\n  countries: [],\n  loaded: false,\n};\n\n/**\n * Office.js initialization\n */\nOffice.onReady((info) => {\n  if (info.host === Office.HostType.Outlook) {\n    console.log('üìß Email Classifier Add-in loaded');\n    console.log('üîÑ VERSION: 2024-11-06-15:15 - SSO DISABLED - DIALOG ONLY');\n    console.log('üöÄ Build timestamp:', new Date().toISOString());\n    initializeApp();\n  }\n});\n\n/**\n * Initialize the application\n */\nasync function initializeApp(): Promise<void> {\n  // Keep loading visible while checking registration\n  // Don't hide it yet - let checkRegistrationStatus do it\n\n  // Setup event listeners\n  document.getElementById('register-button')!.addEventListener('click', handleRegister);\n  document.getElementById('retry-button')!.addEventListener('click', handleRegister);\n  document.getElementById('logout-button')!.addEventListener('click', handleLogout);\n  document.getElementById('help-link')!.addEventListener('click', showHelp);\n\n  // Extraction event listeners\n  document.getElementById('extract-button')!.addEventListener('click', handleExtractReservation);\n  document.getElementById('reanalyze-button')!.addEventListener('click', handleReanalyze);\n  document.getElementById('confirm-button')!.addEventListener('click', handleConfirmReservation);\n  document.getElementById('retry-extraction-button')!.addEventListener('click', handleExtractReservation);\n\n  // Header toggle\n  document.getElementById('toggle-header-btn')!.addEventListener('click', toggleHeader);\n\n  // Load master data for dropdowns (in parallel with registration check)\n  loadMasterData();\n\n  // Test RPA connection\n  testRPAConnection();\n\n  // Check if user is already registered (this will hide loading when done)\n  await checkRegistrationStatus();\n}\n\n/**\n * Load master data from API (sellers, clients, currencies, statuses, reservationTypes)\n */\nasync function loadMasterData(): Promise<void> {\n  console.log('üìã Loading master data...');\n\n  // Show loaders\n  showFieldLoader('seller', true);\n  showFieldLoader('client', true);\n  showFieldLoader('contact', true);\n  showFieldLoader('currency', true);\n  showFieldLoader('status', true);\n  showFieldLoader('reservation-type', true);\n\n  try {\n    const response = await fetch(`${config.apiBaseUrl}/api/master-data`, {\n      method: 'GET',\n      headers: { 'Content-Type': 'application/json' }\n    });\n\n    if (!response.ok) {\n      console.warn('‚ö†Ô∏è Could not load master data, using defaults');\n      hideAllFieldLoaders();\n      enableMasterDataFields();\n      return;\n    }\n\n    const result = await response.json();\n\n    if (result.success && result.data) {\n      masterData.sellers = result.data.sellers || [];\n      masterData.clients = result.data.clients || [];\n      masterData.contacts = result.data.contacts || [];\n      masterData.currencies = result.data.currencies || [];\n      masterData.statuses = result.data.statuses || [];\n      masterData.reservationTypes = result.data.reservationTypes || [];\n      masterData.genders = result.data.genders || [];\n      masterData.documentTypes = result.data.documentTypes || [];\n      masterData.countries = result.data.countries || [];\n      masterData.loaded = true;\n\n      console.log('‚úÖ Master data loaded:', {\n        sellers: masterData.sellers.length,\n        clients: masterData.clients.length,\n        contacts: masterData.contacts.length,\n        currencies: masterData.currencies.length,\n        statuses: masterData.statuses.length,\n        reservationTypes: masterData.reservationTypes.length,\n        genders: masterData.genders.length,\n        documentTypes: masterData.documentTypes.length,\n        countries: masterData.countries.length\n      });\n\n      // Populate dropdowns\n      populateSellerDropdown();\n      populateClientDatalist();\n      populateContactDropdown();\n      populateCurrencyDropdown();\n      populateStatusDropdown();\n      populateReservationTypeDropdown();\n    }\n  } catch (error) {\n    console.error('‚ùå Error loading master data:', error);\n    hideAllFieldLoaders();\n    enableMasterDataFields();\n  }\n}\n\n/**\n * Show/hide field loader\n */\nfunction showFieldLoader(field: 'seller' | 'client' | 'contact' | 'currency' | 'status' | 'reservation-type', show: boolean): void {\n  const loader = document.getElementById(`${field}-loader`);\n  if (loader) {\n    if (show) {\n      loader.classList.add('active');\n    } else {\n      loader.classList.remove('active');\n    }\n  }\n}\n\n/**\n * Hide all field loaders\n */\nfunction hideAllFieldLoaders(): void {\n  showFieldLoader('seller', false);\n  showFieldLoader('client', false);\n  showFieldLoader('contact', false);\n  showFieldLoader('currency', false);\n  showFieldLoader('status', false);\n  showFieldLoader('reservation-type', false);\n}\n\n/**\n * Enable master data fields after loading\n */\nfunction enableMasterDataFields(): void {\n  const sellerInput = document.getElementById('input-seller') as HTMLInputElement;\n  const clientInput = document.getElementById('input-client') as HTMLInputElement;\n  const contactInput = document.getElementById('input-contact') as HTMLInputElement;\n  const currencyInput = document.getElementById('input-currency') as HTMLInputElement;\n  const statusInput = document.getElementById('input-status') as HTMLInputElement;\n  const reservationTypeInput = document.getElementById('input-reservation-type') as HTMLInputElement;\n\n  if (sellerInput) {\n    sellerInput.disabled = false;\n    sellerInput.placeholder = 'Buscar vendedor...';\n  }\n  if (clientInput) {\n    clientInput.disabled = false;\n    clientInput.placeholder = 'Buscar cliente...';\n  }\n  if (contactInput) {\n    contactInput.disabled = false;\n    contactInput.placeholder = 'Buscar contacto...';\n  }\n  if (currencyInput) {\n    currencyInput.disabled = false;\n    currencyInput.placeholder = 'Buscar moneda...';\n  }\n  if (statusInput) {\n    statusInput.disabled = false;\n    statusInput.placeholder = 'Buscar estado...';\n  }\n  if (reservationTypeInput) {\n    reservationTypeInput.disabled = false;\n    reservationTypeInput.placeholder = 'Buscar tipo...';\n  }\n}\n\n/**\n * Populate seller dropdown with master data (searchable)\n */\nfunction populateSellerDropdown(): void {\n  const input = document.getElementById('input-seller') as HTMLInputElement;\n  const dropdown = document.getElementById('seller-dropdown') as HTMLDivElement;\n  const hiddenInput = document.getElementById('input-seller-value') as HTMLInputElement;\n\n  if (!input || !dropdown) return;\n\n  // Enable input\n  input.disabled = false;\n  input.placeholder = 'Buscar vendedor...';\n  showFieldLoader('seller', false);\n\n  // Setup searchable dropdown\n  setupSearchableDropdown(input, dropdown, hiddenInput, masterData.sellers, 'name');\n\n  console.log(`üìã Seller searchable dropdown ready with ${masterData.sellers.length} options`);\n}\n\n/**\n * Populate client dropdown with master data (searchable with lazy loading)\n * Shows full format like iTraffic: \"CODE - NAME - Cuit:XXX\"\n */\nfunction populateClientDatalist(): void {\n  const input = document.getElementById('input-client') as HTMLInputElement;\n  const dropdown = document.getElementById('client-dropdown') as HTMLDivElement;\n  const hiddenInput = document.getElementById('input-client-value') as HTMLInputElement;\n\n  if (!input || !dropdown) return;\n\n  // Enable input\n  input.disabled = false;\n  input.placeholder = 'Buscar cliente...';\n  showFieldLoader('client', false);\n\n  // Setup searchable dropdown with lazy loading - shows displayName if available\n  setupSearchableDropdownForClients(input, dropdown, hiddenInput, masterData.clients);\n\n  console.log(`üìã Client searchable dropdown ready with ${masterData.clients.length} options (lazy loading)`);\n}\n\n/**\n * Populate contact dropdown with master data (separate contacts list)\n * Shows format: \"CODE - NAME\"\n * Field starts empty - user must select a contact\n */\nfunction populateContactDropdown(): void {\n  const input = document.getElementById('input-contact') as HTMLInputElement;\n  const dropdown = document.getElementById('contact-dropdown') as HTMLDivElement;\n  const hiddenInput = document.getElementById('input-contact-value') as HTMLInputElement;\n\n  if (!input || !dropdown) return;\n\n  // Enable input\n  input.disabled = false;\n  input.placeholder = 'Buscar contacto...';\n  showFieldLoader('contact', false);\n\n  // Setup searchable dropdown with lazy loading - uses contacts list\n  setupSearchableDropdownForClients(input, dropdown, hiddenInput, masterData.contacts);\n\n  // Leave empty by default - user must select\n  input.value = '';\n  if (hiddenInput) hiddenInput.value = '';\n\n  console.log(`üìã Contact searchable dropdown ready with ${masterData.contacts.length} options (lazy loading)`);\n}\n\n/**\n * Populate currency dropdown with master data (searchable with aliases)\n */\nfunction populateCurrencyDropdown(): void {\n  const input = document.getElementById('input-currency') as HTMLInputElement;\n  const dropdown = document.getElementById('currency-dropdown') as HTMLDivElement;\n  const hiddenInput = document.getElementById('input-currency-value') as HTMLInputElement;\n\n  if (!input || !dropdown) return;\n\n  // Enable input\n  input.disabled = false;\n  input.placeholder = 'Buscar moneda...';\n  showFieldLoader('currency', false);\n\n  // Currency aliases for common abbreviations\n  const currencyAliases: Record<string, string[]> = {\n    'DOLARES': ['USD', 'DOLAR', 'US$', 'U$S', 'DOLLAR'],\n    'PESOS': ['ARS', 'PESO', '$', 'AR$', 'PESOS ARGENTINOS'],\n    'EUROS': ['EUR', 'EURO', '‚Ç¨'],\n    'REALES': ['BRL', 'REAL', 'R$', 'REAIS'],\n  };\n\n  // Setup searchable dropdown with alias support\n  setupSearchableDropdownWithAliases(input, dropdown, hiddenInput, masterData.currencies, currencyAliases);\n\n  // Set default value to DOLARES if exists\n  const dolares = masterData.currencies.find(c => c.name.toUpperCase().includes('DOLAR'));\n  if (dolares) {\n    input.value = dolares.name;\n    if (hiddenInput) hiddenInput.value = dolares.name;\n  } else if (masterData.currencies.length > 0) {\n    input.value = masterData.currencies[0].name;\n    if (hiddenInput) hiddenInput.value = masterData.currencies[0].name;\n  }\n\n  console.log(`üìã Currency searchable dropdown ready with ${masterData.currencies.length} options`);\n}\n\n/**\n * Populate status dropdown with master data (searchable with lazy loading)\n * Shows only name (no code)\n */\nfunction populateStatusDropdown(): void {\n  const input = document.getElementById('input-status') as HTMLInputElement;\n  const dropdown = document.getElementById('status-dropdown') as HTMLDivElement;\n  const hiddenInput = document.getElementById('input-status-value') as HTMLInputElement;\n\n  if (!input || !dropdown) return;\n\n  // Enable input\n  input.disabled = false;\n  input.placeholder = 'Buscar estado...';\n  showFieldLoader('status', false);\n\n  // Setup searchable dropdown with lazy loading - name only display\n  setupSearchableDropdownLazyNameOnly(input, dropdown, hiddenInput, masterData.statuses);\n\n  // Set default value to CONFIRMACION if exists\n  const confirmacion = masterData.statuses.find(s => s.code === 'FI');\n  if (confirmacion) {\n    input.value = confirmacion.name;\n    if (hiddenInput) hiddenInput.value = confirmacion.code;\n  }\n\n  console.log(`üìã Status searchable dropdown ready with ${masterData.statuses.length} options`);\n}\n\n/**\n * Populate reservation type dropdown with master data (searchable with lazy loading)\n * Shows only name (no code)\n */\nfunction populateReservationTypeDropdown(): void {\n  const input = document.getElementById('input-reservation-type') as HTMLInputElement;\n  const dropdown = document.getElementById('reservation-type-dropdown') as HTMLDivElement;\n  const hiddenInput = document.getElementById('input-reservation-type-value') as HTMLInputElement;\n\n  if (!input || !dropdown) return;\n\n  // Enable input\n  input.disabled = false;\n  input.placeholder = 'Buscar tipo...';\n  showFieldLoader('reservation-type', false);\n\n  // Setup searchable dropdown with lazy loading - name only display\n  setupSearchableDropdownLazyNameOnly(input, dropdown, hiddenInput, masterData.reservationTypes);\n\n  console.log(`üìã Reservation type searchable dropdown ready with ${masterData.reservationTypes.length} options`);\n}\n\n/**\n * Setup a searchable dropdown component\n */\nfunction setupSearchableDropdown(\n  input: HTMLInputElement,\n  dropdown: HTMLDivElement,\n  hiddenInput: HTMLInputElement | null,\n  items: Array<{ code: string; name: string }>,\n  displayField: 'name' | 'code'\n): void {\n  let highlightedIndex = -1;\n  let filteredItems = [...items];\n\n  // Render dropdown items\n  function renderDropdown(filter: string = ''): void {\n    const searchTerm = filter.toLowerCase();\n    filteredItems = items.filter(item =>\n      item.name.toLowerCase().includes(searchTerm) ||\n      item.code.toLowerCase().includes(searchTerm)\n    );\n\n    dropdown.innerHTML = '';\n\n    if (filteredItems.length === 0) {\n      dropdown.innerHTML = '<div class=\"dropdown-empty\">No se encontraron resultados</div>';\n      return;\n    }\n\n    // Limit to 50 items for performance\n    const displayItems = filteredItems.slice(0, 50);\n\n    displayItems.forEach((item, index) => {\n      const div = document.createElement('div');\n      div.className = 'dropdown-item';\n      div.dataset.value = item[displayField];\n      div.dataset.index = index.toString();\n      div.textContent = item.name;\n\n      div.addEventListener('click', () => {\n        selectItem(item);\n      });\n\n      dropdown.appendChild(div);\n    });\n\n    if (filteredItems.length > 50) {\n      const moreDiv = document.createElement('div');\n      moreDiv.className = 'dropdown-empty';\n      moreDiv.textContent = `... y ${filteredItems.length - 50} m√°s. Escribe para filtrar.`;\n      dropdown.appendChild(moreDiv);\n    }\n  }\n\n  // Select an item\n  function selectItem(item: { code: string; name: string }): void {\n    input.value = item.name;\n    if (hiddenInput) hiddenInput.value = item[displayField];\n    dropdown.classList.remove('active');\n    highlightedIndex = -1;\n  }\n\n  // Show dropdown\n  function showDropdown(): void {\n    renderDropdown(input.value);\n    dropdown.classList.add('active');\n  }\n\n  // Hide dropdown\n  function hideDropdown(): void {\n    dropdown.classList.remove('active');\n    highlightedIndex = -1;\n  }\n\n  // Update highlight\n  function updateHighlight(): void {\n    const items = dropdown.querySelectorAll('.dropdown-item');\n    items.forEach((item, index) => {\n      item.classList.toggle('highlighted', index === highlightedIndex);\n    });\n\n    // Scroll into view\n    if (highlightedIndex >= 0 && items[highlightedIndex]) {\n      items[highlightedIndex].scrollIntoView({ block: 'nearest' });\n    }\n  }\n\n  // Event: Focus - show dropdown\n  input.addEventListener('focus', () => {\n    showDropdown();\n  });\n\n  // Event: Input - filter items\n  input.addEventListener('input', () => {\n    renderDropdown(input.value);\n    dropdown.classList.add('active');\n    highlightedIndex = -1;\n  });\n\n  // Event: Keydown - navigation\n  input.addEventListener('keydown', (e) => {\n    const items = dropdown.querySelectorAll('.dropdown-item');\n\n    switch (e.key) {\n      case 'ArrowDown':\n        e.preventDefault();\n        if (!dropdown.classList.contains('active')) {\n          showDropdown();\n        }\n        highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);\n        updateHighlight();\n        break;\n\n      case 'ArrowUp':\n        e.preventDefault();\n        highlightedIndex = Math.max(highlightedIndex - 1, 0);\n        updateHighlight();\n        break;\n\n      case 'Enter':\n        e.preventDefault();\n        if (highlightedIndex >= 0 && filteredItems[highlightedIndex]) {\n          selectItem(filteredItems[highlightedIndex]);\n        }\n        break;\n\n      case 'Escape':\n        hideDropdown();\n        break;\n\n      case 'Tab':\n        hideDropdown();\n        break;\n    }\n  });\n\n  // Event: Click outside - hide dropdown\n  document.addEventListener('click', (e) => {\n    if (!input.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {\n      hideDropdown();\n    }\n  });\n}\n\n/**\n * Setup a searchable dropdown with lazy loading (for large datasets like clients)\n * - Only renders visible items initially\n * - Loads more items as user scrolls\n * - Searches across ALL items when filtering\n */\nfunction setupSearchableDropdownLazy(\n  input: HTMLInputElement,\n  dropdown: HTMLDivElement,\n  hiddenInput: HTMLInputElement | null,\n  items: Array<{ code: string; name: string }>,\n  displayField: 'name' | 'code'\n): void {\n  let highlightedIndex = -1;\n  let filteredItems = [...items];\n  let renderedCount = 0;\n  const BATCH_SIZE = 30; // Items to load per batch\n  const INITIAL_LOAD = 30; // Initial items to show\n\n  // Render dropdown items with lazy loading\n  function renderDropdown(filter: string = '', loadMore: boolean = false): void {\n    const searchTerm = filter.toLowerCase().trim();\n\n    // Filter ALL items (search over complete dataset)\n    if (searchTerm) {\n      filteredItems = items.filter(item =>\n        item.name.toLowerCase().includes(searchTerm) ||\n        item.code.toLowerCase().includes(searchTerm)\n      );\n    } else {\n      filteredItems = [...items];\n    }\n\n    // If not loading more, reset the dropdown\n    if (!loadMore) {\n      dropdown.innerHTML = '';\n      renderedCount = 0;\n    }\n\n    if (filteredItems.length === 0) {\n      dropdown.innerHTML = '<div class=\"dropdown-empty\">No se encontraron resultados</div>';\n      return;\n    }\n\n    // Calculate how many items to render\n    const startIndex = renderedCount;\n    const endIndex = Math.min(startIndex + (loadMore ? BATCH_SIZE : INITIAL_LOAD), filteredItems.length);\n\n    // Render items\n    for (let i = startIndex; i < endIndex; i++) {\n      const item = filteredItems[i];\n      const div = document.createElement('div');\n      div.className = 'dropdown-item';\n      div.dataset.value = item[displayField];\n      div.dataset.index = i.toString();\n      // Show code and name for clients\n      div.textContent = `${item.code} - ${item.name}`;\n\n      div.addEventListener('click', () => {\n        selectItem(item);\n      });\n\n      dropdown.appendChild(div);\n    }\n\n    renderedCount = endIndex;\n\n    // Show \"load more\" indicator if there are more items\n    const existingMore = dropdown.querySelector('.dropdown-more');\n    if (existingMore) existingMore.remove();\n\n    if (renderedCount < filteredItems.length) {\n      const moreDiv = document.createElement('div');\n      moreDiv.className = 'dropdown-empty dropdown-more';\n      moreDiv.textContent = `Mostrando ${renderedCount} de ${filteredItems.length}. Scroll para ver m√°s...`;\n      dropdown.appendChild(moreDiv);\n    }\n  }\n\n  // Select an item\n  function selectItem(item: { code: string; name: string }): void {\n    input.value = `${item.code} - ${item.name}`;\n    if (hiddenInput) hiddenInput.value = item[displayField];\n    dropdown.classList.remove('active');\n    highlightedIndex = -1;\n  }\n\n  // Show dropdown\n  function showDropdown(): void {\n    renderDropdown(input.value);\n    dropdown.classList.add('active');\n  }\n\n  // Hide dropdown\n  function hideDropdown(): void {\n    dropdown.classList.remove('active');\n    highlightedIndex = -1;\n    // Sync hidden input with visible input value when closing without selection\n    if (hiddenInput && input.value) {\n      hiddenInput.value = input.value;\n    }\n  }\n\n  // Update highlight\n  function updateHighlight(): void {\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\n    visibleItems.forEach((item, index) => {\n      item.classList.toggle('highlighted', index === highlightedIndex);\n    });\n\n    // Scroll into view\n    if (highlightedIndex >= 0 && visibleItems[highlightedIndex]) {\n      visibleItems[highlightedIndex].scrollIntoView({ block: 'nearest' });\n    }\n  }\n\n  // Event: Focus - show dropdown\n  input.addEventListener('focus', () => {\n    showDropdown();\n  });\n\n  // Event: Input - filter items (searches ALL items)\n  input.addEventListener('input', () => {\n    renderDropdown(input.value);\n    dropdown.classList.add('active');\n    highlightedIndex = -1;\n  });\n\n  // Event: Scroll - lazy load more items\n  dropdown.addEventListener('scroll', () => {\n    const scrollBottom = dropdown.scrollTop + dropdown.clientHeight;\n    const scrollHeight = dropdown.scrollHeight;\n\n    // Load more when user scrolls near the bottom (within 50px)\n    if (scrollHeight - scrollBottom < 50 && renderedCount < filteredItems.length) {\n      renderDropdown(input.value, true);\n    }\n  });\n\n  // Event: Keydown - navigation\n  input.addEventListener('keydown', (e) => {\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\n\n    switch (e.key) {\n      case 'ArrowDown':\n        e.preventDefault();\n        if (!dropdown.classList.contains('active')) {\n          showDropdown();\n        }\n        highlightedIndex = Math.min(highlightedIndex + 1, visibleItems.length - 1);\n        updateHighlight();\n        break;\n\n      case 'ArrowUp':\n        e.preventDefault();\n        highlightedIndex = Math.max(highlightedIndex - 1, 0);\n        updateHighlight();\n        break;\n\n      case 'Enter':\n        e.preventDefault();\n        if (highlightedIndex >= 0 && highlightedIndex < renderedCount) {\n          selectItem(filteredItems[highlightedIndex]);\n        }\n        break;\n\n      case 'Escape':\n        hideDropdown();\n        break;\n\n      case 'Tab':\n        hideDropdown();\n        break;\n    }\n  });\n\n  // Event: Click outside - hide dropdown\n  document.addEventListener('click', (e) => {\n    if (!input.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {\n      hideDropdown();\n    }\n  });\n}\n\n/**\n * Setup a searchable dropdown with lazy loading - NAME ONLY display (for clients)\n * Shows only the name without the code\n */\nfunction setupSearchableDropdownLazyNameOnly(\n  input: HTMLInputElement,\n  dropdown: HTMLDivElement,\n  hiddenInput: HTMLInputElement | null,\n  items: Array<{ code: string; name: string }>\n): void {\n  let highlightedIndex = -1;\n  let filteredItems = [...items];\n  let renderedCount = 0;\n  const BATCH_SIZE = 30;\n  const INITIAL_LOAD = 30;\n\n  function renderDropdown(filter: string = '', loadMore: boolean = false): void {\n    const searchTerm = filter.toLowerCase().trim();\n\n    if (searchTerm) {\n      filteredItems = items.filter(item =>\n        item.name.toLowerCase().includes(searchTerm) ||\n        item.code.toLowerCase().includes(searchTerm)\n      );\n    } else {\n      filteredItems = [...items];\n    }\n\n    if (!loadMore) {\n      dropdown.innerHTML = '';\n      renderedCount = 0;\n    }\n\n    if (filteredItems.length === 0) {\n      dropdown.innerHTML = '<div class=\"dropdown-empty\">No se encontraron resultados</div>';\n      return;\n    }\n\n    const startIndex = renderedCount;\n    const endIndex = Math.min(startIndex + (loadMore ? BATCH_SIZE : INITIAL_LOAD), filteredItems.length);\n\n    for (let i = startIndex; i < endIndex; i++) {\n      const item = filteredItems[i];\n      const div = document.createElement('div');\n      div.className = 'dropdown-item';\n      div.dataset.value = item.name;\n      div.dataset.index = i.toString();\n      // Show only name (no code)\n      div.textContent = item.name;\n\n      div.addEventListener('click', () => selectItem(item));\n      dropdown.appendChild(div);\n    }\n\n    renderedCount = endIndex;\n\n    const existingMore = dropdown.querySelector('.dropdown-more');\n    if (existingMore) existingMore.remove();\n\n    if (renderedCount < filteredItems.length) {\n      const moreDiv = document.createElement('div');\n      moreDiv.className = 'dropdown-empty dropdown-more';\n      moreDiv.textContent = `Mostrando ${renderedCount} de ${filteredItems.length}. Scroll para ver m√°s...`;\n      dropdown.appendChild(moreDiv);\n    }\n  }\n\n  function selectItem(item: { code: string; name: string }): void {\n    // Show only name when selected\n    input.value = item.name;\n    if (hiddenInput) hiddenInput.value = item.name;\n    dropdown.classList.remove('active');\n    highlightedIndex = -1;\n  }\n\n  function showDropdown(): void {\n    renderDropdown(input.value);\n    dropdown.classList.add('active');\n  }\n\n  function hideDropdown(): void {\n    dropdown.classList.remove('active');\n    highlightedIndex = -1;\n    // Sync hidden input with visible input value when closing without selection\n    if (hiddenInput && input.value) {\n      hiddenInput.value = input.value;\n    }\n  }\n\n  function updateHighlight(): void {\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\n    visibleItems.forEach((item, index) => {\n      item.classList.toggle('highlighted', index === highlightedIndex);\n    });\n    if (highlightedIndex >= 0 && visibleItems[highlightedIndex]) {\n      visibleItems[highlightedIndex].scrollIntoView({ block: 'nearest' });\n    }\n  }\n\n  input.addEventListener('focus', () => showDropdown());\n\n  input.addEventListener('input', () => {\n    renderDropdown(input.value);\n    dropdown.classList.add('active');\n    highlightedIndex = -1;\n  });\n\n  dropdown.addEventListener('scroll', () => {\n    const scrollBottom = dropdown.scrollTop + dropdown.clientHeight;\n    const scrollMax = dropdown.scrollHeight - 50;\n\n    if (scrollBottom >= scrollMax && renderedCount < filteredItems.length) {\n      renderDropdown(input.value, true);\n    }\n  });\n\n  input.addEventListener('keydown', (e) => {\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\n\n    switch (e.key) {\n      case 'ArrowDown':\n        e.preventDefault();\n        if (!dropdown.classList.contains('active')) showDropdown();\n        highlightedIndex = Math.min(highlightedIndex + 1, visibleItems.length - 1);\n        updateHighlight();\n        break;\n      case 'ArrowUp':\n        e.preventDefault();\n        highlightedIndex = Math.max(highlightedIndex - 1, 0);\n        updateHighlight();\n        break;\n      case 'Enter':\n        e.preventDefault();\n        if (highlightedIndex >= 0 && filteredItems[highlightedIndex]) {\n          selectItem(filteredItems[highlightedIndex]);\n        }\n        break;\n      case 'Escape':\n      case 'Tab':\n        hideDropdown();\n        break;\n    }\n  });\n\n  document.addEventListener('click', (e) => {\n    if (!input.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {\n      hideDropdown();\n    }\n  });\n}\n\n/**\n * Setup a searchable dropdown for clients with displayName support\n * Shows full format like iTraffic: \"CODE - NAME - Cuit:XXX\"\n */\nfunction setupSearchableDropdownForClients(\n  input: HTMLInputElement,\n  dropdown: HTMLDivElement,\n  hiddenInput: HTMLInputElement | null,\n  items: Array<{ code: string; name: string; displayName?: string }>\n): void {\n  let highlightedIndex = -1;\n  let filteredItems = [...items];\n  let renderedCount = 0;\n  const BATCH_SIZE = 30;\n  const INITIAL_LOAD = 30;\n\n  function renderDropdown(filter: string = '', loadMore: boolean = false): void {\n    const searchTerm = filter.toLowerCase().trim();\n\n    if (searchTerm) {\n      filteredItems = items.filter(item =>\n        item.name.toLowerCase().includes(searchTerm) ||\n        item.code.toLowerCase().includes(searchTerm) ||\n        (item.displayName && item.displayName.toLowerCase().includes(searchTerm))\n      );\n    } else {\n      filteredItems = [...items];\n    }\n\n    if (!loadMore) {\n      dropdown.innerHTML = '';\n      renderedCount = 0;\n    }\n\n    if (filteredItems.length === 0) {\n      dropdown.innerHTML = '<div class=\"dropdown-empty\">No se encontraron resultados</div>';\n      return;\n    }\n\n    const startIndex = renderedCount;\n    const endIndex = Math.min(startIndex + (loadMore ? BATCH_SIZE : INITIAL_LOAD), filteredItems.length);\n\n    for (let i = startIndex; i < endIndex; i++) {\n      const item = filteredItems[i];\n      const div = document.createElement('div');\n      div.className = 'dropdown-item';\n      div.dataset.value = item.displayName || `${item.code} - ${item.name}`;\n      div.dataset.index = i.toString();\n      // Show displayName if available, otherwise \"CODE - NAME\"\n      div.textContent = item.displayName || `${item.code} - ${item.name}`;\n\n      div.addEventListener('click', () => selectItem(item));\n      dropdown.appendChild(div);\n    }\n\n    renderedCount = endIndex;\n\n    const existingMore = dropdown.querySelector('.dropdown-more');\n    if (existingMore) existingMore.remove();\n\n    if (renderedCount < filteredItems.length) {\n      const moreDiv = document.createElement('div');\n      moreDiv.className = 'dropdown-empty dropdown-more';\n      moreDiv.textContent = `Mostrando ${renderedCount} de ${filteredItems.length}. Scroll para ver m√°s...`;\n      dropdown.appendChild(moreDiv);\n    }\n  }\n\n  function selectItem(item: { code: string; name: string; displayName?: string }): void {\n    // Show displayName when selected (full format like iTraffic)\n    const displayValue = item.displayName || `${item.code} - ${item.name}`;\n    input.value = displayValue;\n    if (hiddenInput) hiddenInput.value = displayValue;\n    dropdown.classList.remove('active');\n    highlightedIndex = -1;\n  }\n\n  function showDropdown(): void {\n    renderDropdown(input.value);\n    dropdown.classList.add('active');\n  }\n\n  function hideDropdown(): void {\n    dropdown.classList.remove('active');\n    highlightedIndex = -1;\n    // Sync hidden input with visible input value when closing without selection\n    if (hiddenInput && input.value) {\n      hiddenInput.value = input.value;\n    }\n  }\n\n  function updateHighlight(): void {\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\n    visibleItems.forEach((item, index) => {\n      item.classList.toggle('highlighted', index === highlightedIndex);\n    });\n    if (highlightedIndex >= 0 && visibleItems[highlightedIndex]) {\n      visibleItems[highlightedIndex].scrollIntoView({ block: 'nearest' });\n    }\n  }\n\n  input.addEventListener('focus', () => showDropdown());\n\n  input.addEventListener('input', () => {\n    renderDropdown(input.value);\n    dropdown.classList.add('active');\n    highlightedIndex = -1;\n  });\n\n  dropdown.addEventListener('scroll', () => {\n    const scrollBottom = dropdown.scrollTop + dropdown.clientHeight;\n    const scrollMax = dropdown.scrollHeight - 50;\n\n    if (scrollBottom >= scrollMax && renderedCount < filteredItems.length) {\n      renderDropdown(input.value, true);\n    }\n  });\n\n  input.addEventListener('keydown', (e) => {\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\n\n    switch (e.key) {\n      case 'ArrowDown':\n        e.preventDefault();\n        if (!dropdown.classList.contains('active')) showDropdown();\n        highlightedIndex = Math.min(highlightedIndex + 1, visibleItems.length - 1);\n        updateHighlight();\n        break;\n      case 'ArrowUp':\n        e.preventDefault();\n        highlightedIndex = Math.max(highlightedIndex - 1, 0);\n        updateHighlight();\n        break;\n      case 'Enter':\n        e.preventDefault();\n        if (highlightedIndex >= 0 && filteredItems[highlightedIndex]) {\n          selectItem(filteredItems[highlightedIndex]);\n        }\n        break;\n      case 'Escape':\n      case 'Tab':\n        hideDropdown();\n        break;\n    }\n  });\n\n  document.addEventListener('click', (e) => {\n    if (!input.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {\n      hideDropdown();\n    }\n  });\n}\n\n/**\n * Setup a searchable dropdown with alias support (for currencies)\n * Allows searching by common abbreviations like USD -> DOLARES\n */\nfunction setupSearchableDropdownWithAliases(\n  input: HTMLInputElement,\n  dropdown: HTMLDivElement,\n  hiddenInput: HTMLInputElement | null,\n  items: Array<{ code: string; name: string }>,\n  aliases: Record<string, string[]>\n): void {\n  let highlightedIndex = -1;\n  let filteredItems = [...items];\n\n  // Build reverse alias map: USD -> DOLARES\n  const reverseAliases: Record<string, string> = {};\n  for (const [mainName, aliasList] of Object.entries(aliases)) {\n    for (const alias of aliasList) {\n      reverseAliases[alias.toUpperCase()] = mainName.toUpperCase();\n    }\n  }\n\n  function renderDropdown(filter: string = ''): void {\n    const searchTerm = filter.toLowerCase().trim();\n    const searchTermUpper = filter.toUpperCase().trim();\n\n    // Check if search term matches an alias\n    const resolvedTerm = reverseAliases[searchTermUpper] || searchTerm;\n\n    if (searchTerm) {\n      filteredItems = items.filter(item => {\n        const nameMatch = item.name.toLowerCase().includes(searchTerm) ||\n          item.name.toLowerCase().includes(resolvedTerm.toLowerCase());\n        const codeMatch = item.code.toLowerCase().includes(searchTerm);\n\n        // Also check if any alias of this item matches\n        const itemAliases = aliases[item.name.toUpperCase()] || [];\n        const aliasMatch = itemAliases.some(a => a.toLowerCase().includes(searchTerm));\n\n        return nameMatch || codeMatch || aliasMatch;\n      });\n    } else {\n      filteredItems = [...items];\n    }\n\n    dropdown.innerHTML = '';\n\n    if (filteredItems.length === 0) {\n      dropdown.innerHTML = '<div class=\"dropdown-empty\">No se encontraron resultados</div>';\n      return;\n    }\n\n    const displayItems = filteredItems.slice(0, 50);\n\n    displayItems.forEach((item, index) => {\n      const div = document.createElement('div');\n      div.className = 'dropdown-item';\n      div.dataset.value = item.name;\n      div.dataset.index = index.toString();\n      div.textContent = item.name;\n\n      div.addEventListener('click', () => selectItem(item));\n      dropdown.appendChild(div);\n    });\n\n    if (filteredItems.length > 50) {\n      const moreDiv = document.createElement('div');\n      moreDiv.className = 'dropdown-empty';\n      moreDiv.textContent = `... y ${filteredItems.length - 50} m√°s. Escribe para filtrar.`;\n      dropdown.appendChild(moreDiv);\n    }\n  }\n\n  function selectItem(item: { code: string; name: string }): void {\n    input.value = item.name;\n    if (hiddenInput) hiddenInput.value = item.name;\n    dropdown.classList.remove('active');\n    highlightedIndex = -1;\n  }\n\n  function showDropdown(): void {\n    renderDropdown(input.value);\n    dropdown.classList.add('active');\n  }\n\n  function hideDropdown(): void {\n    dropdown.classList.remove('active');\n    highlightedIndex = -1;\n    // Sync hidden input with visible input value when closing without selection\n    if (hiddenInput && input.value) {\n      hiddenInput.value = input.value;\n    }\n  }\n\n  function updateHighlight(): void {\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\n    visibleItems.forEach((item, index) => {\n      item.classList.toggle('highlighted', index === highlightedIndex);\n    });\n    if (highlightedIndex >= 0 && visibleItems[highlightedIndex]) {\n      visibleItems[highlightedIndex].scrollIntoView({ block: 'nearest' });\n    }\n  }\n\n  input.addEventListener('focus', () => showDropdown());\n\n  input.addEventListener('input', () => {\n    renderDropdown(input.value);\n    dropdown.classList.add('active');\n    highlightedIndex = -1;\n  });\n\n  input.addEventListener('keydown', (e) => {\n    const visibleItems = dropdown.querySelectorAll('.dropdown-item');\n\n    switch (e.key) {\n      case 'ArrowDown':\n        e.preventDefault();\n        if (!dropdown.classList.contains('active')) showDropdown();\n        highlightedIndex = Math.min(highlightedIndex + 1, visibleItems.length - 1);\n        updateHighlight();\n        break;\n      case 'ArrowUp':\n        e.preventDefault();\n        highlightedIndex = Math.max(highlightedIndex - 1, 0);\n        updateHighlight();\n        break;\n      case 'Enter':\n        e.preventDefault();\n        if (highlightedIndex >= 0 && filteredItems[highlightedIndex]) {\n          selectItem(filteredItems[highlightedIndex]);\n        }\n        break;\n      case 'Escape':\n      case 'Tab':\n        hideDropdown();\n        break;\n    }\n  });\n\n  document.addEventListener('click', (e) => {\n    if (!input.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {\n      hideDropdown();\n    }\n  });\n}\n\n/**\n * Toggle header visibility\n */\nfunction toggleHeader(): void {\n  const header = document.getElementById('collapsible-header')!;\n  const btn = document.getElementById('toggle-header-btn')!;\n\n  if (header.style.display === 'none') {\n    header.style.display = 'block';\n    btn.textContent = 'üîº';\n  } else {\n    header.style.display = 'none';\n    btn.textContent = 'üîΩ';\n  }\n}\n\n/**\n * Get current user email from Outlook\n */\nfunction getCurrentUserEmail(): string | null {\n  try {\n    // Get email from Outlook mailbox\n    const userProfile = Office.context.mailbox?.userProfile;\n    if (userProfile && userProfile.emailAddress) {\n      return userProfile.emailAddress.toLowerCase();\n    }\n    return null;\n  } catch (error) {\n    console.error('‚ùå Error getting current user email:', error);\n    return null;\n  }\n}\n\n/**\n * Check if user is already registered\n */\nasync function checkRegistrationStatus(): Promise<void> {\n  try {\n    // Get current Outlook user email\n    const currentEmail = getCurrentUserEmail();\n    console.log('üìß Current Outlook user:', currentEmail);\n\n    // Check if we have a cached userId in localStorage\n    const cachedUserId = localStorage.getItem('email-classifier-userId');\n    const cachedEmail = localStorage.getItem('email-classifier-email');\n\n    if (!cachedUserId || !cachedEmail) {\n      console.log('‚è≠Ô∏è No cached user found - user must login manually');\n      // Hide loading, show registration UI\n      document.getElementById('loading')!.style.display = 'none';\n      document.getElementById('app-content')!.style.display = 'block';\n      return;\n    }\n\n    // Validate that cached email matches current Outlook email\n    if (currentEmail && cachedEmail.toLowerCase() !== currentEmail) {\n      console.log('‚ö†Ô∏è Cached email does not match current Outlook email');\n      console.log('   Cached:', cachedEmail);\n      console.log('   Current:', currentEmail);\n      console.log('   Clearing cache and requiring re-login');\n\n      localStorage.removeItem('email-classifier-userId');\n      localStorage.removeItem('email-classifier-email');\n\n      // Hide loading, show registration UI\n      document.getElementById('loading')!.style.display = 'none';\n      document.getElementById('app-content')!.style.display = 'block';\n      return;\n    }\n\n    console.log('üîç Found cached user:', cachedEmail, '- verifying with backend...');\n\n    // Verify with production backend where user data is stored\n    const response = await fetch(`${config.dialogBaseUrl}/auth/status?userId=${cachedUserId}`);\n\n    if (!response.ok) {\n      console.log('‚ö†Ô∏è User verification failed - clearing cache');\n      localStorage.removeItem('email-classifier-userId');\n      localStorage.removeItem('email-classifier-email');\n\n      // Hide loading, show registration UI\n      document.getElementById('loading')!.style.display = 'none';\n      document.getElementById('app-content')!.style.display = 'block';\n      return;\n    }\n\n    const data = await response.json();\n\n    if (data.isRegistered && data.user) {\n      console.log('‚úÖ User verified - updating UI');\n\n      // Update state\n      state.isRegistered = true;\n      state.userId = data.user.userId;\n      state.email = data.user.email;\n\n      // Hide loading, show app\n      document.getElementById('loading')!.style.display = 'none';\n      document.getElementById('app-content')!.style.display = 'block';\n\n      // Update UI\n      updateUIForRegisteredUser(data.user);\n    } else {\n      console.log('‚ö†Ô∏è User not found in backend - clearing cache');\n      localStorage.removeItem('email-classifier-userId');\n      localStorage.removeItem('email-classifier-email');\n\n      // Hide loading, show registration UI\n      document.getElementById('loading')!.style.display = 'none';\n      document.getElementById('app-content')!.style.display = 'block';\n    }\n  } catch (error) {\n    console.error('‚ùå Error checking registration status:', error);\n    // Hide loading, show registration UI\n    document.getElementById('loading')!.style.display = 'none';\n    document.getElementById('app-content')!.style.display = 'block';\n  }\n}\n\n/**\n * Handle registration button click - SSO Flow\n */\nasync function handleRegister(): Promise<void> {\n  // Prevent multiple simultaneous authentication attempts\n  if (state.isAuthInProgress) {\n    console.log('‚ö†Ô∏è Authentication already in progress, ignoring request');\n    showError('Authentication is already in progress. Please wait.');\n    return;\n  }\n\n  // Implement exponential backoff for retries\n  const now = Date.now();\n  if (state.lastAuthAttempt && (now - state.lastAuthAttempt) < 2000) {\n    console.log('‚ö†Ô∏è Too many authentication attempts, please wait');\n    showError('Please wait a moment before trying again.');\n    return;\n  }\n\n  hideError();\n  setLoading(true);\n  state.isAuthInProgress = true;\n  state.lastAuthAttempt = now;\n\n  try {\n    console.log('üîê Starting SSO authentication... [VERSION 2024-12-02-DIALOG-PREFERRED]');\n\n    // Get current Outlook email for validation\n    const currentOutlookEmail = getCurrentUserEmail();\n    if (!currentOutlookEmail) {\n      throw new Error('No se pudo obtener el email de Outlook. Por favor, aseg√∫rate de que Outlook est√© completamente cargado.');\n    }\n\n    console.log('üìß Current Outlook email:', currentOutlookEmail);\n\n    // TEMPORARY: Skip SSO and always use dialog flow\n    // SSO + OBO flow has issues with token exchange, dialog flow works reliably\n    // TODO: Fix OBO flow and re-enable SSO for better UX\n    console.log('‚ö†Ô∏è Skipping SSO, using dialog authentication (more reliable)...');\n    await handleRegisterViaDialog({ forceConsent: true });\n    return;\n\n    // Get SSO token from Office (DISABLED - code below kept for future re-enablement)\n    /*\n    console.log('üîë Requesting SSO token from Office.auth.getAccessToken()...');\n    let ssoToken: string;\n    \n    try {\n      ssoToken = await getOfficeSSToken();\n      console.log('‚úÖ SSO token obtained successfully');\n      console.log('   Token length:', ssoToken.length);\n    } catch (ssoError: any) {\n      console.error('‚ùå SSO failed:', ssoError);\n      \n      // If SSO fails, fall back to dialog flow\n      // 13001: No user signed in\n      // 13012: API not compatible / sideload\n      // 13000: General SSO not available\n      // 13003: SSO not supported in this version\n      if (ssoError.code === 13001 || ssoError.code === 13012 || ssoError.code === 13000 || ssoError.code === 13003) {\n        console.log('‚ö†Ô∏è SSO not available (code: ' + ssoError.code + '), falling back to dialog auth...');\n        // Use forceConsent=true to ensure refresh tokens for personal Microsoft accounts\n        await handleRegisterViaDialog({ forceConsent: true });\n        return;\n      }\n      \n      throw ssoError;\n    }\n    \n    // Exchange SSO token for Graph token via backend OBO flow\n    // Must use production backend which has the client_secret for OBO\n    console.log('üîÑ Exchanging SSO token for Graph tokens via OBO flow...');\n    const exchangeResponse = await fetch(`${config.dialogBaseUrl}/auth/exchange-token`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({ ssoToken })\n    });\n\n    if (!exchangeResponse.ok) {\n      const errorData = await exchangeResponse.json().catch(() => ({ error: 'Unknown error' }));\n      throw new Error(`Token exchange failed: ${errorData.error || exchangeResponse.statusText}`);\n    }\n\n    const exchangeData = await exchangeResponse.json();\n    console.log('‚úÖ Token exchange successful:', exchangeData);\n    \n    // Validate email matches\n    if (exchangeData.email.toLowerCase() !== currentOutlookEmail) {\n      console.error('‚ùå Email mismatch after exchange!');\n      console.error('   Backend email:', exchangeData.email);\n      console.error('   Outlook email:', currentOutlookEmail);\n      throw new Error(\n        `Error de coherencia: El email autenticado (${exchangeData.email}) no coincide con tu cuenta de Outlook (${currentOutlookEmail})`\n      );\n    }\n    \n    // Save to localStorage AND roamingSettings for persistence across contexts\n    localStorage.setItem('email-classifier-userId', exchangeData.userId);\n    localStorage.setItem('email-classifier-email', exchangeData.email);\n    \n    // Also save to roamingSettings to share with ribbon commands\n    const settings = Office.context.roamingSettings;\n    settings.set('email-classifier-userId', exchangeData.userId);\n    settings.set('email-classifier-email', exchangeData.email);\n    await settings.saveAsync();\n    \n    console.log('üíæ User credentials saved to localStorage and roamingSettings');\n    \n    // Update state\n    state.isRegistered = true;\n    state.userId = exchangeData.userId;\n    state.email = exchangeData.email;\n\n    // Update UI\n    updateUIForRegisteredUser({\n      email: exchangeData.email,\n      id: exchangeData.userId\n    });\n    \n    // Show success message\n    const message = exchangeData.hasRefreshToken\n      ? 'üéâ Autenticaci√≥n completa! Tus emails se clasificar√°n autom√°ticamente sin vencimiento.'\n      : 'üéâ Autenticaci√≥n completa! Tus emails se clasificar√°n autom√°ticamente.';\n    \n    showSuccessMessage(message);\n    */\n\n  } catch (error: any) {\n    console.error('‚ùå Registration error:', error);\n    state.authRetryCount++;\n    handleRegistrationError(error);\n  } finally {\n    setLoading(false);\n    state.isAuthInProgress = false;\n  }\n}\n\n/**\n * Get SSO token from Office.auth.getAccessToken()\n */\nfunction getOfficeSSToken(): Promise<string> {\n  return new Promise((resolve, reject) => {\n    Office.auth.getAccessToken({\n      allowSignInPrompt: true,\n      allowConsentPrompt: true,\n      forMSGraphAccess: true\n    })\n      .then(token => resolve(token))\n      .catch(error => reject(error));\n  });\n}\n\n/**\n * Fallback: Handle registration via dialog (for sideload scenarios)\n */\ninterface DialogOptions {\n  forceConsent?: boolean;\n}\n\nasync function handleRegisterViaDialog(options: DialogOptions = {}): Promise<void> {\n  try {\n    console.log('ü™ü Using dialog-based authentication fallback');\n    if (options.forceConsent) {\n      console.log('üôè Forcing consent screen for offline_access permission');\n    }\n\n    // Additional check to prevent dialog loops\n    if (state.authRetryCount > 3) {\n      throw new Error('Too many authentication attempts. Please refresh the page and try again.');\n    }\n\n    const dialogResult = await getAccessTokenViaDialog(options);\n    if (!dialogResult) {\n      throw new Error('Failed to obtain authorization via dialog');\n    }\n\n    console.log('‚úÖ Dialog returned payload:', {\n      status: dialogResult.status,\n      hasCode: !!dialogResult.authorizationCode,\n      hasToken: !!dialogResult.token\n    });\n\n    // Reset retry count on any successful dialog response\n    state.authRetryCount = 0;\n\n    const currentOutlookEmail = getCurrentUserEmail();\n\n    if (dialogResult.authorizationCode) {\n      await completeRegistrationWithAuthorizationCode(dialogResult, currentOutlookEmail, options);\n      return;\n    }\n\n    if (dialogResult.token) {\n      console.warn('‚ö†Ô∏è Received legacy token payload from dialog. Proceeding with deprecated flow.');\n      await completeLegacyRegistration(dialogResult, currentOutlookEmail);\n      return;\n    }\n\n    throw new Error('Invalid authentication response from dialog');\n  } catch (error: any) {\n    console.error('‚ùå Dialog registration error:', error);\n    throw error;\n  }\n}\n\nasync function completeRegistrationWithAuthorizationCode(\n  dialogResult: any,\n  currentOutlookEmail: string | null,\n  options: DialogOptions = {}\n): Promise<void> {\n  console.log('üì° Redeeming authorization code via backend (confidential client)...');\n  console.log('‚ÑπÔ∏è Backend will use client_secret to get access_token + refresh_token');\n\n  // Use dialogBaseUrl for token exchange since the auth code was issued there\n  const redeemResponse = await fetch(`${config.dialogBaseUrl}/auth/redeem-code`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      code: dialogResult.authorizationCode,\n      redirectUri: dialogResult.redirectUri\n    })\n  });\n\n  if (!redeemResponse.ok) {\n    const errorData = await redeemResponse.json().catch((data: any) => ({ data: data }));\n    console.error('‚ùå Authorization code redemption failed:', errorData);\n\n    if (redeemResponse.status === 403 && errorData.requiresInteractiveAuth) {\n      console.error('‚ùå Consent required but cannot reopen dialog programmatically (Error 12011)');\n      throw new Error(\n        'Se requiere consentimiento adicional. Por favor, haz clic en \"Retry\" para autorizar nuevamente. ' +\n        'Si el problema persiste, contacta a tu administrador de TI.'\n      );\n    }\n\n    throw new Error(`No se pudo completar la autenticaci√≥n: ${JSON.stringify(errorData)}, ${JSON.stringify(dialogResult)}`);\n  }\n\n  const redeemData = await redeemResponse.json();\n  console.log('‚úÖ Backend redeemed authorization code successfully:', redeemData);\n\n  if (!redeemData.user?.id || !redeemData.user?.email) {\n    throw new Error('La respuesta del servidor no incluye la informaci√≥n del usuario.');\n  }\n\n  const backendEmail = redeemData.user.email.toLowerCase();\n  if (currentOutlookEmail && backendEmail !== currentOutlookEmail) {\n    console.error('‚ùå Email mismatch detected after redemption');\n    throw new Error(\n      `El usuario autenticado (${backendEmail}) no coincide con tu cuenta de Outlook (${currentOutlookEmail}).`\n    );\n  }\n\n  await persistUserSession(redeemData.user.id, redeemData.user.email);\n  state.isRegistered = true;\n  state.userId = redeemData.user.id;\n  state.email = redeemData.user.email;\n\n  updateUIForRegisteredUser({\n    email: redeemData.user.email,\n    id: redeemData.user.id,\n    stats: redeemData.user.stats\n  });\n\n  // Show appropriate message based on refresh token availability\n  let successMessage = 'üéâ Autenticaci√≥n completa!';\n  if (redeemData.hasRefreshToken) {\n    successMessage += ' Tus correos se clasificar√°n autom√°ticamente con acceso permanente.';\n  } else {\n    console.warn('‚ö†Ô∏è No refresh token received - user will need to re-authenticate periodically');\n    successMessage += ' Tus correos se clasificar√°n autom√°ticamente. Nota: Deber√°s volver a autenticarte despu√©s de 1 hora.';\n  }\n  showSuccessMessage(successMessage);\n}\n\nasync function completeLegacyRegistration(messageData: any, currentOutlookEmail: string | null): Promise<void> {\n  if (!messageData.email || !messageData.userId) {\n    throw new Error('Invalid legacy authentication response');\n  }\n\n  if (currentOutlookEmail && messageData.email.toLowerCase() !== currentOutlookEmail) {\n    throw new Error(\n      `Por favor, inicia sesi√≥n con la misma cuenta de Outlook (${currentOutlookEmail}). ` +\n      `Intentaste autenticarte con: ${messageData.email}`\n    );\n  }\n\n  // Use dialogBaseUrl for registration since it stores user data in production CosmosDB\n  const registerResponse = await fetch(`${config.dialogBaseUrl}/auth/register`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      accessToken: messageData.token,\n      refreshToken: messageData.refreshToken,\n      userId: messageData.userId,\n      email: messageData.email,\n      name: messageData.name,\n      expiresOn: messageData.expiresOn\n    })\n  });\n\n  if (!registerResponse.ok) {\n    const errorData = await registerResponse.json().catch(() => ({ error: 'Unknown error' }));\n    throw new Error(`Registration failed: ${ JSON.stringify(errorData)}`);\n  }\n\n  await persistUserSession(messageData.userId, messageData.email);\n  state.isRegistered = true;\n  state.userId = messageData.userId;\n  state.email = messageData.email;\n\n  updateUIForRegisteredUser({\n    email: messageData.email,\n    id: messageData.userId\n  });\n\n  showSuccessMessage('üéâ Autenticaci√≥n completa (modo legacy). Considera actualizar la versi√≥n del complemento.');\n}\n\nasync function persistUserSession(userId: string, email: string): Promise<void> {\n  // Save to localStorage\n  localStorage.setItem('email-classifier-userId', userId);\n  localStorage.setItem('email-classifier-email', email);\n\n  // Save to roamingSettings to share with ribbon commands\n  const settings = Office.context.roamingSettings;\n  settings.set('email-classifier-userId', userId);\n  settings.set('email-classifier-email', email);\n\n  // Save settings asynchronously\n  return new Promise((resolve) => {\n    settings.saveAsync((result) => {\n      if (result.status === Office.AsyncResultStatus.Succeeded) {\n        console.log('üíæ User credentials saved to localStorage and roamingSettings');\n      } else {\n        console.error('‚ö†Ô∏è Failed to save roamingSettings:', result.error);\n      }\n      resolve();\n    });\n  });\n}\n\n/**\n * Handle logout button click\n */\nasync function handleLogout(): Promise<void> {\n  try {\n    console.log('üö™ Logging out user...');\n\n    // Clear localStorage\n    localStorage.removeItem('email-classifier-userId');\n    localStorage.removeItem('email-classifier-email');\n\n    // Clear roamingSettings\n    const settings = Office.context.roamingSettings;\n    settings.remove('email-classifier-userId');\n    settings.remove('email-classifier-email');\n    settings.saveAsync();\n\n    console.log('‚úÖ Cleared localStorage and roamingSettings');\n\n    // Reset state\n    state.isRegistered = false;\n    state.userId = null;\n    state.email = null;\n\n    // Reset UI\n    const statusBox = document.getElementById('status-indicator')!;\n    statusBox.className = 'status-box unregistered';\n    statusBox.innerHTML = `\n      <div class=\"status-icon\">‚è∏Ô∏è</div>\n      <div class=\"status-text\">\n        <h3>Not Registered</h3>\n        <p>Click below to activate automatic email classification</p>\n      </div>\n    `;\n\n    // Show registration button, hide logout button\n    document.getElementById('registration-section')!.style.display = 'block';\n    document.getElementById('logout-section')!.style.display = 'none';\n    document.getElementById('stats-section')!.style.display = 'none';\n\n    console.log('‚úÖ Logged out from add-in');\n\n    // Logout from Microsoft account (clear MSAL cache)\n    console.log('üîì Clearing Microsoft session...');\n    const clientId = '6637590b-a6a4-4e53-b429-a766c66f03c3';\n    const logoutUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/logout?post_logout_redirect_uri=${encodeURIComponent(window.location.origin)}`;\n\n    // Open logout in a hidden dialog to clear Microsoft session\n    Office.context.ui.displayDialogAsync(\n      logoutUrl,\n      { height: 20, width: 20, promptBeforeOpen: false },\n      (result) => {\n        if (result.status === Office.AsyncResultStatus.Succeeded) {\n          const dialog = result.value;\n          // Close dialog after 2 seconds\n          setTimeout(() => {\n            dialog.close();\n            console.log('‚úÖ Microsoft session cleared');\n            showSuccessMessage('üëã Signed out completely. Next login will require re-authentication.');\n          }, 2000);\n        } else {\n          console.log('‚ö†Ô∏è Could not open logout dialog, but local logout succeeded');\n          showSuccessMessage('üëã Signed out successfully. Sign in again to re-activate auto-classification.');\n        }\n      }\n    );\n\n  } catch (error) {\n    console.error('‚ùå Logout error:', error);\n    showError('Failed to sign out. Please try again.');\n  }\n}\n\n/**\n * Get access token using Office.js SSO with fallback to dialog auth\n */\nasync function getAccessToken(allowPrompt: boolean): Promise<string | null> {\n  try {\n    const options: Office.AuthOptions = {\n      allowSignInPrompt: allowPrompt,\n      allowConsentPrompt: allowPrompt,\n      forMSGraphAccess: false, // We're accessing our own API, not Graph\n    };\n\n    const token = await Office.auth.getAccessToken(options);\n    return token;\n\n  } catch (error: any) {\n    console.error('SSO error:', error);\n\n    // Handle specific error codes\n    if (error.code === 13001) {\n      // User is not signed in\n      if (allowPrompt) {\n        throw new Error('Please sign in to Outlook to use this add-in');\n      }\n      return null;\n    } else if (error.code === 13002) {\n      // User aborted consent\n      throw new Error('You must grant permission to use this add-in');\n    } else if (error.code === 13003) {\n      // SSO not supported\n      throw new Error('Single sign-on is not supported in your Outlook version');\n    } else if (error.code === 13006) {\n      // Admin consent required\n      throw new Error('This add-in requires administrator approval. Please contact your IT department.');\n    } else if (error.code === 13007) {\n      // Invalid grant or consent revoked\n      console.log('Invalid grant or consent revoked, falling back to dialog auth');\n      return await getAccessTokenViaDialog();\n    } else if (error.code === 13012) {\n      // API not compatible or sideloading in Outlook\n      // This is EXPECTED when sideloading in Outlook - use fallback auth\n      console.log('SSO unavailable (error 13012), falling back to dialog auth');\n      return await getAccessTokenViaDialog();\n    }\n\n    // For any other error, try fallback auth\n    console.log(`SSO failed with error ${error.code}, attempting fallback auth`);\n    return await getAccessTokenViaDialog();\n  }\n}\n\n/**\n * Fallback authentication using Office dialog\n */\nasync function getAccessTokenViaDialog(options: DialogOptions = {}): Promise<any> {\n  // Close any existing dialog first to prevent \"already has an active dialog\" error\n  closeActiveDialog();\n\n  return new Promise((resolve, reject) => {\n    const params = new URLSearchParams();\n    if (options.forceConsent) {\n      params.set('forceConsent', 'true');\n    }\n    const queryString = params.toString();\n    // Office dialogs REQUIRE HTTPS - use dialogBaseUrl (always production)\n    const dialogUrl = queryString\n      ? `${config.dialogBaseUrl}/login.html?${queryString}`\n      : `${config.dialogBaseUrl}/login.html`;\n\n    console.log('Opening authentication dialog:', dialogUrl);\n\n    const dialogOptions: Office.DialogOptions = {\n      height: 60,\n      width: 30,\n      promptBeforeOpen: false,\n      displayInIframe: false // Azure AD blocks iframing; always use pop-out window\n    };\n\n    Office.context.ui.displayDialogAsync(\n      dialogUrl,\n      dialogOptions,\n      (result) => {\n        if (result.status === Office.AsyncResultStatus.Failed) {\n          console.error('Failed to open dialog:', result.error);\n\n          // Handle \"already has an active dialog\" error (12007)\n          if (result.error && result.error.code === 12007) {\n            console.log('Dialog already active, clearing reference and retrying...');\n            activeDialog = null;\n            // Retry once after clearing\n            setTimeout(() => {\n              reject(new Error('Ya hay un dialogo de autenticacion abierto. Cierra la ventana anterior y vuelve a intentar.'));\n            }, 500);\n            return;\n          }\n\n          if (result.error && result.error.code === 12011) {\n            const guidance = 'No pudimos abrir la ventana del consentimiento porque el explorador considera diferente la zona de seguridad. Abre Outlook en Edge/Chrome actualizado o agrega https://app-itraffic-rpa.whiteflower-4df565a8.eastus2.azurecontainerapps.io a los sitios de confianza.';\n            reject(new Error(guidance));\n            return;\n          }\n\n          reject(new Error(`Failed to open authentication dialog: ${result.error.message || result.error.code}`));\n          return;\n        }\n\n        // Store reference to active dialog\n        const dialog = result.value;\n        activeDialog = dialog;\n        let dialogClosed = false;\n\n        // Function to check localStorage for auth code (fallback mechanism)\n        const checkLocalStorageForAuth = (): any | null => {\n          try {\n            const stored = localStorage.getItem('office_auth_pending');\n            if (stored) {\n              const data = JSON.parse(stored);\n              // Only use if less than 5 minutes old\n              if (data.timestamp && (Date.now() - data.timestamp) < 300000) {\n                console.log('Found auth code in localStorage (fallback)');\n                localStorage.removeItem('office_auth_pending');\n                return data;\n              } else {\n                // Clean up old entry\n                localStorage.removeItem('office_auth_pending');\n              }\n            }\n          } catch (e) {\n            console.error('Error checking localStorage:', e);\n          }\n          return null;\n        };\n\n        // Function to check server bridge for auth code (handles cross-context scenario)\n        // Bridge must use same URL as dialog (production) since that's where auth code is stored\n        const checkServerBridgeForAuth = async (): Promise<any | null> => {\n          try {\n            const response = await fetch(`${config.dialogBaseUrl}/auth/bridge?email=pending`);\n            if (response.ok) {\n              const data = await response.json();\n              if (data.success && data.code) {\n                console.log('üì¶ Found auth code in server bridge');\n                return {\n                  status: 'code',\n                  authorizationCode: data.code,\n                  redirectUri: data.redirectUri,\n                  state: data.state\n                };\n              }\n            }\n          } catch (e) {\n            // Silently fail - bridge might not exist or have no data\n          }\n          return null;\n        };\n\n        // Poll localStorage and server bridge every 2 seconds as fallback\n        const localStorageInterval = setInterval(async () => {\n          if (dialogClosed) {\n            clearInterval(localStorageInterval);\n            return;\n          }\n\n          // First check localStorage\n          let authData = checkLocalStorageForAuth();\n\n          // If not in localStorage, check server bridge\n          if (!authData) {\n            authData = await checkServerBridgeForAuth();\n          }\n\n          if (authData && authData.status === 'code' && authData.authorizationCode) {\n            console.log('Retrieved auth code from fallback mechanism');\n            clearInterval(localStorageInterval);\n            clearTimeout(timeout);\n            dialogClosed = true;\n            activeDialog = null;\n            try { dialog.close(); } catch (e) { /* dialog might already be closed */ }\n            resolve(authData);\n          }\n        }, 2000);\n\n        // Set a timeout to prevent infinite waiting\n        const timeout = setTimeout(async () => {\n          if (!dialogClosed) {\n            // Before failing, check localStorage one more time\n            let authData = checkLocalStorageForAuth();\n            if (!authData) {\n              authData = await checkServerBridgeForAuth();\n            }\n\n            if (authData && authData.status === 'code' && authData.authorizationCode) {\n              console.log('Retrieved auth code from fallback on timeout');\n              clearInterval(localStorageInterval);\n              dialogClosed = true;\n              activeDialog = null;\n              try { dialog.close(); } catch (e) { /* dialog might already be closed */ }\n              resolve(authData);\n              return;\n            }\n\n            console.error('Dialog timeout - no response received');\n            clearInterval(localStorageInterval);\n            dialogClosed = true;\n            activeDialog = null;\n            dialog.close();\n            reject(new Error('Authentication timeout. Please try again.'));\n          }\n        }, 120000); // 2 minute timeout\n\n        // Listen for messages from the dialog\n        dialog.addEventHandler(Office.EventType.DialogMessageReceived, (arg: any) => {\n          if (dialogClosed) return;\n\n          clearTimeout(timeout);\n          clearInterval(localStorageInterval);\n          dialogClosed = true;\n          activeDialog = null;\n          dialog.close();\n\n          try {\n            const message = JSON.parse(arg.message);\n\n            console.log('Received message from dialog:', {\n              status: message.status,\n              hasCode: !!message.authorizationCode,\n              hasToken: !!message.token\n            });\n\n            if (message.status === 'code' && message.authorizationCode) {\n              resolve(message);\n              return;\n            }\n\n            if (message.status === 'success' && message.token) {\n              resolve(message);\n              return;\n            }\n\n            reject(new Error(message.error || 'Authentication failed'));\n          } catch (error) {\n            console.error('‚ùå Error parsing dialog message:', error);\n            reject(new Error('Invalid response from authentication dialog'));\n          }\n        });\n\n        // Handle dialog closed by user\n        dialog.addEventHandler(Office.EventType.DialogEventReceived, async (arg: any) => {\n          if (dialogClosed) return;\n\n          clearTimeout(timeout);\n          clearInterval(localStorageInterval);\n\n          console.log('Dialog event received:', arg);\n\n          // Before failing, check localStorage and server bridge for auth code\n          let authData = checkLocalStorageForAuth();\n          if (!authData) {\n            authData = await checkServerBridgeForAuth();\n          }\n\n          if (authData && authData.status === 'code' && authData.authorizationCode) {\n            console.log('Retrieved auth code from fallback after dialog event');\n            dialogClosed = true;\n            activeDialog = null;\n            resolve(authData);\n            return;\n          }\n\n          dialogClosed = true;\n          activeDialog = null;\n\n          if (arg.error === 12006) {\n            // User closed dialog - wait a bit and check again\n            setTimeout(async () => {\n              let delayedAuthData = checkLocalStorageForAuth();\n              if (!delayedAuthData) {\n                delayedAuthData = await checkServerBridgeForAuth();\n              }\n\n              if (delayedAuthData && delayedAuthData.status === 'code' && delayedAuthData.authorizationCode) {\n                console.log('‚úÖ Retrieved auth code from fallback after dialog close delay');\n                resolve(delayedAuthData);\n              } else {\n                reject(new Error('Authentication cancelled by user'));\n              }\n            }, 1500);\n          } else if (arg.error === 12002) {\n            // Dialog navigation error\n            reject(new Error('Dialog navigation failed. Please check your internet connection.'));\n          } else {\n            reject(new Error(`Authentication dialog error: ${arg.error || 'Unknown error'}`));\n          }\n        });\n      }\n    );\n  });\n}\n\n/**\n * Update UI for registered user\n */\nfunction updateUIForRegisteredUser(data: any): void {\n  console.log('üé® updateUIForRegisteredUser called with data:', data);\n\n  // Update status indicator\n  const statusBox = document.getElementById('status-indicator')!;\n  statusBox.className = 'status-box registered';\n  statusBox.innerHTML = `\n    <div class=\"status-icon\">‚úÖ</div>\n    <div class=\"status-text\">\n      <h3>Active</h3>\n      <p>Auto-classification enabled for ${data.email || 'your account'}</p>\n    </div>\n  `;\n\n  // Hide registration button, show logout button\n  document.getElementById('registration-section')!.style.display = 'none';\n  document.getElementById('logout-section')!.style.display = 'block';\n\n  // Show stats section\n  document.getElementById('stats-section')!.style.display = 'block';\n\n  // Show extraction section\n  const extractionSection = document.getElementById('extraction-section')!;\n  extractionSection.style.display = 'block';\n  console.log('‚úÖ Extraction section displayed:', extractionSection.style.display);\n\n  // Update stats if available\n  if (data.stats) {\n    document.getElementById('total-classified')!.textContent = data.stats.totalClassified || '0';\n    document.getElementById('categories-count')!.textContent = data.stats.categoriesCount || '0';\n  }\n}\n\n/**\n * Update field status (highlight if missing)\n * Handles both Inputs and Selects. For Selects, adds the option if missing.\n * For searchable dropdowns, finds the best match from master data.\n */\nfunction updateFieldStatus(elementId: string, value: string | null): void {\n  const element = document.getElementById(elementId) as HTMLInputElement | HTMLSelectElement;\n  if (!element) return;\n\n  const valToSet = value || '';\n\n  // Helper function to normalize text (remove accents)\n  const normalizeText = (text: string): string => {\n    return text.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').toUpperCase().trim();\n  };\n\n  // Special handling for searchable dropdown fields - find best match from master data\n  if (element.tagName === 'INPUT' && valToSet) {\n    const searchableFields: Record<string, Array<{ code: string; name: string }>> = {\n      'input-seller': masterData.sellers,\n      'input-client': masterData.clients,\n      'input-currency': masterData.currencies,\n      'input-status': masterData.statuses,\n      'input-reservation-type': masterData.reservationTypes,\n    };\n\n    const dataSource = searchableFields[elementId];\n    if (dataSource && dataSource.length > 0) {\n      const searchTerm = normalizeText(valToSet);\n      let match: { code: string; name: string } | undefined;\n\n      // 1. Try exact match by code\n      match = dataSource.find(item =>\n        normalizeText(item.code) === searchTerm\n      );\n\n      // 2. Try exact match by name (normalized)\n      if (!match) {\n        match = dataSource.find(item =>\n          normalizeText(item.name) === searchTerm\n        );\n      }\n\n      // 3. For status/reservationType, check if name contains [CODE] and match\n      // Format is \"NAME [CODE]\" so search for items where the code in brackets matches\n      if (!match && (elementId === 'input-status' || elementId === 'input-reservation-type')) {\n        match = dataSource.find(item => {\n          // Extract code from name if it's in format \"NAME [CODE]\"\n          const codeMatch = item.name.match(/\\[([^\\]]+)\\]$/);\n          if (codeMatch) {\n            return normalizeText(codeMatch[1]) === searchTerm;\n          }\n          return false;\n        });\n\n        // Also try matching status name without code (e.g., \"Pendiente de confirmaci√≥n\" -> \"PENDIENTE DE CONFIRMACION [PC]\")\n        if (!match) {\n          // First try to find exact match of name part\n          match = dataSource.find(item => {\n            const nameWithoutCode = item.name.replace(/\\s*\\[[^\\]]+\\]$/, '');\n            return normalizeText(nameWithoutCode) === searchTerm;\n          });\n        }\n\n        // Then try partial match but prefer longer matches (more specific)\n        if (!match) {\n          const candidates = dataSource.filter(item => {\n            const nameWithoutCode = item.name.replace(/\\s*\\[[^\\]]+\\]$/, '');\n            const normalizedName = normalizeText(nameWithoutCode);\n            return normalizedName.includes(searchTerm) || searchTerm.includes(normalizedName);\n          });\n\n          // Sort by name length descending to prefer more specific matches\n          // e.g., \"PENDIENTE DE CONFIRMACION\" over \"CONFIRMACION\"\n          if (candidates.length > 0) {\n            candidates.sort((a, b) => {\n              const aName = a.name.replace(/\\s*\\[[^\\]]+\\]$/, '');\n              const bName = b.name.replace(/\\s*\\[[^\\]]+\\]$/, '');\n              // Prefer exact contains match\n              const aContains = searchTerm.includes(normalizeText(aName));\n              const bContains = searchTerm.includes(normalizeText(bName));\n              if (aContains && !bContains) return -1;\n              if (!aContains && bContains) return 1;\n              // Then prefer longer names (more specific)\n              return bName.length - aName.length;\n            });\n            match = candidates[0];\n          }\n        }\n      }\n\n      // 4. Try partial match - search term contains or is contained in name/code (normalized)\n      // For status fields, this is handled above with better specificity\n      if (!match && elementId !== 'input-status' && elementId !== 'input-reservation-type') {\n        match = dataSource.find(item =>\n          normalizeText(item.name).includes(searchTerm) ||\n          searchTerm.includes(normalizeText(item.name)) ||\n          normalizeText(item.code).includes(searchTerm)\n        );\n      }\n\n      // 5. For sellers, try matching first part of name (e.g., \"TEST\" matches \"TEST TEST\")\n      if (!match && elementId === 'input-seller') {\n        match = dataSource.find(item => {\n          const nameParts = normalizeText(item.name).split(' ');\n          return nameParts.some(part => part === searchTerm || searchTerm.includes(part));\n        });\n      }\n\n      // 6. For clients, try matching just the client name/code without the full format\n      if (!match && elementId === 'input-client') {\n        match = dataSource.find(item => {\n          // Client format: \"CODE - NAME - Cuit:XXX\" or just \"NAME\"\n          const parts = item.name.split(' - ');\n          return parts.some(part =>\n            normalizeText(part).includes(searchTerm) ||\n            searchTerm.includes(normalizeText(part))\n          );\n        });\n      }\n\n      // 7. For currency, use alias mapping (USD -> DOLARES, EUR -> EUROS, etc.)\n      if (!match && elementId === 'input-currency') {\n        const currencyAliases: Record<string, string[]> = {\n          'DOLARES': ['USD', 'DOLAR', 'US$', 'U$S', 'DOLLAR', 'DOLLARS', 'D√ìLARES'],\n          'PESOS': ['ARS', 'PESO', 'AR$', 'PESOS ARGENTINOS'],\n          'EUROS': ['EUR', 'EURO', '‚Ç¨', 'EUROS'],\n          'REALES': ['BRL', 'REAL', 'R$', 'REAIS'],\n        };\n\n        // Find which currency this alias belongs to\n        for (const [currencyName, aliases] of Object.entries(currencyAliases)) {\n          if (aliases.some(alias => normalizeText(alias) === searchTerm)) {\n            // Find the currency in master data\n            match = dataSource.find(item => normalizeText(item.name).includes(currencyName));\n            if (match) {\n              console.log(`üí± Currency alias found: \"${valToSet}\" -> \"${match.name}\"`);\n              break;\n            }\n          }\n        }\n      }\n\n      if (match) {\n        // Set the display value\n        element.value = match.name;\n\n        // Also set hidden value if exists\n        const hiddenInput = document.getElementById(`${elementId}-value`) as HTMLInputElement;\n        if (hiddenInput) {\n          // Always store the name (which includes the code for status/reservationType)\n          // The RPA needs the full name to do hasText match in iTraffic dropdowns\n          hiddenInput.value = match.name;\n        }\n\n        element.classList.remove('missing-field');\n        console.log(`‚úÖ Field ${elementId}: matched \"${valToSet}\" -> \"${match.name}\"`);\n        return;\n      } else {\n        console.warn(`‚ö†Ô∏è Field ${elementId}: no match found for \"${valToSet}\" in ${dataSource.length} items`);\n      }\n    }\n  }\n\n  // Special handling for Select elements: Add option if it doesn't exist\n  if (element.tagName === 'SELECT' && valToSet) {\n    const select = element as HTMLSelectElement;\n    let exists = false;\n    // Check if value exists (case insensitive check might be better but strict for now)\n    for (let i = 0; i < select.options.length; i++) {\n      if (select.options[i].value === valToSet) {\n        exists = true;\n        break;\n      }\n    }\n\n    if (!exists) {\n      const option = document.createElement('option');\n      option.value = valToSet;\n      option.text = `${valToSet} (Detectado)`;\n      select.add(option);\n    }\n  }\n\n  element.value = valToSet;\n\n  if (!valToSet) {\n    element.classList.add('missing-field');\n    // Only set placeholder for inputs, not selects\n    if (element.tagName === 'INPUT') {\n      (element as HTMLInputElement).placeholder = 'Requerido - Completar';\n    }\n    // Ensure it's enabled\n    element.disabled = false;\n  } else {\n    element.classList.remove('missing-field');\n  }\n}\n\n/**\n * Handle registration errors with user-friendly messages\n */\nfunction handleRegistrationError(error: any): void {\n  let userMessage = 'Registration failed. ';\n\n  if (error.message.includes('offline_access')) {\n    userMessage += 'The app needs permission to work in the background. Please contact your administrator.';\n  } else if (error.message.includes('consent')) {\n    userMessage += 'You must grant permissions to use this add-in.';\n  } else if (error.message.includes('administrator')) {\n    userMessage += 'This add-in requires administrator approval.';\n  } else if (error.message.includes('network') || error.message.includes('fetch')) {\n    userMessage += 'Network error. Please check your internet connection.';\n  } else {\n    userMessage += error.message || 'Please try again or contact support.';\n  }\n\n  showError(userMessage);\n}\n\n/**\n * Show error message\n */\nfunction showError(message: string): void {\n  state.error = message;\n  const errorSection = document.getElementById('error-section')!;\n  const errorMessage = document.getElementById('error-message')!;\n\n  errorMessage.textContent = message;\n  errorSection.style.display = 'flex';\n}\n\n/**\n * Hide error message\n */\nfunction hideError(): void {\n  state.error = null;\n  document.getElementById('error-section')!.style.display = 'none';\n}\n\n/**\n * Show success message\n */\nfunction showSuccessMessage(message: string): void {\n  // You could implement a toast/notification here\n  console.log('‚úÖ', message);\n\n  // For now, temporarily update status box\n  const statusBox = document.getElementById('status-indicator')!;\n  const originalContent = statusBox.innerHTML;\n\n  statusBox.innerHTML = `\n    <div class=\"status-icon\">‚úÖ</div>\n    <div class=\"status-text\">\n      <h3>Success!</h3>\n      <p>${message}</p>\n    </div>\n  `;\n\n  statusBox.style.background = '#dff6dd';\n  statusBox.style.borderColor = '#107c10';\n\n  setTimeout(() => {\n    statusBox.style.background = '';\n    statusBox.style.borderColor = '';\n  }, 3000);\n}\n\n/**\n * Set loading state\n */\nfunction setLoading(loading: boolean): void {\n  state.isLoading = loading;\n  const button = document.getElementById('register-button') as HTMLButtonElement;\n\n  if (button) {\n    button.disabled = loading;\n    button.innerHTML = loading\n      ? '<span class=\"button-icon\">‚è≥</span><span>Registering...</span>'\n      : '<span class=\"button-icon\">‚ú®</span><span>Activate Auto-Classification</span>';\n  }\n}\n\n/**\n * Show help dialog\n */\nfunction showHelp(event: Event): void {\n  event.preventDefault();\n\n  Office.context.ui.displayDialogAsync(\n    `${window.location.origin}/help.html`,\n    { height: 60, width: 40 },\n    (result) => {\n      if (result.status === Office.AsyncResultStatus.Failed) {\n        console.error('Failed to open help dialog:', result.error);\n      }\n    }\n  );\n}\n\n// ============================================================================\n// RESERVATION EXTRACTION FEATURE\n// ============================================================================\n\n/**\n * Handle extraction button click\n */\nasync function handleExtractReservation(): Promise<void> {\n  console.log('üîç handleExtractReservation called');\n  console.log('   State:', { userId: state.userId, isRegistered: state.isRegistered, email: state.email });\n  console.log('   Extraction visible:', document.getElementById('extraction-section')!.style.display);\n\n  if (extractionState.isExtracting) {\n    console.log('‚ö†Ô∏è Extraction already in progress');\n    return;\n  }\n\n  // Ensure userId is available - check localStorage if not in state\n  if (!state.userId) {\n    const cachedUserId = localStorage.getItem('email-classifier-userId');\n    const cachedEmail = localStorage.getItem('email-classifier-email');\n\n    if (cachedUserId && cachedEmail) {\n      console.log('‚ôªÔ∏è Restored userId from localStorage');\n      state.userId = cachedUserId;\n      state.email = cachedEmail;\n      state.isRegistered = true;\n    } else {\n      console.error('‚ùå No userId in state or localStorage!');\n      showError('Please register first to use extraction feature');\n      return;\n    }\n  }\n\n  // Hide any previous errors\n  document.getElementById('extraction-error')!.style.display = 'none';\n\n  // Show loading\n  document.getElementById('extraction-loading')!.style.display = 'block';\n  document.getElementById('extraction-results')!.style.display = 'none';\n\n  extractionState.isExtracting = true;\n  extractionState.error = null;\n\n  try {\n    console.log('üìß Getting email content...');\n\n    // Get email content from current item\n    const emailContent = await getEmailConversationContent();\n\n    if (!emailContent || emailContent.length < 50) {\n      throw new Error('El contenido del email es demasiado corto o no se pudo obtener');\n    }\n\n    console.log(`‚úÖ Email content obtained: ${emailContent.length} characters`);\n    console.log('üöÄ Sending to extraction API...');\n\n    // Call backend extraction API\n    const response = await fetch(`${config.apiBaseUrl}/api/extract-reservation`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        userId: state.userId,\n        emailContent: emailContent,\n        conversationId: Office.context.mailbox.item?.conversationId || null\n      })\n    });\n\n    if (!response.ok) {\n      const errorData: ExtractionApiError = await response.json().catch(() => ({\n        success: false,\n        error: 'Request failed',\n        details: `HTTP ${response.status}: ${response.statusText}`\n      }));\n\n      throw new Error(errorData.details || errorData.error || 'Extraction failed');\n    }\n\n    const result: ExtractionApiResponse = await response.json();\n\n    // Update state\n    extractionState.hasExtracted = true;\n    extractionState.data = result.data;\n    extractionState.error = null;\n\n    // Display results\n    displayExtractionResults(result.data);\n\n    // Hide loading\n    document.getElementById('extraction-loading')!.style.display = 'none';\n\n  } catch (error: any) {\n    console.error('‚ùå Extraction error:', error);\n\n    extractionState.error = error.message || 'Unknown error occurred';\n\n    // Hide loading\n    document.getElementById('extraction-loading')!.style.display = 'none';\n\n    // Show error\n    const errorSection = document.getElementById('extraction-error')!;\n    const errorMessage = document.getElementById('extraction-error-message')!;\n\n    errorMessage.textContent = error.message || 'No se pudo extraer la informaci√≥n. Por favor, intenta nuevamente.';\n    errorSection.style.display = 'flex';\n\n  } finally {\n    extractionState.isExtracting = false;\n  }\n}\n\n/**\n * Get email conversation content (including forwarded emails and replies)\n */\nasync function getEmailConversationContent(): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const item = Office.context.mailbox.item;\n\n    if (!item) {\n      reject(new Error('No email item selected'));\n      return;\n    }\n\n    console.log('üìß Getting email body (includes forwarded emails in body)...');\n\n    // Get body as plain text (includes forwarded emails)\n    // Office.CoercionType.Text preserves forwarded content and email chains\n    item.body.getAsync(Office.CoercionType.Text, (result) => {\n      if (result.status === Office.AsyncResultStatus.Succeeded) {\n        const bodyContent = result.value || '';\n\n        // Also get subject\n        const subject = item.subject || '';\n\n        // Get sender info\n        const from = item.from?.displayName || item.from?.emailAddress || '';\n\n        // Combine all information\n        // The body content already includes forwarded emails, so we just need to add context\n        const fullContent = `Asunto: ${subject}\nDe: ${from}\n\n${bodyContent}`;\n\n        console.log(`‚úÖ Email content obtained: ${fullContent.length} characters`);\n        console.log(`   Subject: ${subject.substring(0, 50)}...`);\n        console.log(`   Body preview: ${bodyContent.substring(0, 100)}...`);\n\n        resolve(fullContent);\n      } else {\n        console.error('‚ùå Failed to get email body:', result.error);\n        reject(new Error('No se pudo obtener el contenido del email'));\n      }\n    });\n  });\n}\n\n/**\n * Display extraction results in the UI\n */\nfunction displayExtractionResults(data: ReservationData): void {\n  console.log('üìä Displaying extraction results...');\n\n  // Auto-collapse header to show results\n  const header = document.getElementById('collapsible-header');\n  const btn = document.getElementById('toggle-header-btn');\n  if (header && btn) {\n    header.style.display = 'none';\n    btn.textContent = 'üîΩ';\n  }\n\n  // Show results section\n  document.getElementById('extraction-results')!.style.display = 'block';\n\n  // Update confidence badge\n  const confidenceBadge = document.getElementById('confidence-badge')!;\n  const confidenceText = document.getElementById('confidence-text')!;\n  const confidencePercent = Math.round((data.confidence || 0) * 100);\n\n  confidenceText.textContent = `Confianza: ${confidencePercent}%`;\n\n  // Set badge color based on confidence\n  confidenceBadge.className = 'confidence-badge';\n  if (confidencePercent >= 80) {\n    // High confidence - green (default)\n  } else if (confidencePercent >= 60) {\n    confidenceBadge.classList.add('medium');\n  } else {\n    confidenceBadge.classList.add('low');\n  }\n\n  // Display passengers\n  displayPassengers(data.passengers || []);\n\n  // Calculate passenger counts\n  const passengers = data.passengers || [];\n  const adults = passengers.filter(p => p.paxType === 'ADU').length;\n  const children = passengers.filter(p => p.paxType === 'CHD').length;\n  const infants = passengers.filter(p => p.paxType === 'INF').length;\n\n  // Set default dates\n  const today = new Date().toISOString().split('T')[0];\n  const travelDate = data.travelDate || data.checkIn || today;\n\n  // Populate iTraffic fields (solo campos visibles)\n  // Campos comentados en HTML - no intentar acceder\n  // (document.getElementById('input-codigo') as HTMLInputElement).value = data.codigo || '';\n  // (document.getElementById('input-estado-deuda') as HTMLInputElement).value = data.estadoDeuda || 'A√∫n no posee estado deudor';\n\n  updateFieldStatus('input-reservation-type', data.reservationType || 'COMA'); // Default to Mayorista?\n  updateFieldStatus('input-status', data.status || 'PC'); // Default to Pendiente\n\n  // Campos de fecha comentados en HTML\n  // (document.getElementById('input-reservation-date') as HTMLInputElement).value = data.reservationDate || today;\n  (document.getElementById('input-travel-date') as HTMLInputElement).value = travelDate;\n  // (document.getElementById('input-tour-end-date') as HTMLInputElement).value = data.tourEndDate || data.checkOut || '';\n  // (document.getElementById('input-due-date') as HTMLInputElement).value = data.dueDate || today;\n\n  updateFieldStatus('input-seller', data.seller);\n  // (document.getElementById('input-passenger-name') as HTMLInputElement).value = data.passengerName || (passengers.length > 0 ? `${passengers[0].firstName} ${passengers[0].lastName}` : '');\n\n  updateFieldStatus('input-client', data.client);\n\n  // Campos comentados en HTML - no intentar acceder\n  // const contactHiddenInput = document.getElementById('input-contact-value') as HTMLInputElement;\n  // if (contactHiddenInput) contactHiddenInput.value = '';\n\n  // (document.getElementById('input-commission') as HTMLInputElement).value = data.commission?.toString() || '';\n  // updateFieldStatus('input-currency', data.currency || 'DOLARES');\n  // (document.getElementById('input-exchange-rate') as HTMLInputElement).value = data.exchangeRate?.toString() || '1430.00';\n\n  // (document.getElementById('input-adults') as HTMLInputElement).value = adults.toString();\n  // (document.getElementById('input-children') as HTMLInputElement).value = children.toString();\n  // (document.getElementById('input-infants') as HTMLInputElement).value = infants.toString();\n\n  // (document.getElementById('input-trip-name') as HTMLInputElement).value = data.tripName || '';\n  // (document.getElementById('input-product-code') as HTMLInputElement).value = data.productCode || data.reservationCode || '';\n\n  // Secciones comentadas en HTML\n  // if (data.flights && data.flights.length > 0) {\n  //   displayFlights(data.flights);\n  //   document.getElementById('flights-group')!.style.display = 'block';\n  // } else {\n  //   document.getElementById('flights-group')!.style.display = 'none';\n  // }\n\n  // if (data.services && data.services.length > 0) {\n  //   displayServices(data.services);\n  //   document.getElementById('services-group')!.style.display = 'block';\n  // } else {\n  //   document.getElementById('services-group')!.style.display = 'none';\n  // }\n\n  console.log('‚úÖ Results displayed');\n}\n\n/**\n * Calculate age from date of birth\n */\nfunction calculateAge(dateOfBirth: string): number | null {\n  try {\n    const birthDate = new Date(dateOfBirth);\n    const today = new Date();\n    let age = today.getFullYear() - birthDate.getFullYear();\n    const monthDiff = today.getMonth() - birthDate.getMonth();\n    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {\n      age--;\n    }\n    return age;\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Display passengers list with editable inputs\n */\nfunction displayPassengers(passengers: any[]): void {\n  const passengersList = document.getElementById('passengers-list')!;\n  const passengersCount = document.getElementById('passengers-count')!;\n\n  passengersCount.textContent = passengers.length.toString();\n  passengersList.innerHTML = '';\n\n  if (passengers.length === 0) {\n    // Add empty row for manual entry if needed\n    passengers.push({});\n  }\n\n  // Build gender options\n  const genderOptions = masterData.genders.length > 0\n    ? masterData.genders.map(g => `<option value=\"${g.code}\">${g.name}</option>`).join('')\n    : `<option value=\"M\">MASCULINO [M]</option><option value=\"F\">FEMENINO [F]</option>`;\n\n  // Build document type options\n  const docTypeOptions = masterData.documentTypes.length > 0\n    ? masterData.documentTypes.map(dt => `<option value=\"${dt.code}\">${dt.name}</option>`).join('')\n    : `<option value=\"PAS\">PASAPORTE [PAS]</option><option value=\"DNI\">DOCUMENTO NACIONAL DE IDENTIDAD [DNI]</option>`;\n\n  // Build nationality options (countries)\n  const nationalityOptions = masterData.countries.length > 0\n    ? masterData.countries.map(c =>\n      `<option value=\"${c.name}\">${c.name}</option>`\n    ).join('')\n    : `<option value=\"ARGENTINA\">ARGENTINA</option>\n  ¬† ¬† ¬†<option value=\"BRASIL\">BRASIL</option>\n  ¬† ¬† ¬†<option value=\"ESTADOS UNIDOS\">ESTADOS UNIDOS</option>`;\n\n  passengers.forEach((passenger, index) => {\n    const card = document.createElement('div');\n    card.className = 'passenger-card';\n    card.setAttribute('data-index', index.toString());\n\n    // Set selected for current values\n    const currentSex = passenger.sex || '';\n    const currentDocType = passenger.documentType || '';\n    const currentNationality = passenger.nationality || '';\n\n    card.innerHTML = `\n      <div class=\"passenger-card-header\">\n        <h4>Pasajero ${index + 1}</h4>\n        <button class=\"icon-button remove-passenger\" data-index=\"${index}\" title=\"Eliminar\">üóëÔ∏è</button>\n      </div>\n      <div class=\"form-grid\">\n        <div class=\"form-group\">\n          <label>Nombre</label>\n          <input type=\"text\" class=\"passenger-input\" data-field=\"firstName\" value=\"${passenger.firstName || ''}\" placeholder=\"Nombre\">\n        </div>\n        <div class=\"form-group\">\n          <label>Apellido</label>\n          <input type=\"text\" class=\"passenger-input\" data-field=\"lastName\" value=\"${passenger.lastName || ''}\" placeholder=\"Apellido\">\n        </div>\n        <div class=\"form-group\">\n          <label>Tipo Pax</label>\n          <select class=\"passenger-input\" data-field=\"paxType\">\n            <option value=\"ADU\" ${passenger.paxType === 'ADU' ? 'selected' : ''}>Adulto</option>\n            <option value=\"CHD\" ${passenger.paxType === 'CHD' ? 'selected' : ''}>Ni√±o</option>\n            <option value=\"INF\" ${passenger.paxType === 'INF' ? 'selected' : ''}>Infante</option>\n          </select>\n        </div>\n        <div class=\"form-group\">\n          <label>Sexo</label>\n          <select class=\"passenger-input passenger-sex\" data-field=\"sex\" data-current=\"${currentSex}\">\n            <option value=\"\">Seleccionar...</option>\n            ${genderOptions}\n          </select>\n        </div>\n        <div class=\"form-group\">\n          <label>Fecha Nacimiento</label>\n          <input type=\"date\" class=\"passenger-input\" data-field=\"birthDate\" value=\"${passenger.birthDate || ''}\">\n        </div>\n        <div class=\"form-group\">\n          <label>Tipo Doc.</label>\n          <select class=\"passenger-input passenger-doctype\" data-field=\"documentType\" data-current=\"${currentDocType}\">\n            <option value=\"\">Seleccionar...</option>\n            ${docTypeOptions}\n          </select>\n        </div>\n        <div class=\"form-group\">\n          <label>Nro. Doc.</label>\n          <input type=\"text\" class=\"passenger-input\" data-field=\"documentNumber\" value=\"${passenger.documentNumber || ''}\" placeholder=\"N√∫mero\">\n        </div>\n        <div class=\"form-group\">\n          <label>CUIT-CUIL</label>\n          <input type=\"text\" class=\"passenger-input\" data-field=\"cuilCuit\" value=\"${passenger.cuilCuit || ''}\" placeholder=\"11111111\">\n        </div>\n        <div class=\"form-group full-width\">\n          <label>Direcci√≥n</label>\n          <input type=\"text\" class=\"passenger-input\" data-field=\"direccion\" value=\"${passenger.direccion || ''}\" placeholder=\"Direcci√≥n completa\">\n        </div>\n        <div class=\"form-group\">\n          <label>Nacionalidad</label>\n          <select class=\"passenger-input passenger-nationality\" data-field=\"nationality\" data-current=\"${currentNationality}\">\n            <option value=\"\">Seleccionar...</option>\n            ${nationalityOptions}\n          </select>\n        </div>\n        <!-- <div class=\"form-group\">\n          <label>Tel√©fono</label>\n          <input type=\"text\" class=\"passenger-input\" data-field=\"phoneNumber\" value=\"${passenger.phoneNumber || ''}\" placeholder=\"+54...\">\n        </div> -->\n      </div>\n    `;\n\n    passengersList.appendChild(card);\n  });\n\n  // Set selected values for selects after adding to DOM\n  document.querySelectorAll('.passenger-sex').forEach((select: any) => {\n    const current = select.getAttribute('data-current');\n    if (current) select.value = current;\n  });\n  document.querySelectorAll('.passenger-doctype').forEach((select: any) => {\n    const current = select.getAttribute('data-current');\n    if (current) select.value = current;\n  });\n  document.querySelectorAll('.passenger-nationality').forEach((select: any) => {\n    const current = select.getAttribute('data-current');\n    if (current) select.value = current;\n  });\n\n  // Add \"Add Passenger\" button if not exists\n  if (!document.getElementById('add-passenger-btn')) {\n    const addBtn = document.createElement('button');\n    addBtn.id = 'add-passenger-btn';\n    addBtn.className = 'secondary-button small-button';\n    addBtn.innerHTML = '‚ûï Agregar Pasajero';\n    addBtn.onclick = () => {\n      const currentData = getPassengersFromInputs();\n      currentData.push({ paxType: 'ADU' });\n      displayPassengers(currentData);\n    };\n    passengersList.parentNode?.appendChild(addBtn);\n  }\n\n  // Add event listeners for remove buttons\n  document.querySelectorAll('.remove-passenger').forEach(btn => {\n    btn.addEventListener('click', (e) => {\n      const idx = parseInt((e.target as HTMLElement).getAttribute('data-index') || '0');\n      const currentData = getPassengersFromInputs();\n      currentData.splice(idx, 1);\n      displayPassengers(currentData);\n    });\n  });\n}\n\n/**\n * Test RPA connection on startup\n */\nasync function testRPAConnection(): Promise<void> {\n  console.log('üîå Testing RPA connection...');\n  \n  try {\n    const result = await rpaService.testConnection();\n    \n    if (result.success) {\n      console.log('‚úÖ RPA connection test successful:', result);\n    } else {\n      console.warn('‚ö†Ô∏è RPA connection test failed:', result.message);\n    }\n  } catch (error: any) {\n    console.error('‚ùå RPA connection test error:', error);\n  }\n}\n\n/**\n * Helper to get passengers data from inputs\n */\nfunction getPassengersFromInputs(): any[] {\n  const passengers: any[] = [];\n  document.querySelectorAll('.passenger-card').forEach(card => {\n    const p: any = {};\n    card.querySelectorAll('.passenger-input').forEach((input: any) => {\n      p[input.getAttribute('data-field')] = input.value;\n    });\n    passengers.push(p);\n  });\n  return passengers;\n}\n\n\n/**\n * Display flights list with editable inputs\n */\nfunction displayFlights(flights: any[]): void {\n  const flightsList = document.getElementById('flights-list')!;\n  const flightsCount = document.getElementById('flights-count')!;\n\n  flightsCount.textContent = flights.length.toString();\n  flightsList.innerHTML = '';\n\n  if (flights.length === 0) {\n    flights.push({});\n  }\n\n  flights.forEach((flight, index) => {\n    const card = document.createElement('div');\n    card.className = 'flight-card';\n    card.setAttribute('data-index', index.toString());\n\n    card.innerHTML = `\n      <div class=\"flight-card-header\">\n        <h4>Vuelo ${index + 1}</h4>\n        <button class=\"icon-button remove-flight\" data-index=\"${index}\" title=\"Eliminar\">üóëÔ∏è</button>\n      </div>\n      <div class=\"form-grid\">\n        <div class=\"form-group\">\n          <label>Origen</label>\n          <input type=\"text\" class=\"flight-input\" data-field=\"origin\" value=\"${flight.origin || ''}\" placeholder=\"EZE\">\n        </div>\n        <div class=\"form-group\">\n          <label>Destino</label>\n          <input type=\"text\" class=\"flight-input\" data-field=\"destination\" value=\"${flight.destination || ''}\" placeholder=\"MIA\">\n        </div>\n        <div class=\"form-group\">\n          <label>Aerol√≠nea</label>\n          <input type=\"text\" class=\"flight-input\" data-field=\"airline\" value=\"${flight.airline || ''}\" placeholder=\"AA\">\n        </div>\n        <div class=\"form-group\">\n          <label>Nro. Vuelo</label>\n          <input type=\"text\" class=\"flight-input\" data-field=\"flightNumber\" value=\"${flight.flightNumber || ''}\" placeholder=\"900\">\n        </div>\n        <div class=\"form-group\">\n          <label>Fecha Salida</label>\n          <input type=\"date\" class=\"flight-input\" data-field=\"departureDate\" value=\"${flight.departureDate || ''}\">\n        </div>\n        <div class=\"form-group\">\n          <label>Hora Salida</label>\n          <input type=\"time\" class=\"flight-input\" data-field=\"departureTime\" value=\"${flight.departureTime || ''}\">\n        </div>\n        <div class=\"form-group\">\n          <label>Fecha Llegada</label>\n          <input type=\"date\" class=\"flight-input\" data-field=\"arrivalDate\" value=\"${flight.arrivalDate || ''}\">\n        </div>\n        <div class=\"form-group\">\n          <label>Hora Llegada</label>\n          <input type=\"time\" class=\"flight-input\" data-field=\"arrivalTime\" value=\"${flight.arrivalTime || ''}\">\n        </div>\n      </div>\n    `;\n\n    flightsList.appendChild(card);\n  });\n\n  // Add \"Add Flight\" button if not exists\n  if (!document.getElementById('add-flight-btn')) {\n    const addBtn = document.createElement('button');\n    addBtn.id = 'add-flight-btn';\n    addBtn.className = 'secondary-button small-button';\n    addBtn.innerHTML = '‚ûï Agregar Vuelo';\n    addBtn.onclick = () => {\n      const currentData = getFlightsFromInputs();\n      currentData.push({});\n      displayFlights(currentData);\n    };\n    flightsList.parentNode?.appendChild(addBtn);\n  }\n\n  // Add event listeners for remove buttons\n  document.querySelectorAll('.remove-flight').forEach(btn => {\n    btn.addEventListener('click', (e) => {\n      const idx = parseInt((e.target as HTMLElement).getAttribute('data-index') || '0');\n      const currentData = getFlightsFromInputs();\n      currentData.splice(idx, 1);\n      displayFlights(currentData);\n    });\n  });\n}\n\n/**\n * Helper to get flights data from inputs\n */\nfunction getFlightsFromInputs(): any[] {\n  const flights: any[] = [];\n  document.querySelectorAll('.flight-card').forEach(card => {\n    const f: any = {};\n    card.querySelectorAll('.flight-input').forEach((input: any) => {\n      f[input.getAttribute('data-field')] = input.value;\n    });\n    flights.push(f);\n  });\n  return flights;\n}\n\n\n/**\n * Display services list with editable inputs\n */\nfunction displayServices(services: any[]): void {\n  const servicesList = document.getElementById('services-list')!;\n  const servicesCount = document.getElementById('services-count')!;\n\n  servicesCount.textContent = services.length.toString();\n  servicesList.innerHTML = '';\n\n  if (services.length === 0) {\n    services.push({});\n  }\n\n  services.forEach((service, index) => {\n    const card = document.createElement('div');\n    card.className = 'service-card';\n    card.setAttribute('data-index', index.toString());\n\n    card.innerHTML = `\n      <div class=\"service-card-header\">\n        <h4>Servicio ${index + 1}</h4>\n        <button class=\"icon-button remove-service\" data-index=\"${index}\" title=\"Eliminar\">üóëÔ∏è</button>\n      </div>\n      <div class=\"form-grid\">\n        <div class=\"form-group\">\n          <label>Tipo</label>\n          <select class=\"service-input\" data-field=\"type\">\n            <option value=\"transfer\" ${service.type === 'transfer' ? 'selected' : ''}>Traslado</option>\n            <option value=\"excursion\" ${service.type === 'excursion' ? 'selected' : ''}>Excursi√≥n</option>\n            <option value=\"meal\" ${service.type === 'meal' ? 'selected' : ''}>Comida</option>\n            <option value=\"other\" ${service.type === 'other' || !service.type ? 'selected' : ''}>Otro</option>\n          </select>\n        </div>\n        <div class=\"form-group full-width\">\n          <label>Descripci√≥n</label>\n          <input type=\"text\" class=\"service-input\" data-field=\"description\" value=\"${service.description || ''}\" placeholder=\"Descripci√≥n del servicio\">\n        </div>\n        <div class=\"form-group\">\n          <label>Fecha</label>\n          <input type=\"date\" class=\"service-input\" data-field=\"date\" value=\"${service.date || ''}\">\n        </div>\n        <div class=\"form-group\">\n          <label>Ubicaci√≥n</label>\n          <input type=\"text\" class=\"service-input\" data-field=\"location\" value=\"${service.location || ''}\" placeholder=\"Lugar\">\n        </div>\n      </div>\n    `;\n\n    servicesList.appendChild(card);\n  });\n\n  // Add \"Add Service\" button if not exists\n  if (!document.getElementById('add-service-btn')) {\n    const addBtn = document.createElement('button');\n    addBtn.id = 'add-service-btn';\n    addBtn.className = 'secondary-button small-button';\n    addBtn.innerHTML = '‚ûï Agregar Servicio';\n    addBtn.onclick = () => {\n      const currentData = getServicesFromInputs();\n      currentData.push({});\n      displayServices(currentData);\n    };\n    servicesList.parentNode?.appendChild(addBtn);\n  }\n\n  // Add event listeners for remove buttons\n  document.querySelectorAll('.remove-service').forEach(btn => {\n    btn.addEventListener('click', (e) => {\n      const idx = parseInt((e.target as HTMLElement).getAttribute('data-index') || '0');\n      const currentData = getServicesFromInputs();\n      currentData.splice(idx, 1);\n      displayServices(currentData);\n    });\n  });\n}\n\n/**\n * Helper to get services data from inputs\n */\nfunction getServicesFromInputs(): any[] {\n  const services: any[] = [];\n  document.querySelectorAll('.service-card').forEach(card => {\n    const s: any = {};\n    card.querySelectorAll('.service-input').forEach((input: any) => {\n      s[input.getAttribute('data-field')] = input.value;\n    });\n    services.push(s);\n  });\n  return services;\n}\n\n\n/**\n * Handle re-analyze button click\n */\nasync function handleReanalyze(): Promise<void> {\n  console.log('üîÑ Re-analyzing email...');\n\n  // Simply call extract again\n  await handleExtractReservation();\n}\n\n/**\n * Handle confirm button click\n */\nasync function handleConfirmReservation(): Promise<void> {\n  console.log('‚úÖ Confirming reservation data...');\n\n  if (!extractionState.data) {\n    showError('No hay datos para confirmar');\n    return;\n  }\n\n  // Ensure userId is available - check localStorage if not in state\n  if (!state.userId) {\n    const cachedUserId = localStorage.getItem('email-classifier-userId');\n    const cachedEmail = localStorage.getItem('email-classifier-email');\n\n    if (cachedUserId && cachedEmail) {\n      console.log('‚ôªÔ∏è Restored userId from localStorage for confirmation');\n      state.userId = cachedUserId;\n      state.email = cachedEmail;\n      state.isRegistered = true;\n    } else {\n      showError('Usuario no autenticado');\n      return;\n    }\n  }\n\n  // Collect current values from form (in case user edited them)\n  // For searchable dropdowns, use hidden input value (code) when available\n  const getFieldValue = (inputId: string, hiddenId?: string): string | null => {\n    if (hiddenId) {\n      const hiddenInput = document.getElementById(hiddenId) as HTMLInputElement;\n      if (hiddenInput && hiddenInput.value) {\n        return hiddenInput.value;\n      }\n    }\n    const input = document.getElementById(inputId) as HTMLInputElement;\n    return input?.value || null;\n  };\n\n  // Helper to ensure field values match iTraffic format\n  // This re-validates and converts codes to full names if needed\n  const normalizeFieldValue = (\n    value: string | null,\n    dataSource: Array<{ code: string; name: string }>,\n    fieldName: string\n  ): string | null => {\n    if (!value || !dataSource || dataSource.length === 0) return value;\n\n    const searchTerm = value.toUpperCase().trim();\n\n    // If already in correct format (contains brackets for status/type), return as-is\n    if (searchTerm.includes('[') && searchTerm.includes(']')) {\n      return value;\n    }\n\n    // Try to find match\n    let match = dataSource.find(item => item.code.toUpperCase() === searchTerm);\n\n    if (!match) {\n      match = dataSource.find(item => item.name.toUpperCase() === searchTerm);\n    }\n\n    if (!match) {\n      // Check if code is inside name brackets\n      match = dataSource.find(item => {\n        const codeMatch = item.name.match(/\\[([^\\]]+)\\]$/);\n        return codeMatch && codeMatch[1].toUpperCase() === searchTerm;\n      });\n    }\n\n    if (!match) {\n      // Partial match\n      match = dataSource.find(item =>\n        item.name.toUpperCase().includes(searchTerm) ||\n        item.code.toUpperCase().includes(searchTerm)\n      );\n    }\n\n    if (match) {\n      console.log(`‚úÖ Normalized ${fieldName}: \"${value}\" -> \"${match.name}\"`);\n      return match.name;\n    }\n\n    console.warn(`‚ö†Ô∏è Could not normalize ${fieldName}: \"${value}\"`);\n    return value;\n  };\n\n  // Solo incluir campos que realmente usamos en el RPA\n  const confirmedData = {\n    // Campos usados en RPA\n    reservationType: normalizeFieldValue(\n      getFieldValue('input-reservation-type', 'input-reservation-type-value'),\n      masterData.reservationTypes,\n      'reservationType'\n    ),\n    status: normalizeFieldValue(\n      getFieldValue('input-status', 'input-status-value'),\n      masterData.statuses,\n      'status'\n    ),\n    client: normalizeFieldValue(\n      getFieldValue('input-client', 'input-client-value'),\n      masterData.clients,\n      'client'\n    ),\n    travelDate: (document.getElementById('input-travel-date') as HTMLInputElement).value || null,\n    seller: normalizeFieldValue(\n      getFieldValue('input-seller', 'input-seller-value'),\n      masterData.sellers,\n      'seller'\n    ),\n    passengers: getPassengersFromInputs()\n  };\n\n  console.log('üìã Confirmed data:', confirmedData);\n\n  // Update confirm button to show loading\n  const confirmButton = document.getElementById('confirm-button') as HTMLButtonElement;\n  const originalHTML = confirmButton.innerHTML;\n\n  confirmButton.innerHTML = '<span class=\"button-icon\">ü§ñ</span><span>Procesando RPA...</span>';\n  confirmButton.disabled = true;\n\n  try {\n    // Llamar directamente al servicio RPA para crear la reserva\n    console.log('üöÄ Calling RPA service to create reservation...');\n    const rpaResult = await rpaService.createReservation(confirmedData as ReservationData);\n\n    console.log('‚úÖ RPA Result:', rpaResult);\n\n    // Success\n    confirmButton.innerHTML = '<span class=\"button-icon\">‚úÖ</span><span>¬°Procesado!</span>';\n    confirmButton.style.background = '#107c10';\n    showSuccessMessage(`‚úÖ Reserva creada exitosamente en iTraffic: ${rpaResult.message}`);\n\n    // Reset UI after success\n    setTimeout(() => {\n      // Hide results\n      document.getElementById('extraction-results')!.style.display = 'none';\n      // Show header again\n      const header = document.getElementById('collapsible-header');\n      const btn = document.getElementById('toggle-header-btn');\n      if (header && btn) {\n        header.style.display = 'block';\n        btn.textContent = 'üîº';\n      }\n      // Clear data\n      extractionState.data = null;\n      extractionState.hasExtracted = false;\n    }, 2000);\n\n    // Reset button after 5 seconds\n    setTimeout(() => {\n      confirmButton.innerHTML = originalHTML;\n      confirmButton.disabled = false;\n      confirmButton.style.background = '';\n    }, 5000);\n\n  } catch (error: any) {\n    console.error('‚ùå Error creating reservation via RPA:', error);\n\n    // Reset button\n    confirmButton.innerHTML = originalHTML;\n    confirmButton.disabled = false;\n\n    // Mostrar error m√°s descriptivo\n    let errorMessage = 'Error al crear la reserva en iTraffic';\n    if (error.message) {\n      errorMessage += ': ' + error.message;\n    }\n    \n    showError(errorMessage);\n  }\n}\n\n/**\n * Export for testing (if needed)\n */\n(window as any).EmailClassifier = {\n  getAccessToken,\n  handleRegister,\n  checkRegistrationStatus,\n};\n"],"names":["isDevelopment","window","location","hostname","PROD_BACKEND","config","apiBaseUrl","dialogBaseUrl","environment","version","console","log","rpaService","constructor","timeout","this","baseUrl","healthCheck","response","fetchWithTimeout","method","headers","ok","Error","status","statusText","data","json","error","message","getStatus","createReservation","reservationData","rpaRequest","passengers","map","p","lastName","firstName","paxType","birthDate","formatDateForRPA","nationality","sex","documentNumber","documentType","cuilCuit","direccion","reservationType","client","travelDate","seller","body","JSON","stringify","rawText","text","result","parse","success","timestamp","Date","toISOString","parseError","substring","name","testConnection","source","details","url","options","controller","AbortController","timeoutId","setTimeout","abort","fetch","signal","clearTimeout","dateString","date","includes","parts","split","length","parseInt","isNaN","getTime","warn","month","String","getMonth","padStart","formatted","getDate","getFullYear","state","isRegistered","userId","email","isLoading","isAuthInProgress","authRetryCount","lastAuthAttempt","activeDialog","extractionState","isExtracting","hasExtracted","isEditing","masterData","sellers","clients","contacts","currencies","statuses","reservationTypes","genders","documentTypes","countries","loaded","showFieldLoader","field","show","loader","document","getElementById","classList","add","remove","hideAllFieldLoaders","enableMasterDataFields","sellerInput","clientInput","contactInput","currencyInput","statusInput","reservationTypeInput","disabled","placeholder","setupSearchableDropdownLazyNameOnly","input","dropdown","hiddenInput","items","highlightedIndex","filteredItems","renderedCount","renderDropdown","filter","loadMore","searchTerm","toLowerCase","trim","item","code","innerHTML","startIndex","endIndex","Math","min","i","div","createElement","className","dataset","value","index","toString","textContent","addEventListener","selectItem","appendChild","existingMore","querySelector","moreDiv","showDropdown","hideDropdown","updateHighlight","visibleItems","querySelectorAll","forEach","toggle","scrollIntoView","block","scrollTop","clientHeight","scrollHeight","e","key","preventDefault","contains","max","target","setupSearchableDropdownForClients","displayName","displayValue","toggleHeader","header","btn","style","display","getCurrentUserEmail","userProfile","Office","context","mailbox","emailAddress","async","checkRegistrationStatus","currentEmail","cachedUserId","localStorage","getItem","cachedEmail","removeItem","user","updateUIForRegisteredUser","handleRegister","showError","now","setLoading","currentOutlookEmail","forceConsent","dialogResult","getAccessTokenViaDialog","hasCode","authorizationCode","hasToken","token","redeemResponse","redirectUri","errorData","catch","requiresInteractiveAuth","redeemData","id","backendEmail","persistUserSession","stats","successMessage","hasRefreshToken","showSuccessMessage","completeRegistrationWithAuthorizationCode","messageData","registerResponse","accessToken","refreshToken","expiresOn","completeLegacyRegistration","handleRegisterViaDialog","userMessage","handleRegistrationError","setItem","settings","roamingSettings","set","Promise","resolve","saveAsync","AsyncResultStatus","Succeeded","handleLogout","statusBox","logoutUrl","encodeURIComponent","origin","ui","displayDialogAsync","height","width","promptBeforeOpen","dialog","close","closeActiveDialog","reject","params","URLSearchParams","queryString","dialogUrl","displayInIframe","Failed","dialogClosed","checkLocalStorageForAuth","stored","checkServerBridgeForAuth","localStorageInterval","setInterval","clearInterval","authData","addEventHandler","EventType","DialogMessageReceived","arg","DialogEventReceived","delayedAuthData","extractionSection","totalClassified","categoriesCount","updateFieldStatus","elementId","element","valToSet","normalizeText","normalize","replace","toUpperCase","tagName","dataSource","match","find","codeMatch","nameWithoutCode","candidates","normalizedName","sort","a","b","aName","bName","aContains","bContains","some","part","currencyAliases","currencyName","aliases","Object","entries","alias","select","exists","option","errorSection","background","borderColor","loading","button","showHelp","event","handleExtractReservation","emailContent","getAsync","CoercionType","Text","bodyContent","subject","fullContent","from","getEmailConversationContent","conversationId","confidenceBadge","confidenceText","confidencePercent","round","confidence","displayPassengers","today","checkIn","displayExtractionResults","passengersList","push","genderOptions","g","join","docTypeOptions","dt","nationalityOptions","c","passenger","card","setAttribute","currentSex","currentDocType","currentNationality","phoneNumber","current","getAttribute","addBtn","onclick","currentData","getPassengersFromInputs","parentNode","idx","splice","handleReanalyze","handleConfirmReservation","getFieldValue","inputId","hiddenId","normalizeFieldValue","fieldName","confirmedData","confirmButton","originalHTML","rpaResult","errorMessage","onReady","info","host","HostType","Outlook","displayField","slice","setupSearchableDropdown","populateSellerDropdown","populateClientDatalist","populateContactDropdown","reverseAliases","mainName","aliasList","searchTermUpper","resolvedTerm","nameMatch","aliasMatch","setupSearchableDropdownWithAliases","dolares","populateCurrencyDropdown","confirmacion","s","populateStatusDropdown","populateReservationTypeDropdown","loadMasterData","testRPAConnection","initializeApp","EmailClassifier","getAccessToken","allowPrompt","allowSignInPrompt","allowConsentPrompt","forMSGraphAccess","auth"],"ignoreList":[],"sourceRoot":""}