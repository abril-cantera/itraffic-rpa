const AUTH_CONFIG={clientId:"6637590b-a6a4-4e53-b429-a766c66f03c3",authority:"https://login.microsoftonline.com/organizations",scopes:["openid","profile","email","offline_access","https://graph.microsoft.com/User.Read","https://graph.microsoft.com/Mail.Read","https://graph.microsoft.com/Mail.ReadWrite"]};function startAuthorizationFlow({isSilent:e,loginHint:o,redirectUri:t,forceConsent:n}){const i=generateRandomString();sessionStorage.setItem("auth_state",i);let r=e?"none":"select_account";const a=new URLSearchParams({client_id:AUTH_CONFIG.clientId,response_type:"code",redirect_uri:t,response_mode:"query",scope:AUTH_CONFIG.scopes.join(" "),prompt:r,state:i});o&&a.set("login_hint",o);const c=`${AUTH_CONFIG.authority}/oauth2/v2.0/authorize?${a.toString()}`;console.log("üåê Redirecting to Azure AD:",c),window.location.replace(c)}function reportError(e){const o={status:"error",error:e||"Authentication failed"};"undefined"!=typeof Office&&Office.context&&Office.context.ui&&Office.context.ui.messageParent?Office.context.ui.messageParent(JSON.stringify(o)):(console.error("‚ùå Error to report:",e),window.opener&&(window.opener.postMessage(o,"*"),window.close()))}function getRedirectUri(){const e=new URL(window.location.href);return e.search="",e.hash="",e.toString()}function generateRandomString(e=32){let o="";const t=new Uint32Array(e);window.crypto.getRandomValues(t);for(let n=0;n<e;n++)o+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"[t[n]%62];return o}function showSuccessMessage(){document.body.innerHTML='\n        <div style="font-family: \'Segoe UI\', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">\n            <div style="text-align: center; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 400px;">\n                <h2 style="color: #28a745; margin-bottom: 20px;">‚úÖ Autenticaci√≥n exitosa</h2>\n                <p style="color: #666; margin-bottom: 15px;">La autenticaci√≥n se complet√≥ correctamente.</p>\n                <p style="color: #333; font-weight: bold;">Cierra esta pesta√±a y vuelve a Outlook.</p>\n                <p style="color: #999; font-size: 12px; margin-top: 20px;">\n                    En el add-in, haz clic en "Try Again" para completar el registro.\n                </p>\n                <button onclick="window.close()" style="margin-top: 20px; padding: 10px 30px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">\n                    Cerrar esta ventana\n                </button>\n            </div>\n        </div>\n    '}!function(){const e=new URLSearchParams(window.location.search),o=e.get("code");if(o){console.log("üîç Auth code detected in URL (immediate check)");const t=window.location.origin+window.location.pathname,n=e.get("state");try{const e={status:"code",authorizationCode:o,redirectUri:t,state:n,timestamp:Date.now()};localStorage.setItem("office_auth_pending",JSON.stringify(e)),console.log("‚úÖ Auth code pre-stored in localStorage")}catch(e){console.error("‚ùå Failed to pre-store auth code:",e)}fetch(t.replace("/login.html","")+"/auth/bridge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:o,redirectUri:t,state:n,email:"pending"})}).then(e=>{console.log("‚úÖ Auth code stored in server bridge")}).catch(e=>{console.error("‚ö†Ô∏è Failed to store in server bridge:",e)})}}(),Office.onReady(e=>{console.log("‚úÖ Office.onReady called",e);const o=new URLSearchParams(window.location.search),t="true"===o.get("silent"),n=o.get("loginHint"),i=getRedirectUri(),r="true"===o.get("forceConsent"),a=o.get("state"),c=sessionStorage.getItem("auth_state"),s=o.get("error"),l=o.get("error_description"),d=o.get("code");if(console.log("üîê Login dialog initialized [VERSION-2024-12-01]"),console.log("üìç Redirect URI:",i),console.log("üîá Silent mode:",t),console.log("üôè Force consent:",r),n&&console.log("üìß Login hint:",n),s)return console.error("‚ùå Authorization error:",s,l),void reportError(l||s);if(d){console.log("‚úÖ Authorization code received"),c&&a&&c!==a&&console.warn("‚ö†Ô∏è State mismatch. Expected:",c,"Received:",a),sessionStorage.removeItem("auth_state"),window.history&&"function"==typeof window.history.replaceState&&window.history.replaceState({},document.title,i);const e={status:"code",authorizationCode:d,redirectUri:i,state:a};let o=!1;if("undefined"!=typeof Office&&Office.context&&Office.context.ui&&Office.context.ui.messageParent)try{Office.context.ui.messageParent(JSON.stringify(e)),console.log("‚úÖ Message sent via Office.context.ui.messageParent"),o=!0}catch(e){console.error("‚ùå Office.context.ui.messageParent failed:",e)}if(!o){console.log("‚ö†Ô∏è Office.context.ui.messageParent not available - using fallback"),console.log("üì¶ Storing auth code in localStorage as fallback...");try{localStorage.setItem("office_auth_pending",JSON.stringify({...e,timestamp:Date.now()})),console.log("‚úÖ Auth code stored in localStorage")}catch(e){console.error("‚ùå Failed to store auth code:",e)}if(showSuccessMessage(),window.opener)try{window.opener.postMessage(e,"*"),console.log("üì§ Message sent via window.opener.postMessage")}catch(e){console.error("‚ùå window.opener.postMessage failed:",e)}}return}console.log("‚ÑπÔ∏è No authorization code present, initiating login redirect"),startAuthorizationFlow({isSilent:t,loginHint:n,redirectUri:i,forceConsent:r})});